<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PostgreSQL</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">PostgreSQL</h1><br/>Some interesting flags (to see all, use <code>-h</code> or <code>--help</code> depending on your psql version):<br />• <code>-E</code>: will describe the underlaying queries of the <code>\</code> commands (cool for learning!)<br />• <code>-l</code>: psql will list all databases and then exit (useful if the user you connect with doesn't has a default database, like at AWS RDS)<br />Most <code>\d</code> commands support additional param of <code>__schema__.name__</code> and accept wildcards like <code>*.*</code><br />• <code>\q</code>: Quit/Exit<br />• <code>\c __database__</code>: Connect to a database<br />• <code>\d __table__</code>: Show table definition (columns, etc.) including triggers<br />• <code>\d+ __table__</code>: More detailed table definition including description and physical disk size<br />• <code>\l</code>: List databases<br />• <code>\dy</code>: List events<br />• <code>\df</code>: List functions<br />• <code>\di</code>: List indexes<br />• <code>\dn</code>: List schemas<br />• <code>\dt *.*</code>: List tables from all schemas (if <code>*.*</code> is omitted will only show SEARCH_PATH ones)<br />• <code>\dT+</code>: List all data types<br />• <code>\dv</code>: List views<br />• <code>\dx</code>: List all extensions installed<br />• <code>\df+ __function__</code> : Show function SQL code.<br />• <code>\x</code>: Pretty-format query results instead of the not-so-useful ASCII tables<br />• <code>\copy (SELECT * FROM __table_name__) TO 'file_path_and_name.csv' WITH CSV</code>: Export a table as CSV<br />• <code>\des+</code>: List all foreign servers<br />• <code>\dE[S+]</code>: List all foreign tables<br />User Related:<br />• <code>\du</code>: List users<br />• <code>\du __username__</code>: List a username if present.<br />• <code>create role __test1__</code>: Create a role with an existing username.<br />• <code>create role __test2__ noinherit login password __passsword__;</code>: Create a role with username and password.<br />• <code>set role __test__;</code>: Change role for current session to <code>__test__</code>.<br />• <code>grant __test2__ to __test1__;</code>: Allow <code>__test1__</code> to set its role as <code>__test2__</code>.<br />• <code>\deu+</code>: List all user mapping on server<br /><br /><br /><br /><h2>Configuration</h2><br />• Service management commands:<br /><code>sudo service postgresql stop<br />sudo service postgresql start<br />sudo service postgresql restart<br /></code>• Changing verbosity &amp; querying Postgres log:<br />1) First edit the config file, set a decent verbosity, save and restart postgres:<br /><code>sudo vim /etc/postgresql/9.3/main/postgresql.conf<br /><br /># Uncomment/Change inside:<br />log_min_messages = debug5<br />log_min_error_statement = debug5<br />log_min_duration_statement = -1<br /><br />sudo service postgresql restart<br /></code>1. Now you will get tons of details of every statement, error, and even background tasks like VACUUMs<br /><code>tail -f /var/log/postgresql/postgresql-9.3-main.log<br /></code>1. How to add user who executed a PG statement to log (editing <code>postgresql.conf</code>):<br /><code>log_line_prefix = '%t %u %d %a '<br /></code><br /><br /><br /><h2>Create command</h2><br />There are many <code>CREATE</code> choices, like <code>CREATE DATABASE __database_name__</code>, <code>CREATE TABLE __table_name__</code> ... Parameters differ but can be checked <a href="https://www.postgresql.org/search/?u=%2Fdocs%2F9.1%2F&q=CREATE">at the official documentation</a>.<br /><br /><br /><br /><h2>Handy queries</h2><br />• <code>SELECT * FROM pg_proc WHERE proname='__procedurename__'</code>: List procedure/function<br />• <code>SELECT * FROM pg_views WHERE viewname='__viewname__';</code>: List view (including the definition)<br />• <code>SELECT pg_size_pretty(pg_total_relation_size('__table_name__'));</code>: Show DB table space in use<br />• <code>SELECT pg_size_pretty(pg_database_size('__database_name__'));</code>: Show DB space in use<br />• <code>show statement_timeout;</code>: Show current user's statement timeout<br />• <code>SELECT * FROM pg_indexes WHERE tablename='__table_name__' AND schemaname='__schema_name__';</code>: Show table indexes<br />• Get all indexes from all tables of a schema:<br />SELECT<br />   t.relname AS table_name,<br />   i.relname AS index_name,<br />   a.attname AS column_name<br />FROM<br />   pg_class t,<br />   pg_class i,<br />   pg_index ix,<br />   pg_attribute a,<br />    pg_namespace n<br />WHERE<br />   t.oid = ix.indrelid<br />   AND i.oid = ix.indexrelid<br />   AND a.attrelid = t.oid<br />   AND a.attnum = ANY(ix.indkey)<br />   AND t.relnamespace = n.oid<br />    AND n.nspname = 'kartones'<br />ORDER BY<br />   t.relname,<br />   i.relname• Execution data:• Queries being executed at a certain DB:<br /><br />SELECT datname, application_name, pid, backend_start, query_start, state_change, state, query <br />  FROM pg_stat_activity <br />  WHERE datname='__database_name__';• Get all queries from all dbs waiting for data (might be hung):<br />SELECT * FROM pg_stat_activity WHERE waiting='t'• Currently running queries with process pid:<br />SELECT pg_stat_get_backend_pid(s.backendid) AS procpid, <br />  pg_stat_get_backend_activity(s.backendid) AS current_query<br />FROM (SELECT pg_stat_get_backend_idset() AS backendid) AS s;Casting:<br />• <code>CAST (column AS type)</code> or <code>column::type</code><br />• <code>'__table_name__'::regclass::oid</code>: Get oid having a table name<br />Query analysis:<br />• <code>EXPLAIN __query__</code>: see the query plan for the given query<br />• <code>EXPLAIN ANALYZE __query__</code>: see and execute the query plan for the given query<br />• <code>ANALYZE [__table__]</code>: collect statistics<br />Generating random data (<a href="https://www.citusdata.com/blog/2019/07/17/postgres-tips-for-average-and-power-user/">source</a>):<br />• <code>INSERT INTO some_table (a_float_value) SELECT random() * 100000 FROM generate_series(1, 1000000) i;</code><br /><br /><br /><br /><h2>Keyboard shortcuts</h2><br />• <code>CTRL</code> + <code>R</code>: reverse-i-search<br /><br /><br /><br /><h2>Tools</h2><br />• <code>ptop</code> and <code>pg_top</code>: <code>top</code> for PG. Available on the APT repository from <code>apt.postgresql.org</code>.<br />• <a href="https://github.com/julmon/pg_activity">pg_activity</a>: Command line tool for PostgreSQL server activity monitoring.<br />• <a href="https://dba.stackexchange.com/questions/63453/is-there-a-psql-equivalent-of-bashs-reverse-search-history">Unix-like reverse search in psql</a>:<br />$ echo "bind "^R" em-inc-search-prev" &gt; $HOME/.editrc<br />$ source $HOME/.editrc• <a href="https://pgexercises.com/">PostgreSQL Exercises</a>: An awesome resource to learn to learn SQL, teaching you with simple examples in a great visual way. Highly recommended.<br />• <a href="https://severalnines.com/blog/performance-cheat-sheet-postgresql">A Performance Cheat Sheet for PostgreSQL</a>: Great explanations of <code>EXPLAIN</code>, <code>EXPLAIN ANALYZE</code>, <code>VACUUM</code>, configuration parameters and more. Quite interesting if you need to tune-up a postgres setup.<br />• <code>psql -c "\l+" -H -q postgres &gt; out.html</code>: Generate a html report of your databases (source: <a href="https://twitter.com/westermanndanie/status/1242117182982586372">Daniel Westermann</a>)<br /></div></body></html>