<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>4.8.11 IMAP/SMTP Injection  (OTG-INPVAL-011)  </title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">4.8.11 IMAP/SMTP Injection  (OTG-INPVAL-011)  </h1><br/><br /><h2>Summary</h2><br />This threat affects all applications that communicate with mail  servers (IMAP/SMTP), generally webmail applications. The aim of this  test is to verify the capacity to inject arbitrary IMAP/SMTP commands  into the mail servers, due to input data not being properly sanitized. <br /><br /> The IMAP/SMTP Injection technique is more effective if the mail server  is not directly accessible from Internet. Where full communication with  the backend mail server is possible, it is recommended to conduct direct  testing. <br /><br /> An IMAP/SMTP Injection makes it possible to access a mail server which  otherwise would not be directly accessible from the Internet. In some  cases, these internal systems do not have the same level of  infrastructure security and hardening that is applied to the front-end  web servers. Therefore, mail server results may be more vulnerable to  attacks by end users (see the scheme presented in Figure 1). <br /><img src="images/50-1.png" alt="images/50-1.png" /><br />Figure 1 - Communication with the mail servers using the IMAP/SMTP Injection technique.<br /><br /> Figure 1 depicts the flow of traffic generally seen when using webmail  technologies. Step 1 and 2 is the user interacting with the webmail  client, whereas step 2 is the tester bypassing the webmail client and  interacting with the back-end mail servers directly.  <br /><br /> This technique allows a wide variety of actions and attacks. The  possibilities depend on the type and scope of injection and the mail  server technology being tested.  <br /><br /> Some examples of attacks using the IMAP/SMTP Injection technique are: <br />•  Exploitation of vulnerabilities in the IMAP/SMTP protocol<br />•  Application restrictions evasion<br />•  Anti-automation process evasion<br />•  Information leaks<br />•  Relay/SPAM<br /><br /> <br /><br /><h2>How to Test</h2><br />The standard attack patterns are: <br />•  Identifying vulnerable parameters<br />•  Understanding the data flow and deployment structure of the client<br />•  IMAP/SMTP command injection<br /><br /> <br /><br /><h3>Identifying vulnerable parameters</h3><br />In order to detect vulnerable parameters, the tester has to analyze  the application's ability in handling input. Input validation testing  requires the tester to send bogus, or malicious, requests to the server  and analyse the response. In a secure application, the response should  be an error with some corresponding action telling the client that  something has gone wrong. In a vulnerable application, the malicious  request may be processed by the back-end application that will answer  with a "HTTP 200 OK" response message. <br /><br /> It is important to note that the requests being sent should match the  technology being tested. Sending SQL injection strings for Microsoft SQL  server when a MySQL server is being used will result in false positive  responses. In this case, sending malicious IMAP commands is modus  operandi since IMAP is the underlying protocol being tested.    <br /><br /> IMAP special parameters that should be used are: <br /><table class="table"><col/><col/><tr><th>click me</th><th>click me</th></tr><tr><td> On the IMAP server </td><td> On the SMTP server</td></tr><tr><td> Authentication </td><td> Emissor e-mail</td></tr><tr><td> operations with mail boxes (list, read, create, delete, rename) </td><td> Destination e-mail</td></tr><tr><td> operations with messages (read, copy, move, delete) </td><td> Subject</td></tr><tr><td> Disconnection </td><td> Message body</td></tr><tr><td>  </td><td> Attached files</td></tr></table><br /><br />  In this example, the "mailbox" parameter is being tested by manipulating all requests with the parameter in: <br />http://&lt;webmail&gt;/src/read_body.php?mailbox=INBOX&amp;passed_id=46106&amp;startMessage=1<br /><br /> The following examples can be used. <br />•  Assign a null value to the parameter:<br /><br />http://&lt;webmail&gt;/src/read_body.php?mailbox=&amp;passed_id=46106&amp;startMessage=1<br />•  Substitute the value with a random value:<br /><br />http://&lt;webmail&gt;/src/read_body.php?mailbox=NOTEXIST&amp;passed_id=46106&amp;startMessage=1<br />•  Add other values to the parameter:<br /><br />http://&lt;webmail&gt;/src/read_body.php?mailbox=INBOX PARAMETER2&amp;passed_id=46106&amp;startMessage=1<br />•  Add non standard special characters (i.e.: \, ', ", @, #, !, |):<br /><br />http://&lt;webmail&gt;/src/read_body.php?mailbox=INBOX"&amp;passed_id=46106&amp;startMessage=1<br />•  Eliminate the parameter:<br /><br />http://&lt;webmail&gt;/src/read_body.php?passed_id=46106&amp;startMessage=1<br /><br /> The final result of the above testing gives the tester three possible situations: <br /> S1 - The application returns a error code/message <br /> S2 - The application does not return an error code/message, but it does not realize the requested operation <br /> S3 - The application does not return an error code/message and realizes the operation requested normally <br /> <br /><br /> Situations S1 and S2 represent successful IMAP/SMTP injection. <br />An attacker's aim is receiving the S1 response, as it is an  indicator that the application is vulnerable to injection and further  manipulation. <br />Let's suppose that a user retrieves the email headers using the following HTTP request: <br />http://&lt;webmail&gt;/src/view_header.php?mailbox=INBOX&amp;passed_id=46105&amp;passed_ent_id=0<br /><br /> An attacker might modify the value of the parameter INBOX by injecting the character " (%22 using URL encoding): <br />http://&lt;webmail&gt;/src/view_header.php?mailbox=INBOX%22&amp;passed_id=46105&amp;passed_ent_id=0<br /><br /> In this case, the application answer may be: <br />ERROR: Bad or malformed request.<br />Query: SELECT "INBOX""<br />Server responded: Unexpected extra arguments to Select<br /><br /> The situation S2 is harder to test successfully. The tester needs to use  blind command injection in order to determine if the server is  vulnerable. <br /><br /> On the other hand, the last situation (S3) is not revelant in this paragraph. <br /><br /> <strong>Result Expected:</strong><br /> <br />•  List of vulnerable parameters <br />•  Affected functionality <br />•  Type of possible injection (IMAP/SMTP) <br /><br /> <br /><br /><h3>Understanding the data flow and deployment structure of the client</h3><br />After identifying all vulnerable parameters (for example,  "passed_id"), the tester needs to determine what level of injection is  possible and then design a testing plan to further exploit the  application. <br /><br /> In this test case, we have detected that the application's "passed_id"  parameter is vulnerable and is used in the following request: <br />http://&lt;webmail&gt;/src/read_body.php?mailbox=INBOX&amp;passed_id=46225&amp;startMessage=1<br /><br /> Using the following test case (providing an alphabetical value when a numerical value is required): <br />http://&lt;webmail&gt;/src/read_body.php?mailbox=INBOX&amp;passed_id=test&amp;startMessage=1<br />will generate the following error message: <br />ERROR : Bad or malformed request.<br />Query: FETCH test:test BODY[HEADER]<br />Server responded: Error in IMAP command received by server.<br /><br /> In this example, the error message returned the name of the executed command and the corresponding parameters. <br /><br /> In other situations, the error message ("not controlled" by the  application) contains the name of the executed command, but reading the  suitable RFC (see "Reference" paragraph) allows the tester to understand  what other possible commands can be executed. <br /><br /> If the application does not return descriptive error messages, the  tester needs to analyze the affected functionality to deduce all the  possible commands (and parameters) associated with the above mentioned  functionality. For example, if a vulnerable parameter has been detected  in the create  mailbox functionality, it is logical to assume that the  affected IMAP command is "CREATE". According to the RFC, the CREATE  command accepts one parameter which specifies the name of the mailbox to  create. <br /><br /> <strong>Result Expected:</strong><br /> <br />•  List of IMAP/SMTP commands affected <br />•  Type, value, and number of parameters expected by the affected IMAP/SMTP commands<br /><br /> <br /><br /><h3>IMAP/SMTP command injection</h3><br />Once the tester has identified vulnerable parameters and has analyzed  the context in which they are executed, the next stage is exploiting  the functionality. <br /><br /> This stage has two possible outcomes:<br /> 1. The injection is possible in an unauthenticated state: the affected  functionality does not require the user to be authenticated. The  injected (IMAP) commands available are limited to: CAPABILITY, NOOP,  AUTHENTICATE, LOGIN, and LOGOUT.<br />  2. The injection is only possible in an authenticated state: the  successful exploitation requires the user to be fully authenticated  before testing can continue. <br /><br /> In any case, the typical structure of an IMAP/SMTP Injection is as follows: <br />•  Header: ending of the expected command;<br />•  Body: injection of the new command;<br />•  Footer: beginning of the expected command.<br /><br /> It is important to remember that, in order to execute an IMAP/SMTP  command, the previous command must be terminated with the CRLF (%0d%0a)  sequence.  <br /><br /> Let's suppose that in the stage 1 ("Identifying vulnerable parameters"),  the attacker detects that the parameter "message_id" in the following  request is vulnerable: <br />http://&lt;webmail&gt;/read_email.php?message_id=4791<br /><br /> Let's suppose also that the outcome of the analysis performed in the  stage 2 ("Understanding the data flow and deployment structure of the  client") has identified the command and arguments associated with this  parameter as: <br />FETCH 4791 BODY[HEADER]<br /><br /> In this scenario, the IMAP injection structure would be: <br />http://&lt;webmail&gt;/read_email.php?message_id=4791 BODY[HEADER]%0d%0aV100 CAPABILITY%0d%0aV101 FETCH 4791<br /><br /> Which would generate the following commands: <br />???? FETCH 4791 BODY[HEADER]<br />V100 CAPABILITY<br />V101 FETCH 4791 BODY[HEADER]<br />where: <br />Header = 4791 BODY[HEADER]<br />Body   = %0d%0aV100 CAPABILITY%0d%0a<br />Footer = V101 FETCH 4791 <br /><br /> <br /><strong>Result Expected:</strong><br /> <br />•  Arbitrary IMAP/SMTP command injection<br /><br /> <br /><br /><h2>References</h2><br /><strong>Whitepapers</strong><br /> <br />•  <a href="https://tools.ietf.org/html/rfc0821">RFC 0821</a> “Simple Mail Transfer Protocol”.<br />•  <a href="https://tools.ietf.org/html/rfc3501">RFC 3501</a> “Internet Message Access Protocol - Version 4rev1”.<br />•  Vicente Aguilera Díaz: “MX Injection: Capturing and Exploiting Hidden Mail Servers" - <a href="http://www.webappsec.org/projects/articles/121106.pdf">http://www.webappsec.org/projects/articles/121106.pdf</a><br /></div></body></html>