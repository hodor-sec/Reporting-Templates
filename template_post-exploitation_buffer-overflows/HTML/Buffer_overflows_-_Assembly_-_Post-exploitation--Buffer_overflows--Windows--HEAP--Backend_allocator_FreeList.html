<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Backend allocator FreeList</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">Backend allocator FreeList</h1><br/><strong><h2>The back-end allocator - Freelist</h2></strong><br /><br />At offset 0x178 of the heap structure, we can see the start of the  FreeList[] array. The FreeList contains a doubly linked list of chunks.  They are doubly linked due to containing both flink and blink.<br />  <br />  <img src="images/597-1.png" alt="images/597-1.png" /><br />    <br />  <br />The above diagram shows that the freelist contains an indexed array  of heap chunks ranging from 0-128. Any chunk sizes between 0 and 1016  (its 1016 because the maximum size is 1024 - 8 bytes of metadata) are  stored according to their allocated unit size * 8. For example, say that  I have a chunk of 40 bytes to free, then I would place the chunk at  index 4 of the freelist (40/8).<br /><br /> If a chunk size was above 1016 ( 127 * 8 ) bytes, then it would be  stored in the freelist[0] entry in numerical size ordering. Below is a  description of the freelist chunk.<br /><br /><table class="table"><col/><col/><col/><col/><col/><col/><col/><tr><th>click me</th><th>click me</th><th>click me</th><th>click me</th><th>click me</th><th>click me</th><th>click me</th></tr><tr><td>Headers</td><td>Self Size (0x2)</td><td>Prev Size (0x2)</td><td>Segment index (0x1)</td><td>Flag (0x1)</td><td>Unused (0x1)</td><td>Tag index (0x1)</td></tr><tr><td>flink/blink</td><td>Flink (0x4)</td><td>Blink (0x4)</td><td></td><td></td><td></td><td></td></tr><tr><td>Data</td><td></td><td></td><td></td><td></td><td></td><td></td></tr></table><br /><br />Microsoft released some mitigations to prevent attacks on unlinking  of the freelist entry, below is a short description of the mitigations.<br /><br /><strong> Safe unlinking of the freelist:</strong><br /> Safe unlinking is a protection mechanism implemented by Microsoft in  Windows XP Sp2 and above. Essentialy it is an exploitation mitigation  that attempts to prevent the generic write 4 technique as discussed in  Heap Overflows for Humans 101. In this check, the previous chunks  'flink' points to our allocated chunk and the adjacent chunks blink  points to our allocated chunk. Below is a description and diagram of the  security mechanism in place.<br /> <br /> <img src="images/597-2.png" alt="images/597-2.png" /><br /> <br /><br />Freelist chunk 1[flink] == Freelist chunk 2 &amp;&amp; Freelist chunk 3[blink] ==Freelist chunk 2<br /> <br /></div></body></html>