<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>VirtualProtect()</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">VirtualProtect()</h1><br/><table class="table"><col/><col/><tr><th>click me</th><th>click me</th></tr><tr><td>Return address</td><td>pointer to the location where VirtualProtect() needs to return to. This will be the address of your shellcode on the stack (dynamically created value)</td></tr><tr><td>lpAddress</td><td>pointer to the base address of the region of pages whose access protection attributes need to be changed. In essence, this will be the base address of your shellcode on the stack (dynamically created value)</td></tr><tr><td>dwsize</td><td>number of bytes (dynamically created value, making sure the entire shellcode can get executed. If the shellcode will expand for some reason (because of decoding for example), then those additional bytes will need to be taken into account and accounted for.</td></tr><tr><td>flNewProtect</td><td>option that specifies the new protection option : 0x00000040 : PAGE_EXECUTE_READWRITE. If your shellcode will not modify itself (decoder for example), then a value of 0x00000020 (PAGE_EXECUTE_READ) might work as well</td></tr><tr><td>lpflOldProtect</td><td>pointer to variable that will receive the previous access protection value</td></tr></table><br /><br /><strong>Registers:</strong><br />BOOL WINAPI VirtualProtect(                ----&gt; ESI<br />  __in   LPVOID lpAddress,                    ----&gt; ESP<br />  __in   SIZE_T dwSize,                         --â†’  EBX<br />  __in   DWORD flNewProtect,                ----&gt; EDX<br />  __out  PDWORD lpflOldProtect             ----&gt; ECX<br />);<br /><br /><strong>Structure:                                 Parameters:</strong><br />BOOL WINAPI VirtualProtect(          =&gt;    A pointer to VirtualProtect() <strong>ESI</strong><br />  _In_   LPVOID lpAddress,           =&gt;    Return Address (Redirect Execution to ESP) <strong>ESP</strong><br />  _In_   SIZE_T dwSize,              =&gt;    dwSize up to you to chose as needed (0x201) <strong>EBX</strong><br />  _In_   DWORD flNewProtect,         =&gt;    flNewProtect (0x40) <strong>EDX</strong><br />  _Out_  PDWORD lpflOldProtect       =&gt;    A writable pointer <strong>ECX</strong><br />);<br /><br /><strong>PUSHAD call:</strong><br />EDI - Ptr to RETN<br />ESI - VirtualProtect()<br />EBP - RET pointer<br />ESP - lpAddress<br />EBX - dwSize<br />EDX - lpNewProtect<br />ECX - lpflOldProtect<br />EAX - NOPS<br /><br /><strong>Reference:</strong><br /><a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa366898(v=vs.85).aspx">http://msdn.microsoft.com/en-us/library/windows/desktop/aa366898(v=vs.85).aspx</a></div></body></html>