<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>PEB</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">PEB</h1><br/><strong>Process Environment Block</strong><br /><br />In computing the Process Environment Block (abbreviated PEB) is a data structure in the Windows NT operating system family. It is an opaque data structure that is used by the operating system internally, most of whose fields are not intended for use by anything other than the operating system.[1] Microsoft notes, in its MSDN Library documentation — which documents only a few of the fields — that the structure "may be altered in future versions of Windows".[2] The PEB contains data structures that apply across a whole process, including global context, startup parameters, data structures for the program image loader, the program image base address, and synchronization objects used to provide mutual exclusion for process-wide data structures.[1]<br /><br />The PEB is closely associated with the kernel mode EPROCESS data structure, as well as with per-process data structures managed within the address space of the Client-Server Runtime Sub-System process. However, (like the CSRSS data structures) the PEB is not a kernel mode data structure itself. It resides in the application mode address space of the process that it relates to. This is because it is designed to be used by the application-mode code in the operating system libraries, such as NTDLL, that executes outside of kernel mode, such as the code for the program image loader and the heap manager.[3]<br /><br />In WinDbg, the command that dumps the contents of a PEB is the !peb command, which is passed the address of the PEB within a process' application address space. That information, in turn, is obtained by the !process command, which displays the information from the EPROCESS data structure, one of whose fields is the address of the PEB.[3]<br /><br /><table class="table"><col/><col/><col/><tr><th>Field</th><th>meaning</th><th>notes</th></tr><tr><td>BeingDebugged</td><td>Whether the process is being debugged</td><td>Microsoft recommends not using this field but using the official Win32 CheckRemoteDebuggerPresent() library function instead.[2]</td></tr><tr><td>Ldr</td><td>A pointer to a PEB_LDR_DATA structure providing information about loaded modules</td><td>Contains the base address of kernel32 and ntdll.</td></tr><tr><td>ProcessParameters</td><td>A pointer to a RTL_USER_PROCESS_PARAMETERS structure providing information about process startup parameters</td><td>The RTL_USER_PROCESS_PARAMETERS structure is also mostly opaque and not guaranteed to be consistent across multiple versions of Windows.[4]</td></tr><tr><td>PostProcessInitRoutine</td><td>A pointer to a callback function called after DLL initialization but before the main executable code is invoked</td><td>This callback function is used on Windows 2000, but is not guaranteed to be used on later versions of Windows NT.[2]</td></tr><tr><td>SessionId</td><td>The session ID of the Terminal Services session that the process is part of</td><td>The NtCreateUserProcess() system call initializes this by calling the kernel's internal MmGetSessionId() function.[3]</td></tr></table><br /><br /><br />The contents of the PEB are initialized by the NtCreateUserProcess() system call, the Native API function that implements part of, and underpins, the Win32 CreateProcess(), CreateProcessAsUser(), CreateProcessWithTokenW(), and CreateProcessWithLogonW() library functions that are in the kernel32.dll and advapi32.dll libraries as well as underpinning the fork() function in the Windows NT POSIX library, posix.dll.[3]<br /><br />For Windows NT POSIX processes, the contents of a new process' PEB are initialized by NtCreateUserProcess() as simply a direct copy of the parent process' PEB, in line with how the fork() function operates. For Win32 processes, the initial contents of a new process' PEB are mainly taken from global variables maintained within the kernel. However, several fields may instead be taken from information provided within the process' image file, in particular information provided in the IMAGE_OPTIONAL_HEADER32 data structure within the PE file format (PE+ or PE32+ in 64 bit executable images).[3]<br /><br /><table class="table"><col/><col/><col/><tr><th>Field</th><th>is initialized from</th><th>overridable by PE information?</th></tr><tr><td>NumberOfProcessors</td><td>KeNumberOfProcessors</td><td>No</td></tr><tr><td>NtGlobalFlag</td><td>NtGlobalFlag</td><td>No</td></tr><tr><td>CriticalSectionTimeout</td><td>MmCriticalSectionTimeout</td><td>No</td></tr><tr><td>HeapSegmentReserve</td><td>MmHeapSegmentReserve</td><td>No</td></tr><tr><td>HeapSegmentCommit</td><td>MmHeapSegmentCommit</td><td>No</td></tr><tr><td>HeapDeCommitTotalFreeThreshold</td><td>MmHeapDeCommitTotalFreeThreshold</td><td>No</td></tr><tr><td>HeapDeCommitFreeBlockThreshold</td><td>MmHeapDeCommitFreeBlockThreshold</td><td>No</td></tr><tr><td>MinimumStackCommit</td><td>MmMinimumStackCommitInBytes</td><td>No</td></tr><tr><td>ImageProcessAffinityMask</td><td>KeActiveProcessors</td><td>ImageLoadConfigDirectory.ProcessAffinityMask</td></tr><tr><td>OSMajorVersion</td><td>NtMajorVersion</td><td>OptionalHeader.Win32VersionValue &amp; 0xFF</td></tr><tr><td>OSMinorVersion</td><td>NtMinorVersion</td><td>(OptionalHeader.Win32VersionValue &gt;&gt; 8) &amp; 0xFF</td></tr><tr><td>OSBuildNumber</td><td>NtBuildNumber &amp; 0x3FFF combined with CmNtCSDVersion</td><td>(OptionalHeader.Win32VersionValue &gt;&gt; 16) &amp; 0x3FFF combined with ImageLoadConfigDirectory.CmNtCSDVersion</td></tr><tr><td>OSPlatformId</td><td>VER_PLATFORM_WIN32_NT</td><td>(OptionalHeader.Win32VersionValue &gt;&gt; 30) ^ 0x2</td></tr></table><br /></div></body></html>